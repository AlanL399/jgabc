<<<<<<< Updated upstream
function encode_utf8(e){return utf8_bom+unescape(encodeURIComponent(e))}function decode_utf8(e){return decodeURIComponent(escape(e))}function Header(e){"string"!=typeof e&&(e=""),this.comments=[],this.cValues={},this.original="";var t=e.match(regexHeaderEnd);if(t){var n=this.original=e.slice(0,t.index+t[0].length),a=n.split(/\r?\n/g);for(i in a){var r=a[i],t=regexHeaderLine.exec(r);if(t)if(this[t[1]]){var s=t[1]+"Array";this[s]||(this[s]=[this[t[1]]]),this[s].push(t[2])}else this[t[1]]=t[2];else(t=regexHeaderComment.exec(r))&&"%%"!=r&&(t=regexHeaderLine.exec(r.slice(1)),t?this.cValues[t[1]]=t[2]:this.comments[i]=r)}}}function getHeaderLen(e){var t=e.match(regexHeaderEnd);return t?t.index+t[0].length:0}function getHeader(e){return new Header(e)}function updateLinks(e){var t=getHeader(e);t?e=e.slice(t.original.length):t="%%\n",linkSelector&&$(linkSelector).attr("href","http://gregorio.gabrielmass.com/cgi/process.pl?gregtext="+window.escape(t+e)+"&gregfontselect=17&gregtextfontselect=12&greginitialselect=43&gregspaceselect=7mm&gregredselect=N&greglinethickselect=10&gregpaperselect=letterpaper&gregfaceselect=libertine&gregcropselect=N");try{if(linkDownloadSelector){var n=encode_utf8(t+e),i="data:text/plain;charset=utf8;base64,"+btoa(n),a=t.name||"Untitled";a.match(/\.gabc$/)||(a+=".gabc"),$(linkDownloadSelector).attr("charset","UTF-8").attr("href",i).attr("data-downloadurl","text/plain:"+a+":"+i)}}catch(r){}return[t,e]}function updateChant(e,t,n){var i=t,a=$(t);if(a.is("svg")||(a=a.find("svg"),a.length||(a=$(_svg).clone().appendTo(t)),t=a[0]),t!=_svg&&otherElements.indexOf(t)<0&&i&&otherElements.push(i),!dontUpdateChant&&e){var r=updateLinks(e);if(_timeoutGabcUpdate&&clearTimeout(_timeoutGabcUpdate),!n){var s=gabcProcessTime+100;return _timeoutGabcUpdate=setTimeout(function(){updateChant(e,t,!0)},s),void 0}_nextUpdate=(new Date).getTime()+100+gabcProcessTime;var o=new Date;e=r,_timeoutGabcUpdate=null;var c=$(t).find(">g")[0];if(c){var l=[0],d=getChant(e,t,c,l),f=d.getBBox().height+l[0]+_heightCorrection-_defText.getExtentOfChar("q").height;$(t).height(f),t.parentNode.tagName.match(/span/i)&&$(t).css("width",d.getBBox().width),gabcProcessTime=new Date-o,console.info("Update chant time: "+gabcProcessTime),gabcProcessTime>3e3&&(gabcProcessTime=3e3)}}}function make(e,t,n){var i=document.createElementNS(svgns,e);if(t&&i.appendChild(document.createTextNode(t)),n)switch(typeof n){case"string":i.setAttribute("class",n);break;case"object":for(a in n)i.setAttribute(a,n[a])}return i}function textWidth(e,t,n){var i=0,a=void 0;if(0===e.length)return 0;if("number"==typeof t&&"number"==typeof n&&(i=t,a=n,t=n=void 0,0===a))return 0;var r=n?_defText:defText;if($.isArray(e)){var s,o;if(1!=e.length||0!=e[0].tags.length){if(0==i&&!a&&(o=JSON.stringify(e))&&(s=_txtWidths[o]))return s;$(r).empty();var c=0,l=0;return e.forEach(function(e){var t=e.span();r.appendChild(t);var n=Math.max(i,l),s=t.textContent.length,o=Math.min(l+s,i+(a||1e6))-n;n-=l,l+=s;try{o>0&&n>=0&&(c+=t.getSubStringLength(n,o))}catch(d){console.warn(d)}}),o&&(_txtWidths[o]=c||r.getComputedTextLength()),c}if(e=e[0].text,0==e.length)return 0;if(void 0==t&&(t=""),0==i&&!a&&(o=t+","+e)&&(s=_txtWidths[o]))return s}else if("object"==typeof e){if(1==e.childNodes.length){var d=e.firstChild,o=$(d).attr("class").replace(new RegExp("(?:^|\\s)"+fontclass+"(?:\\s|$)|\\s+$","g"),"")+","+d.textContent,s=_txtWidths[o];if(s)return s}$(r).empty().append($(e).clone());var c=r.getComputedTextLength();return o&&(_txtWidths[o]=c),c}t&&r.setAttribute("class",t),$(r).text(e.replace(/ /g," "));var c=r.getSubStringLength(i,a||e.length);return o&&(_txtWidths[o]=c),c}function useWidth(e,t,n){if(e.tagName.match(/^use$/i)&&(e=document.getElementById(e.getAttribute("href").slice(1))),"undefined"==typeof t)return getChantWidth(e.textContent);for(var i=0,a="",r="",s=[],o=0;o<e.childNodes.length;++o){var c=e.childNodes[o];if(i>=t){if(0==s.length&&getChantWidth(c.textContent)<=2?a=a.slice(0,0-r.length):r="",s.push(getChantWidth(a)),2==s.length)return s;a=r,t+=n}a+=c.textContent,r=c.textContent,i+=1}return s.push(getChantWidth(a)),s}function getChantWidth(e){return defChant.textContent=e,defChant.getComputedTextLength()}function selectGabc(e,t){var n=$("#editor");if(e+=getHeaderLen(n.val()),n.is(":visible"))n=n[0];else{n=$("#hymngabc")[0];var i,a=0;for(i in _hymnGabcMap){if(i>e)break;a=_hymnGabcMap[i]+e-i}e=a}if(-1==t){var r=$(n).val().slice(e).match(/^[^) ]*/);t=r[0].length}n.select(e,t),n.selectionStart=e,n.selectionEnd=e+t}function getTagsFrom(e){for(var t,n=[];t=regexTag.exec(e);){n.push(t[2]);var i=t.index+t[0].length;e=0==t.index?e.slice(t[0].length):e.slice(0,t.index)+e.slice(i)}return n}function tagsForText(e,t){"string"==typeof e&&(e=[e]);var n=[],i=e[0];t||(t=[]);for(var a;a=regexTag.exec(i);){var r=i.slice(0,a.index);if(r.length>0&&n.push(new TagInfo(r,t)),"/"!=a[1])t.indexOf(a[2])<0&&t.push(a[2]);else{var s=t.indexOf(a[2]);s>=0&&t.splice(s,1)}var o=a.index+a[0].length;i=i.slice(o)}return e[0]=i,n}function TagInfo(e,t){if(this.tags=$.merge([],t||[]),this.text=e.replace(/ /g," "),t&&t.indexOf("v")>=0){this.span=this.spanV,this.spans=[];for(var e="",n=this.text.match(/\\[^\\\s]*|[^\\]+/g),i=0;i<n.length;++i){var a=n[i];if("\\"==a[0]){a=a.slice(1);var r=vCodes[a];if(r){this.spans.push({txt:r}),e+=r;continue}}this.spans.push(a),e+=a}this.text=e}}function relayoutChant(e){var t,n,i,a,r,s,o,c,l,d,f,u=svgWidth=$(e.parentNode).width(),h=$(e),g=h.children("g"),m=h.find("#commentary"),p=0,v=0,x=0,b=0,T=h.find("#system"+x),y=T[0],C=T[0].info,A=h.find("defs")[0],w=C.y,S=[],_=[],k=u-C.x-spaceBetweenNeumes;for(tagsBetweenText=[],C.ltone=3,C.htone=10,m.length&&m.attr("x",u-m[0].getComputedTextLength()),lastClefBeforeNeume=function(e){var t,n={clefTone:9};for(t in _clefs){if(!(e>t))break;n=_clefs[t]}return n},lastClefBeforePunctum=function(t){var n,i={clefTone:9};for(n in _clefs)try{var a=parseInt($(e).find("#neume"+n).children()[0].id.match(/\d+$/)[0]);if(!(t>a))break;i=_clefs[n].info}catch(r){}return i};;){s=r,o=n,t=g.find("#neume"+b),n=g.find("#neumetext"+b),i=g.find("#neumetrans"+b),r=t[0]?t[0].neume:n[0]?n[0].neume:{match:{}},delete r.custos;var L=g.find("#neumemask"+b);a=$.merge($.merge($.merge($.merge($(),t),n),i),L),d=a.toArray(),f=t.toArray().concat(L.toArray());var N=!1;for(H in r.ledgers){N=!0;break}if(l=r.offset||0,0==a.length)break;v+=Math.min(0,l),r.wChant>0&&(v>p||!n.length)?p=v:s.lastOnLineHyphen&&($(s.lastOnLineHyphen).remove(),delete s.lastOnLineHyphen);var I=n.length?p+r.wText+Math.max(Math.floor(l),0):I||0;r.match[7]&&r.match.index>0&&(I+=5);var M=p+r.wChant+(r.spaceBeforeNextNeume||spaceBetweenNeumes)-Math.min(l,0);if(r.x=p,Math.max(I,M)>k){var O=lastClefBeforeNeume(b),E=O?O.wChant:0;!o.length||s.lastOnLineHyphen||o.text().slice(-1).match(/-|\s/)||(s.lastOnLineHyphen=new TagInfo("-").span(),o.append(s.lastOnLineHyphen)),I-=p,M-=p,p=0,v=E+(r.spaceBeforeNextNeume||spaceBetweenNeumes)+l,r.wChant>0&&v>p&&(p=v),I+=p,M+=p,r.x=p,++x,S.length&&(_.push(S),S=[]),y.words=_,_=[],tagsBetweenText=[],c=y,trimStaff(y,u-C.x);var P=finishStaff(y);if(T=h.find("#system"+x),T.length)y=T[0],y.info.htone=10,y.info.ltone=3;else{var B=staffoffset+P+verticalSpace+C.y;y=addStaff(e,y.parentNode,0,B,x,null,A),y.info.vOffset=y.info.y,T=$(y)}C=y.info,k=u-C.x-(r.spaceBeforeNextNeume||spaceBetweenNeumes)}if(S=S.concat(a.toArray()),t.length&&(C.ltone=Math.min(C.ltone,r.info.ltone),C.htone=Math.max(C.htone,r.info.htone),T.append(t),c&&!r.gabc.match(/^[,;:]+$/)&&(addCustos(c,r),c=null)),i.length&&(i[0].neume=r),n.length){$(C.eText).append(n),$(C.eTrans).append(i);var F=tagsBetweenText.length-1;if(0>=F)tagsBetweenText[0]=f;else{var W=tagsBetweenText[0][0],G=W.neume.x+W.neume.wChant;G+=r.transformX||0;var U=p;0>l&&(U-=l);for(var D=0,H=1;F>=H;++H)D+=tagsBetweenText[H][0].neume.wChant;var q=U-G-D;q/=F+1;for(var R=G+q,H=1;F>=H;++H){for(j in tagsBetweenText[H])tagsBetweenText[H][j].neume.x=R;R+=q+tagsBetweenText[H][0].neume.wChant}tagsBetweenText=[f]}}else tagsBetweenText.length>0&&!r.info.ftone&&(tagsBetweenText.push(f),(1==S.length&&S[0]==t[0]||2==S.length&&S[0]==t[0]&&S[1]==L[0])&&(_.push(S),S=[]));N&&processLedger(r,t[0],S),r.match[7]&&(_.push(S),S=[]),p=I,v=M,++b}for(S.length&&_.push(S),y.words=_,justifyLine(y,!0,!0),y.custos&&($(y.custos).remove(),y.custos=void 0),y.custosLedger&&($(y.custosLedger).remove(),y.custosLedger=void 0),trimStaff(y,u-C.x),finishStaff(y),trimStaff(y);T.length;)++x,T=h.find("#system"+x),T.remove();e.setAttribute("height",$(e).children("g")[0].getBBox().height+w+_heightCorrection-_defText.getExtentOfChar("q").height)}function getChant(e,t,n,i){i||(i=[]);var a=e[0];e=e[1];var r=e.match(/[\r\n]\s*[-\w]+:[^;]+;\s*[\r\n]/);r&&(e=e.slice(0,r.index));var s=t?t.parentNode&&"chant-preview"==t.parentNode.id:!1,o=$(t).find("defs")[0];o||(o=_defs);var c,l=0,d=0;n?$(n).empty():(n=make("g"),n.setAttribute("transform","translate(0,"+staffoffset+")"),n.setAttribute("class","caeciliae")),s&&(_clefs=[],_accidentals=[],_tones=[]);var f=$(t.parentNode).width(),u=a["user-notes"],h=a.commentary,g=0;if("string"==typeof u&&u.length>0){var m=make("text",u);m.setAttribute("id","userNotes"),m.setAttribute("class",fontclass+" i"),m.setAttribute("y",16-staffoffset),n.appendChild(m),g=20}if("string"==typeof h&&h.length>0){var m=make("text",h);m.setAttribute("id","commentary"),m.setAttribute("class",fontclass+" i"),m.setAttribute("y",16-staffoffset),n.appendChild(m),m.setAttribute("x",f-m.getComputedTextLength()),g=20}i[0]=g,regexOuter.lastIndex=0;var p,v,x,b,T,y,C,A,w,S,_=0,k=0,L=null,N=0,I=!0,M=0,O=[],E=[],P=[],B=!1,F=fontclass,W=[],G=addStaff(t,n,0,g,M,null,o),U=G.info;try{var j=$(t.parentNode).css("padding-left");j&&(f-=parseFloat(j))}catch(D){}for(svgWidth=f;gmatch=regexOuter.exec(e);){var H=gmatch[5]?gmatch[5].match(/[`,;:]+|[^\/,;:]*\/*/g):["",""];H.splice(-1,1);for(var q,R=gmatch.index,V=0;V<H.length;++V){var c=1==H.length?gmatch:0==V?gmatch.slice(0,6):V==H.length-1?gmatch.slice(4):["",""];5==c.length&&c.splice(0,0,"","","",""),c.index=R+=c[1].length;var z=H[V];R+=z.length;var K=z.match(/\//g);if(K?(K=K.length,z=z.slice(0,-K),q=K*slashSpace):q=spaceBetweenNeumes,"z0"!=z){var X={index:c.index,match:c,ledgers:{},wChant:0,wText:0,spaceBeforeNextNeume:q},Y=[];z?(X.gabc=z,X.info=getChantFragment(X.gabc,o),C=X.info.clef||C,s&&(X.info.clef&&(_clefs[l]=w=X,w.clefs=[],_accidentals[d]=3==C.length?-1:null),_tones=_tones.concat(X.info.tones)),defChant.textContent=X.info.def.textContent,X.wChant=defChant.getComputedTextLength(),X.gabc==C&&(A=X.wChant)):X.info={},E.length>0&&S&&(S[7]||S[8])&&(O.push(E),E=[]);var Z=c[7]||c[8],m=c[3]||Z,J=regexSqBrackets.exec(m);J&&(m=m.slice(0,J.index)+m.slice(J.index+J[0].length),J=J[1]),c[3]&&Z&&(m+=Z),X.txt=m,X.translation=J;var Q=0;if(m){if(I&&c[3]&&(I=!1,"0"!=a["initial-style"])){var et=m[0];m=m.slice(1),0==m.replace(/[{}]/g,"").length&&(m="-");var tt=U.txtInitial=make("text",et);tt.setAttribute("transform","translate(0,"+U.vOffset+")"),tt.setAttribute("class","greinitial"),n.appendChild(tt);var nt=tt.getComputedTextLength(),it=a.annotation;if("string"==typeof it&&it.length>0){var r=/([a-g]\d?\*?\s*)$/.exec(it),at="</sc>";r&&(it=it.slice(0,r.index),at+=r[0]),it=it.replace(/\b[A-Z\d]+\b/,function(e){return e.toLowerCase()})+at;var rt=U.txtAnnotation=make("text"),st=tagsForText("<sc><v>"+it+"</v></sc>");for(Nt in st)rt.appendChild(st[Nt].span());rt.setAttribute("class","greannotation"),rt.setAttribute("y",U.vOffset-25),n.appendChild(rt);var ot=rt.getComputedTextLength(),ct=Math.max(ot,nt)/2;rt.setAttribute("x",ct-ot/2),tt.setAttribute("x",ct-nt/2),N=Math.max(ot,nt)+5}else N=nt+5;U.eText.setAttribute("transform","translate("+N+","+U.vOffset+")"),U.eTrans.setAttribute("transform","translate("+N+","+U.vOffset+")"),U.x=N;var lt=$(G).find("use[href=#staff]")[0];lt.setAttribute("transform","scale("+(f-N)+",1)")}m=m.replace(/^\s+/,"").replace(/\r\n/g," ").replace(/\n/g," ").replace(/<v>(?:\\greheightstar|\$\\star\$)<\/v>/g,"*").replaceSpTags();var dt=[m];Y=tagsForText(dt,P),m=dt[0];var ft="";if(Y.length>0&&Y.forEach(function(e){ft+=e.text}),m.length>0){var ut=m.replace(/[{}]/g,"");ut.length>0&&Y.push(new TagInfo(ut,P))}if(m=ft+m,X.wText=textWidth(Y),m){var ht,gt=m.indexOf("{"),mt=m.indexOf("}");if(gt>=0&&mt>gt){var pt=m.slice(gt+1,mt);m=m.slice(0,gt)+pt+m.slice(mt+1),--mt,ht={index:gt,0:pt,1:pt}}else ht=/^english$/i.exec(a["centering-scheme"])?{index:0,0:m.replace(/[,.:;\s]*$/,""),1:m.replace(/[,.:;\s]*$/,"")}:regexVowel.exec(m);ht||(ht={index:0,0:m.trimRight(),1:m.trimRight()});try{var vt=ht.index+ht[0].length-ht[1].length;Q-=textWidth(Y,0,vt),Q-=textWidth(Y,vt,ht[1].length)/2}catch(D){}Q+=notewidth/2}}var xt=X.info.startsWithAccidental?getChantWidth("b-"):0;Q+=xt,X.offset=Q,k+=Math.min(0,Q),X.wChant>0&&(k>_||!m)&&(_=k);var bt=m?_+X.wText+Math.max(Math.floor(Q),0):bt||0;c[7]&&c.index>0&&(bt+=5);var Tt=Math.max(_,k)+X.wChant+q-Math.min(Q,0),yt=0==X.wText?Math.max(yt||0,_):Math.max(bt,Tt);if(b||yt>=f-N-q-X.wChant){B=G,B.justify=b?b.justify:!0,B.justify||(T=_),b=void 0,W=[],L&&m&&"-"!=$(L).text().slice(-1)&&L.appendChild(X.lastOnLineHyphen=new TagInfo("-").span()),E.length>0&&(O.push(E),E=[]),G.words=O,O=[];var Ct=finishStaff(G),At=staffoffset+Ct+verticalSpace+U.y;if(G=addStaff(t,n,0,At,++M,null,o),G.info.vOffset=G.info.y,U=G.info,U.eText.setAttribute("transform","translate(0,"+U.vOffset+")"),U.eTrans.setAttribute("transform","translate(0,"+U.vOffset+")"),yt-=_,bt-=_,Tt-=_,C){var p=make("use");p.setAttribute("class","clef"),p.setAttributeNS(xlinkns,"href","#"+C),p.setAttribute("x",0),p.setAttribute("y",0),G.appendChild(p),w&&w.clefs&&w.clefs.push(p),_=0,k=A+q+Q,X.wChant>0&&k>_&&(_=k),yt+=_,bt+=_,Tt+=_}else _=0}if(b=X.gabc&&X.gabc.match(/z(?!0)/i),b&&(b.justify=X.gabc.match(/z/)),X.gabc){if(B&&!X.gabc.match(/^[`,;:]+$/)&&(addCustos(B,X,B.justify,T),B=!1,N=0),X.info.mask?(v=make("use"),v.setAttributeNS(xlinkns,"href","#"+X.info.mask),v.setAttribute("id","neumemask"+l),v.setAttribute("class","caeciliae"),v.setAttribute("x",_),v.setAttribute("y",0),E.push(v),masks[M].firstChild.appendChild(v)):v=null,U.ltone=Math.min(U.ltone,X.info.ltone),U.htone=Math.max(U.htone,X.info.htone),s?p=$(X.info.def).clone()[0]:(p=make("use"),p.setAttributeNS(xlinkns,"href","#"+X.gabc)),p.setAttribute("id","neume"+l),p.setAttribute("x",_),p.setAttribute("y",0),p.neume=X,s&&(d=setUpPunctaIn(p,d),Z)){var pt=C&&3==C.length?-1:null;_accidentals[_accidentals.length-1]!=pt&&(_accidentals[d]=pt)}if(G.appendChild(p),E.push(p),currentUse=[p],v&&currentUse.push(v),m){var wt=W.length-1;if(0>=wt)W[0]=currentUse;else{var St=W[0][0],_t=parseFloat(St.getAttribute("x"))+St.neume.wChant,$t=St.getAttribute("transform");if($t){var r=regexTranslate.exec($t);_t+=parseFloat(r[1])}var kt=_;0>Q&&(kt-=Q);for(var Lt=0,Nt=1;wt>=Nt;++Nt)Lt+=W[Nt][0].neume.wChant;var It=kt-_t-Lt;It/=wt+1;for(var Mt=_t+It,Nt=1;wt>=Nt;++Nt)$(W[Nt]).attr("x",Mt),Mt+=It+W[Nt][0].neume.wChant;W=[currentUse]}}else W.length>0&&!X.info.ftone?(W.push(currentUse),(1==E.length&&E[0]==p||2==E.length&&E[0]==v&&E[1]==p)&&(O.push(E),E=[])):X.info.ftone&&(W=[])}else p=v=null;if(m){y=L,pneume=x,L=make("tspan"),x=X;var Ot=_;if(p&&(X.transform="translate("+-Q+")",X.transformX=-Q,Q>0?Ot-Q>=k?(X.wText-=Q,p.setAttribute("transform",X.transform),v&&v.setAttribute("transform",X.transform)):(Ot+=Q,X.wText+=Q):(p.setAttribute("transform",X.transform),v&&v.setAttribute("transform",X.transform))),y){var Et=parseFloat(y.getAttribute("x"),10),Pt=Et+textWidth(y);if(Ot>Pt&&"-"!=$(y).text().slice(-1)&&(y.appendChild(new TagInfo("-").span()),pneume.wText=textWidth(y),Pt=Et+pneume.wText,Pt>Ot)){var Bt=Pt-Ot;Ot=Pt,p&&(p.setAttribute("x",_+Bt),v&&v.setAttribute("x",_+Bt)),bt+=Bt,Tt+=Bt}}if(L.setAttribute("id","neumetext"+l),L.setAttribute("x",Ot),L.setAttribute("class",F+" selectable"),L.setAttribute("selectIndex",X.index),L.neume=X,_=bt,k=Tt,Y.forEach(function(e){L.appendChild(e.span())}),J){var Ft=new TagInfo(J,["i","trans"]).span();Ft.setAttribute("id","neumetrans"+l),Ft.setAttribute("x",Ot),E.push(Ft),U.eTrans.appendChild(Ft)}E.push(L),U.eText.appendChild(L)}else p?(k=Math.max(k,_+getChantWidth(X.info.def.textContent)+q),_=bt):k=Math.max(k,_);l++,S=c,Z&&(L=null),processLedger(X,p,E)}}}return finishStaff(G),gabcSettings.trimStaff&&trimStaff(G),n}function processLedger(e,t,n){for(i in e.ledgers)$(e.ledgers[i]).remove();if(e.ledgers={},e.info.ledgerA&&(e.info.ledgerA.length||e.info.ledgerB.length)&&t){var a=t.parentNode,r=[];processLedgerHelper(e.info.ledgerA,r,!0),processLedgerHelper(e.info.ledgerB,r,!1),r.forEach(function(i){var r=insertLedger(i,a,t);e.ledgers[i.above]=r,n&&n.push(r)})}}function processLedgerHelper(e,t,n){var i=null,r=0;for(a in e){var s=e[a];s-1==i?++r:s-2==i?r+=2:(r>0&&t.push({i:i,len:r,above:n}),i=s,r=1)}r>0&&t.push({i:i,len:r,above:n})}function insertLedger(e,t,n,i){var a=0,r=1;"object"==typeof e&&(a=e.i,r=e.len,e=e.above);var s=make("use");s.setAttributeNS(xlinkns,"href",e?"#ledgera":"#ledgerb"),s.setAttribute("y",n.getAttribute("y"));var o=n.getAttribute("transform"),c=parseFloat(n.getAttribute("x"));if(o)for(;m=regexTranslateG.exec(o);)c+=parseFloat(m[1]);var l=useWidth(n,a,r);return c+=l[0],l=l[1],i?(c-=.25*notewidth,s.setAttribute("transform","translate("+c+") scale("+(l+.25*notewidth)+",1)")):(c-=.75*notewidth,s.setAttribute("transform","translate("+c+") scale("+(l+1.5*notewidth)+",1)")),n?t.insertBefore(s,n):t.appendChild(s),s}function addStaff(e,t,n,i,a,r,s){var o,c="staffmask"+a,l="staff"+a,d="system"+a;if(masks[a]){for(var f=masks[a].firstChild;f.childElementCount>1;)f.removeChild(f.childNodes[1]);o=f.firstChild}else{var u,h,g=masks[a];g&&g.parentNode!=s&&(g=$(s).find("#"+c)[0]),g?(u=g,h=u.firstChild,o=$(h).find(">rect")[0]):(u=make("mask"),u.setAttribute("maskUnits","objectBoundingBox"),u.setAttribute("id",c),h=make("g"),h.setAttribute("class","caeciliae"),u.appendChild(h),o=make("rect"),h.appendChild(o),s.appendChild(u)),masks[a]=u,u.setAttribute("transform","translate(0,"+i+")")}o.setAttribute("y",-staffheight),o.setAttribute("width","10000"),o.setAttribute("height",1+staffheight),o.setAttribute("fill","white");var m=make("g"),p=m.info={ltone:3,htone:10,vOffset:0,x:0,y:parseInt(i),eText:make("text"),eTrans:make("text")};p.eText.setAttribute("class",fontclass),p.eTrans.setAttribute("class",fontclass);var v=make("g");m.setAttribute("id",d),v.setAttribute("id",l),v.setAttribute("mask","url(#"+c+")");var x=make("use");return x.setAttributeNS(xlinkns,"href","#staff"),r||(r=$(e.parentNode).width()),x.setAttribute("transform","translate("+n+") scale("+r+",1)"),v.appendChild(x),m.appendChild(v),t.appendChild(m),m}function setGradient(e,t){var n=0==t?"RedBlack":"BlackRed",i=e.parentNode,a=$(e).index(),r=useWidth(i,a,1),s=i.neume.wChant||useWidth(i),o="grad"+n+r.join("_")+"_"+s;if(!(o in gradients)){var c=$(gradients[n]).clone(),l=c.find("stop");c.attr("id",o),$(l[0]).attr("offset",(r[0]+.25*r[1])/s),$(l[1]).attr("offset",(r[0]+.75*r[1])/s),_defs.appendChild(c[0]),gradients[o]=c[0]}e.setAttribute("style","fill:url(#"+o+")")}function setUpPunctaIn(e,t){var n=0,i=t,a=e.neume.info.tones;return $(e).children().each(function(){var e=a[n];e.match[rtg.accidental]?_accidentals[t]=e.match[rtg.flat]?e.index-_clefs[_clefs.length-1].info.clefTone:null:e.match[rtg.whitespace]&&e.match[rtg.whitespace].match(/[,;:]/)&&(_accidentals[t]=_clefs.length&&3==_clefs[_clefs.length-1].gabc.length?-1:null),this.setAttribute("id","punctum"+t),this.tone=e;var r=parseInt(this.getAttribute("count"))||1;2==r?t==selectedPunctum?(selectedPunctumTag=this,this.setAttribute("class","selectable selected-1"),setGradient(this,0)):t+1==selectedPunctum?(selectedPunctumTag=this,this.setAttribute("class","selectable selected-2"),setGradient(this,1)):this.setAttribute("class","selectable"):t==selectedPunctum?(selectedPunctumTag=this,this.setAttribute("class","selectable selected")):this.setAttribute("class","selectable"),n+=parseInt(this.getAttribute("count"))||1,t=i+n}),t}function gabcEditorKeyDown(e){var t=$(this),n=t.val(),i=this.selectionStart,a=this.selectionEnd;switch(e.which){case 66:(e.ctrlKey||e.altKey)&&(e.preventDefault(),r=n.indexOf(" ",this.selectionEnd),0>=r&&(r=n.length),t.val(n.slice(0,r)+" ()"+n.slice(r)),this.selectionEnd=this.selectionStart=r+2);break;case 83:i==a&&(e.ctrlKey||e.altKey)&&"("!=n[i-1]&&")"!=n[i]&&(e.preventDefault(),t.val(n.slice(0,i)+"()"+n.slice(i)),this.selectionEnd=this.selectionStart=i+1);break;case 9:var r,s,o;if(e.preventDefault(),e.shiftKey)r=this.selectionStart,o=n.lastIndexOf("\n%%\n",r-1),r=n.lastIndexOf(")",r-1),o>=r&&(r=n.lastIndexOf(")")),r>=0&&(s=r,r=n.lastIndexOf("(",r));else{r=this.selectionEnd;var c=/(\()|(-(?!\())|(\s+(?![:;!.])|[^)\s]$)/g;c.lastIndex=r;for(var l;(l=c.exec(n))&&(l[2]||l[3]);)if(!l[3]||0!=l.index&&")"!=n[l.index-1]){r=l.index;var d=n.lastIndexOf("\n",r-1)+1,f=n.indexOf("\n",r);0>f&&(f=n.length),"\r"==n[f]&&f--;var u=n.slice(d,f);if(!u.match(/^(?:\s*(?:%.*|[-\w]+:[^;]+;)\s*|%%)$/))break}l?l[1]?r=l.index:l[2]||l[3]?(r=l.index+1,n=n.slice(0,r)+"()"+n.slice(r),t.val(n)):r=n.indexOf("("):r=n.indexOf("("),r=n.indexOf("(",r),r>=0&&(s=n.indexOf(")",r))}r>=0&&s>=0&&(this.selectionStart=r+1,this.selectionEnd=s);break;case 57:if(e.shiftKey){var h=this.value.slice(a),g=h.indexOf(")"),m=h.indexOf("(");if(0>g||m>=0&&g>m)return this.value=this.value.slice(0,this.selectionStart)+"()"+this.value.slice(a),this.selectionStart=this.selectionEnd=i+1,e.preventDefault(),void 0}break;case 48:e.shiftKey&&i==a&&")"==n[i]&&(e.preventDefault(),this.selectionStart=this.selectionEnd=i+1);break;case 8:var a=this.selectionEnd;a==this.selectionStart&&a>0&&")"==this.value[a]&&"("==this.value[a-1]&&(e.preventDefault(),this.value=this.value.slice(0,this.selectionStart-1)+this.value.slice(a+1),this.selectionStart=this.selectionEnd=a-1)}}String.prototype.repeat=function(e){return new Array(e+1).join(this)},String.prototype.trimRight||(String.prototype.trimRight=function(){return this.replace(/\s+$/,"")});var gabcSettings={trimStaff:!0},uuid,_indicesChar={flat:[57585,58176,57586,58177,57587,58178,57588,58179,57589,58180,57590,58181,57591],natural:[57593,58182,57594,58183,57595,58184,57596,58185,57597,58186,57598,58187,57599],flat_line:58176,natural_line:58182,punctum:57603,diamond:57619,virga:57635,v:57635,leftVirga:57651,quilisma:57667,w:57667,bottomPartPodatus:57684,topPartPodatus:57699,podatus:[null,57715,57731,57748,57763],o:57779,O:57795,diamond_tilde:57811,">":57827,"<":57843,upper_tilde:57859,lower_tilde:57875,porrectus:[null,57891,57907,57923,57939],r:57971,s:57987,custos:58019,"+":58019,dot:58035,apos:58050,ictus:58050,ictus_above:58053,ictus_below:58050,underscore:58066,episema:58066,episema_below:58066,episema_above:58069,underscore_longer:58082,episema_longer:58082,clivis:[null,58115,58131,58147,58163],accent_above_staff:58188,connecting_line:[void 0,void 0,59139,59155,59171,59187],decorative_line:[void 0,59203,59219,59235,59251,59267]},vCodes={Abar:"a",Vbar:"v",Rbar:"r"},_indicesLig={flat:"b",natural:"a",punctum:"p",diamond:"n",virga:"v",v:"v",leftVirga:"c",quilisma:"q",w:"q",podatus:"P",bottomPartPodatus:57684,topPartPodatus:"P",o:"o",O:"O",diamond_tilde:"N",">":"L","<":"k",upper_tilde:"K",lower_tilde:"l",porrectus:"R",r:"w",s:"s",custos:"u","+":"u",dot:".",apos:"I",ictus:"I",ictus_above:"I",ictus_below:"i",underscore:"H",episema:"H",episema_above:"H",episema_below:"h",underscore_longer:58082,episema_longer:58082,clivis:"C",accent_above_staff:"~",connecting_line:"x",decorative_line:"X"},fontclass="goudy",_neumeLig=function(e,t){if(arguments.length<2)return"";if("string"!=typeof e)return 2==arguments.length&&"number"==typeof e?_neumeChar(e,t):"";for(var n="",i=1;i<arguments.length;)n+=_ci[arguments[i++]];return n+e},_neumeChar=function(e,t){if(arguments.length<2)return"";var e,t,n=e;return e=parseInt(t),t=0,"object"==typeof n&&(arguments.length>2&&(t=parseInt(arguments[2])),n=n[Math.abs(t-e)],2==arguments.length&&(e=0)),String.fromCharCode(n+e)},_clefSpanLig=function(e){var t=parseInt(e.clef.slice(-1),10),n=2*t-1,i="";return 3==e.clef.length&&(i+=neume(indices.flat,n+1)+"-"),make("tspan",String(n)+(2==e.index?"d":"f")+"-"+i)},_clefSpanChar=function(e,t){var n,i,a=parseInt(e.clef.slice(-1),10),r=0;return 2==e.index?(i="d-",r=2-a):(i="f-",r=3-a),3==e.clef.length&&(i+=neume(indices.flat,4)+"-"),r*=spaceheight,t[0]=Math.min(t[0],r),n=make("tspan",i),n.setAttribute("dy",r),n},_ci=["B","A","0","1","2","3","4","5","6","7","8","9","Z"],staffheight=48,spaceheight=staffheight/4,notewidth=staffheight/6,spaceBetweenNeumes=notewidth,slashSpace=staffheight/20,verticalSpace=staffheight/4,fontsize=3*spaceheight/2,spaceWidth=3*spaceheight/4,staffoffset=Math.ceil(staffheight-spaceheight/2),svgns="http://www.w3.org/2000/svg",xlinkns="http://www.w3.org/1999/xlink",staffInFont=!1,fontExt="ttf",fontExtS="svg#webfont",fontFormat="truetype",fontFormatS="svg",filenameCaeciliae="Caeciliae-"+(staffInFont?"Regular.":"Staffless.")+fontExt,filenameCaeciliaeS="Caeciliae-"+(staffInFont?"Regular.":"Staffless.")+fontExtS,filenameCaeciliaePrint="Caeciliae-"+(staffInFont?"Regular":"Staffless")+"-Print."+fontExt,localCaeciliae="Caeciliae"+(staffInFont?"":" Staffless"),familyCaeciliae="Caeciliae"+(staffInFont?"":" Staffless"),styleCaeciliae="font-family: '"+familyCaeciliae+"'; font-size:"+staffheight+"px;",styleCaeciliaeSvg="font-family: '"+familyCaeciliae+" SVG'; font-size:"+staffheight+"px;",styleGoudy="font-family: 'OFL Sorts Mill Goudy TT'; font-size: "+fontsize+"px;",styleFont="@font-face {font-family: '"+familyCaeciliae+"'; font-weight: normal; font-style: normal;src: local('"+localCaeciliae+"'); src: url('"+filenameCaeciliae+"') format('"+fontFormat+"')}"+"@font-face {font-family: '"+familyCaeciliae+" SVG'; font-weight: normal; font-style: normal;src: url('"+filenameCaeciliaeS+"') format('"+fontFormatS+"')}"+"@font-face {font-family: '"+familyCaeciliae+" Print'; font-weight: normal; font-style: normal;src: url('"+filenameCaeciliaePrint+"') format('"+fontFormat+"')}"+"@font-face {font-family: 'OFL Sorts Mill Goudy TT'; font-style: italic; font-weight: normal; src: local('OFL Sorts Mill Goudy Italic TT'), local('OFLGoudyStMTT-Italic'), url('OFLGoudyStMTT-Italic.ttf') format('truetype');}"+"@font-face {font-family: 'OFL Sorts Mill Goudy TT'; font-style: normal; font-weight: normal; src: local('OFL Sorts Mill Goudy TT'), local('OFLGoudyStMTT'), url('OFLGoudyStMTT.ttf') format('truetype');}",svgWidth,_svg,svg,textElem,codea="a".charCodeAt(0),codem=codea+12,codeA="A".charCodeAt(0),codeM=codeA+12,regexTranslate=/translate\((-?\d+(?:\.\d+)?)(?:[,\s]\s*(-?\d+(?:.\d+)?))?\)/,regexTranslateG=/translate\((-?\d+(?:\.\d+)?)(?:[,\s]\s*(-?\d+(?:.\d+)?))?\)/g,regexHeaderEnd=/(?:^|\n)%%\s?\n/,regexOuter=/((([^\(\r\n]+)($|\())|\()([^\)]*)($|\))(?:(\s+)|(?=(?:\([^\)]*\))+(\s*))|)/g,regexTag=/<(\/)?(b|i|sc|v)>/i,regexSqBrackets=/\[([^\]]*)(?:\]|$)/,regexTags=/(<(b|i|sc)>)(.*?)(?:(<\/\1>)|$)/i,regexTagsSp=/<sp>([^<]*)<\/sp>/gi,spSubstitutions={"'ae":"ǽ","'æ":"ǽ",ae:"æ",oe:"œ","'œ":"œ","'oe":"œ",AE:"Æ",OE:"Œ",Ae:"Æ",Oe:"Œ","V/":"V","R/":"R","A/":"A"};String.prototype.replaceSpTags=function(){return this.replace(regexTagsSp,function(e){var t=e.slice(4,-5);return spSubstitutions[t]||t})};var regexInner=/(?:[!\/ ,;:`]+|[^\)!\/ ,;:`\[]+)|(\[[^\]]*(?:$|\]))/g,rog={syl:3,gabc:5,whitespace:7},linkSelector="",linkDownloadSelector="",setPdfLinkSelector=function(e){linkSelector=e},onDragStart=function(e){console.info(e),e.originalEvent.dataTransfer.setData("DownloadURL",this.getAttribute("data-downloadurl"))},setGabcLinkSelector=function(e){linkDownloadSelector=e,$(e).bind("dragstart",onDragStart)},regexToneModifiers=/(')|(\.{1,2})|(_{1,4}0?)/g,regexTones=new RegExp("([/ ,;:`]+)|((?:[fF]|[cC][bB]?)[1-4])|(?:(-)?(([A-M])|([a-m]))(([Vv]{1,3})|(s{1,3})|((<)|(>)|(~))|(w)|(o)|(O)|((x)|(y))|(q)|((R)|(r0)|(r(?![1-5])))|(r[1-5])|(\\+))?((?:"+String(regexToneModifiers).replace(/^\/|\/\w*$/g,"").replace(/\((?!\?:)/g,"(?:")+")*)|(z0))|\\[([^\\]]*)(?:\\]|$)","g"),regexTonesSpliceIndex=27,regexToneModifiersCount=4,rtg={whitespace:1,clef:2,initioDebilis:3,tone:4,toneUpper:5,toneLower:6,noteType:7,virga:8,stropha:9,liquescentia:10,ascendingLiquescentia:11,descendingLiquescentia:12,diminutiveLiquescentia:13,quilisma:14,oriscus:15,oriscusReverse:16,accidental:17,flat:18,natural:19,q:20,lineaPunctum:22,lineaPunctumCavum:23,punctumCavum:24,rNumber:25,custos:26,ictus:27,dot:28,episema:29,custos:30,bracketed:31},regexVowel=/(?:[cgq]u|[iy])?([aeiouyáéëíóúýǽæœ]+)/i,transforms=[["/"," ",",",";",":","`",""],["'","_","+",";","|",",",""],[/\//g,/ /g,/,/g,/;/g,/:/g,/`/g,/!/g]],abcs={},_defs=null,defText=null,_defText=null,defChant=null,masks=[],selectedPunctum=-1,selectedNeume=-1,selectedPunctumTag=null,selectedNeumeTag=null,_timeoutGabcUpdate=null,_minUpdateInterval=1700,_heightCorrection=0,_clefs=[],_accidentals=[],_tones=[],utf8_bom=String.fromCharCode(239)+String.fromCharCode(187)+String.fromCharCode(191);Header.prototype.toString=function(){var e=[];for(key in this)if("length"!=key&&"original"!=key&&"comments"!=key&&"cValues"!=key&&"string"==typeof this[key]){var t=this[key+"Array"];if(t)for(i in t)e.push(key+": "+t[i]+";");else e.push(key+": "+this[key]+";")}for(key in this.cValues)0!=key.length&&e.push("%"+key+": "+this.cValues[key]+";");for(i in this.comments)try{e.splice(i,0,this.comments[i])}catch(n){}return e.join("\n")+"\n%%\n"};var regexHeaderLine=/^([\w-_]+):\s*([^;\r\n]*)(?:;|$)/i,regexHeaderComment=/^%.*/,gabcProcessTime=0,_nextUpdate=(new Date).getTime(),dontUpdateChant=!1,otherElements=[],_txtWidths={};TagInfo.prototype.span=function(){var e=make("tspan",this.text,fontclass+" "+this.tags.join(" "));return e},TagInfo.prototype.spanV=function(){for(var e=fontclass+" "+this.tags.join(" "),t=make("tspan","",e),n=0;n<this.spans.length;++n){var i=this.spans[n];switch(typeof i){case"object":t.appendChild(make("tspan",i.txt,"versiculum"));break;case"string":t.appendChild(document.createTextNode(i))}}return t};var finishStaff=function(e){var t=e.parentNode,n=parseInt(e.id.match(/\d+$/)[0]),i=e.info,a=i.ltone,r=i.htone;a=3-a,a=0>=a?0:a*spaceheight/2,r-=9,r=0>=r?0:r*spaceheight/2;var s=Math.ceil(.1*staffheight+fontsize+a+r);if(i.vOffset=i.y,i.txtInitial&&i.txtInitial.setAttribute("y",s+i.y),i.txtAnnotation&&i.txtAnnotation.setAttribute("y",i.y+Math.ceil(r)-25),i.eText.setAttribute("y",s),i.eTrans.setAttribute("y",s+fontsize),i.eText.setAttribute("transform","translate("+i.x+","+i.vOffset+")"),i.eTrans.setAttribute("transform","translate("+i.x+","+i.vOffset+")"),t&&(t.appendChild(i.eText),t.appendChild(i.eTrans)),i.eTrans.childNodes.length>0&&(s+=fontsize),r>0){if(i.vOffset+=r,0==n){var o=0;$(e).children("[id^=neume]").each(function(){o=Math.min(o,this.neume.info.mindy)}),_heightCorrection=o+r}e.setAttribute("transform","translate("+i.x+", "+(i.y+r)+")")}return s},trimStaff=function(e,t){var n,i=$(e).find("use[href=#staff]");if(t)n=t;else{var a=$(e).find("[id^=neume]:last"),r=$(e.parentNode).find("[id^=neumetext]:last");if(href=a.attr("href")){if(!/\:$/.exec(href))return}else if(!/\|$/.exec(a.text()))return;var s=/\d+$/.exec(a.prop("id"))[0],o=/\d+$/.exec(r.prop("id"))[0];if(o>s)return;n=parseFloat(a.attr("x"));var c=a.attr("transform"),l=regexTranslate.exec(c);l&&l[1]&&(n+=parseFloat(l[1])),n+=a[0].neume.wChant}var d="scale("+n+",1)";i.attr("transform",function(e,t){return t.replace(/scale\([^\)]*\)/,d)})},justifyLine=function(e,t,n){var i=0,a=0,r=e.words;if(!n){var s=2*spaceBetweenNeumes;a=svgWidth-e.info.x-s;for(var o,c,l=r.length-1;l>=0&&(!o||!c);)for(var d=r[l--],f=d.length-1;f>=0&&(!o||!c);){var u=d[f--];!o&&u.tagName.match(/^use|text$/i)&&u.neume?o=u:c||!u.tagName.match(/^tspan$/i)||(c=u)}if(o){if(t)i=o.neume.x+(o.neume.transformX||0);else{i=parseFloat($(o).attr("x"));var h=t?o.neume.transform:$(o).attr("transform"),g=regexTranslate.exec(h);g&&g[1]&&(i+=parseFloat(g[1]))}i+=o.neume.wChant}if(c){var m;t&&c.neume?m=c.neume.x:(m=parseFloat($(c).attr("x")),m+=textWidth(c)-s),i=Math.max(i,m)}}if(n||i>0){var p=a-i,v=r.length-1,x=p/v;if(n||p>0)for(;v>=0;)r[v].forEach(function(e){e.neume&&(e.neume.justifyOffset=Math.round(p)),$(e).attr("transform")?(t&&e.neume&&$(e).attr("x",e.neume.x),$(e).attr("transform",function(){return"translate("+Math.round(p+(e.neume&&e.neume.transformX||0))+")"
})):$(e).attr("x",function(n,i){return(t?e.neume.x:i?parseFloat(i):0)+Math.round(p)})}),p-=x,--v}},addCustos=function(e,t,n,i){var a=t.info.ftone,r=neume(indices.custos,a),s=e.custos;if(s){if(s.textContent=r,e.custosLedger)try{e.removeChild(e.custosLedger),delete e.custosLedger}catch(o){}}else s=make("text",r),s.setAttribute("class",defChant.getAttribute("class")),s.setAttribute("y",0);(n||"undefined"==typeof n)&&(justifyLine(e,"undefined"!=typeof t.x),n=!0);var c=n?svgWidth-e.info.x-staffheight/15:i;s.setAttribute("x",c),e.appendChild(s),e.custos=t.custos=s;var l=a>10,d=2>a;(l||d)&&(e.custosLedger=t.custosLedger=insertLedger(l,e,s,!0))},boolArray=[!0,!1],ToneInfo=function(e){for(i in e)this[i]=e[i]};!function(){var e,t,n,i,a;getChantFragment=function(s,o){if(void 0!=abcs[s])return abcs[s];var c=void 0;s.indexOf("r")>-1&&(c=s.replace(/r/g,"!"),getChantFragment(c,o)),t=make("text"),a=3,i=0,t.setAttribute("id",s);var l,d,f,u=null,h=0;ledgerA=[],ledgerB=[],n=0,regexInner.lastMatch=0;for(var g=[];l=regexInner.exec(s);)if(!l[1]){e=[];var m=-1;chant=l[0],regexTones.exec("");for(var p;p=regexTones.exec(chant);){++h;var v=[];if(p[regexTonesSpliceIndex])for(var x,b=p[regexTonesSpliceIndex];x=regexToneModifiers.exec(b);){if(x[3]){var T=x[3].match(/0/)?-1:0,y=x[3].length+T-1;x[3]=x[3].slice(T-1);for(var C=1,A=e.length;y>=C&&A>=C;){var w=e[A-C];w.match[rtg.episema]||(w.match[rtg.episema]=x[3],w.episemaLoc=T),++C}}if(x[2]){var y=x[2].length;if(y>1){var w=e[e.length-1];w.match[rtg.dot]||(w.match[rtg.dot]=".")}}$.extend(v,x)}else v=new Array(regexToneModifiersCount);var S=p.index;if(p=p.splice(0,regexTonesSpliceIndex).concat(v.splice(1,v.length-1)).concat(p.splice(1,p.length-1)),p.index=S+l.index,!p[rtg.bracketed])if(p[rtg.clef]&&(d=p[rtg.clef],f="f"==d[0]?5:1,f+=2*parseInt(d.slice(-1))),tone=p[0],p[rtg.whitespace]){for(var C=0;C<transforms[0].length;++C)tone=tone.replace(transforms[2][C],transforms[1][C]);var _=make("tspan",tone);_.setAttribute("offset",p.index),_.setAttribute("len",p[0].length),t.appendChild(_),i=Math.max(i,/[`,]/.exec(p[rtg.whitespace])&&9.5||0),g.push(_=new ToneInfo({match:[]})),_.match[rtg.whitespace]=p[rtg.whitespace]}else{var k=parseInt(p[rtg.tone]||p[rtg.clef]&&p[rtg.clef].slice(0,1),23)-10;p[rtg.tone]&&1==p[rtg.tone].length?(a=Math.min(a,k),i=Math.max(i,k),null!=u||p[rtg.accidental]||(u=k)):i=Math.max(i,p[rtg.clef]&&2*parseInt(p[rtg.clef].slice(-1))+2||0),k>10?ledgerA.push(h-1):2>k&&ledgerB.push(h-1);var _=new ToneInfo({match:p,index:k,relativeTone:0>m?0:k-m,modifiers:p[rtg.noteType],clef:p[rtg.clef],episemaLoc:p[rtg.episema]&&p[rtg.episema].match(/0/)?-1:0,diamond:p[rtg.toneUpper]?!0:!1,markings:p[rtg.ictus]||p[rtg.dot]||p[rtg.episema],liq:p[rtg.diminutiveLiquescentia],accidental:p[rtg.accidental]});e.push(_),g.push(_),m=k}}for(var C=0;C<e.length;++C)C=r(C)}return o.appendChild(t),abcs[s]={ltone:a,htone:i,ftone:u,tones:g,startsWithAccidental:g.length>0&&g[0].match[rtg.accidental]?!0:!1,mask:c,clef:d,clefTone:f,mindy:n,ledgerA:ledgerA,ledgerB:ledgerB,def:t}};var r=function(r){var s=function(e,t,n){n||(n=t),-1==e?(l+=neume(indices.episema_below,t),a=Math.min(a,t-1)):(l+=neume(indices.episema_above,n),i=Math.max(i,n+1))},o=function(e,t){1==e?(l+=neume(indices.ictus_above,t),i=Math.max(i,t+1)):(l+=neume(indices.ictus_below,t),a=Math.min(a,t-1))},c=function(e){if(e&&l&&0!=l.length){var n=make("tspan",l);n.setAttribute("offset",e.match.index),n.setAttribute("len",e.match[0].length);for(var i=1;i<arguments.length;++i)n.setAttribute("len"+i,arguments[i].match[0].length);arguments.length>1&&n.setAttribute("count",arguments.length),t.appendChild(n),l=""}},l="",d=1,f=1,u="",h=e[r],g=e.length>r+1?e[r+1]:null,m=e.length>r+2?e[r+2]:null,p=e.length>r+3?e[r+3]:null,v=r>0?e[r-1]:null,x=indices.punctum;if(r>0&&0==h.relativeTone&&(l+="'"),h.diamond){x=h.liq?indices.diamond_tilde:indices.diamond;var b=Math.abs(h.relativeTone);v&&v.diamond&&2==b&&(l+="'"),g&&!g.diamond&&(u="-")}else{if(h.clef){var T=[n];return t.appendChild(makeClefSpan(h,T)),n=T[0],r}if(h.modifiers){if(h.match[rtg.accidental]){0==r&&(startsWithAccidental=!0);var y=h.match[rtg.flat]?"flat":"natural";return l+=neume(indices[y],h.index)+"-",c(h),r}h.match[rtg.virga]?(x=indices.v,f=h.match[rtg.virga].length,u="'"):h.match[rtg.stropha]?(x=indices.s,f=h.match[rtg.stropha].length,u="'"):indices[h.modifiers[0]]&&(x=indices[h.modifiers[0]],g&&g.relativeTone>0&&g.relativeTone<=5&&"w"==h.modifiers&&(!m||m.relativeTone>=0)&&(l+=neume(x,h.index),h.match[rtg.ictus]&&o(-1,h.index),h.match[rtg.episema]&&s(-1,h.index),c(h),g.relativeTone>1&&(l+=neume(indices.connecting_line,h.index,g.index)),++r,x=indices.topPartPodatus,h=g,h.episemaLoc=1))}else if(g&&!g.diamond&&(!g.modifiers||g.liq))if(g.relativeTone>0&&g.relativeTone<=5){if(m&&!m.diamond&&(!m.modifiers||"~"==m.modifiers)&&m.relativeTone<0&&m.relativeTone>=-4)if(x=indices.punctum,!m.modifiers&&p&&p.relativeTone>=1&&p.relativeTone<=5)--r,h.episemaLoc=0,g.episemaLoc=0;else{l+=neume(x,h.index);var C=g.index,A=Math.min(h.index,m.index);h.match[rtg.episema]&&s(h.episemaLoc,A,C),h.match[rtg.ictus]&&(o(h.episemaLoc,h.index),h.match[rtg.ictus]=void 0),c(h),g.relativeTone>1&&(l+=neume(indices.connecting_line,h.index,g.index)),"~"==m.modifiers?(--r,x=void 0):(l+=neume(x,g.index),g.match[rtg.episema]&&s(h.episemaLoc,A,C),g.match[rtg.ictus]&&(o(g.episemaLoc,g.index),g.match[rtg.ictus]=void 0),c(g),m.relativeTone<-1&&(l+=neume(indices.connecting_line,m.index,g.index)),h=m,m.match[rtg.episema]&&(h.episemaTone=-1==m.episemaLoc?A:C),"~"==m.modifiers&&(x=indices.lower_tilde),d=3,++r)}else if(g.relativeTone<=5){h.episemaLoc=-1,g.episemaLoc=1,x=indices.topPartPodatus,d=2,m&&m.relativeTone<=0&&(u="-"),g.liq?(l+=neume(indices["<"],h.index),x=indices.upper_tilde):l+=neume(indices.bottomPartPodatus,h.index),c(h),g.relativeTone>1&&(l+=neume(indices.connecting_line,h.index,g.index));var w=h;h=g,g=w}++r}else if(g.relativeTone<0&&g.relativeTone>=-5){if(!h.markings&&m&&!m.diamond&&(!m.modifiers||"~"==m.modifiers)&&m.relativeTone>=1&&m.relativeTone<=4&&g.relativeTone>=-4){if(h.relativeTone>=2&&h.relativeTone<=5)l+=neume(indices.connecting_line,h.index-h.relativeTone,h.index);else if(h.relativeTone<1){var S=Math.max(-g.relativeTone,1);l+=(t.childNodes.length>0?"-":"")+neume(indices.decorative_line,h.index-S,h.index)}"~"==m.modifiers?(--r,l+=neume(x,h.index),c(h),l+=neume(indices.connecting_line,g.index,h.index),x=void 0):(l+=neume(indices.porrectus,h.index,g.index),c(h,g),l+=neume(indices.decorative_line,g.index,m.index),g.episemaLoc=-1,!p||p.relativeTone>=0||p.relativeTone<-5?(x=indices.topPartPodatus,m.episeamLoc=1,h=m,d=3,++r):(x=void 0,m.connectingLine=!0,d=2))}else{if(d=2,g.liq){var S=Math.min(-g.relativeTone,2);l+=neume(indices.decorative_line,h.index-S,h.index),l+=neume(indices[">"],h.index),c(h),x=indices.lower_tilde}else h.relativeTone>0&&h.relativeTone<=5&&("w"==v.modifiers||h.connectingLine)?h.relativeTone>1&&(l+=neume(indices.connecting_line,v.index,h.index)):l+=neume(indices.decorative_line,g.index,h.index),l+=neume(indices.punctum,h.index),h.match[rtg.episema]&&(s(h.episemaLoc,g.index,h.index),d=1),h.match[rtg.ictus]&&(o(h.episemaLoc,h.index),h.match[rtg.ictus]=void 0),g.match[rtg.episema]&&(w=-1==g.episemaLoc?A:C,h.episemaTone=1,-1!=g.episemaLoc&&(g.episemaTone=h.index)),h.match[rtg.dot]&&(g.match[rtg.dot]?1==g.match[rtg.dot].length&&(g.match[rtg.dot]=".."):(l+=neume(indices.dot,h.index),d=1)),c(h);g.relativeTone<-1&&(l+=neume(indices.connecting_line,g.index,h.index));var w=h;h=g,g=w}++r}}var w=neume(x,h.index);if(f>1&&(w=(w+"'").repeat(f).slice(0,-1)),l+=w,h.match[rtg.ictus]&&o(h.episemaLoc,h.index),h.match[rtg.episema]){var w=h.episemaTone||h.index;s(h.episemaLoc,w)}d>1&&(g.match[rtg.ictus]&&o(g.episemaLoc,g.index),g.match[rtg.episema]&&!h.episemaTone&&s(g.episemaLoc,g.index));var _,$;d>1&&(_=Math.min(g.index,h.index),$=Math.max(g.index,h.index),($-_>=2||0==_%2)&&(_=void 0));var w=h.match[rtg.dot];return w?(l+=h.index==_?neume(indices.dot,_-1):neume(indices.dot,h.index),w=w.length):w=0,g&&(w>1||d>1&&(w=g.match[rtg.dot]))&&(l+=g.index==_?neume(indices.dot,_-1):neume(indices.dot,g.index)),w&&e[r+1]&&(u+="--"),l+=u,x&&c(h),r}}();var gradients={},playTone=function(){console.warn("Audiolet library not loaded.")},playScore=playTone,stopScore=playTone,baseFreq=370;$(function(){var t=function(){try{var e=new Audiolet,t=function(t,n){AudioletGroup.apply(this,[e,0,1]),this.sine=new Sine(e,t),this.gain=new Gain(e),this.env=new PercussiveEnvelope(e,1,.3,.3*(n||1),function(){this.audiolet.scheduler.addRelative(0,this.remove.bind(this))}.bind(this)),this.envMulAdd=new Multiply(e,.2,0),this.sine.connect(this.gain),this.gain.connect(this.outputs[0]),this.env.connect(this.envMulAdd),this.envMulAdd.connect(this.gain,0,1)};extend(t,AudioletGroup);var n=function(n,i){var a=new t(n,i);a.connect(e.output)},i={0:0,1:2,2:4,3:5,4:7,5:9,6:11};playTone=function(e,t,a){var r=baseFreq;for(t=e==t;0>e;)e+=7,r/=2;for(;e>=7;)e-=7,r*=2;e>0&&(r*=Math.pow(2,(i[e]-(t?1:0))/12)),n(r,a)};var a=!1;tempo=150;var r;playScore=function(t){for(var n=t?0:selectedPunctum||0;r&&r.next(););r=new PSequence(_tones,1,n),a=!0,e.scheduler.setTempo(tempo),e.scheduler.play([r],1,function(t){for(var i;!(a=a&&n<_tones.length)||!(i=t.play(n));)if(++n,!(t=r.next()))return y(-1),a=!1,void 0;y(n,!0),i&&e.scheduler.setTempo(tempo/i),++n})},stopScore=function(){a=!1}}catch(s){console.warn(s)}},n=function(){if("function"==typeof Audiolet)try{t()}catch(e){}else $.getScript("audiolet.js",t)};"function"==typeof Sink?n():$.getScript("sink.js",n),0==$("link[href=style\\.css]").length&&$(document.head).append($('<link rel="stylesheet" type="text/css" href="style.css">'));var i=$("#tbl");if(i)for(var a=57568;65535>a;a+=16){var r=document.createElement("row"),s=document.createElement("td"),o=document.createElement("td");s.innerText="0x"+a.toString(16);for(var c="",l=0;16>l;++l)c+=String.fromCharCode(a+l)+"_";o.innerText=c,o.className="caeciliae",r.appendChild(s),r.appendChild(o),i.append(r)}if("function"==typeof document.createElementNS){_svg=svg=document.createElementNS(svgns,"svg"),svg.setAttribute("style","width:100%;height:0"),setPrintFont=function(e){$(svg).find(".caeciliae,.caeciliae-print").attr("class",e?"caeciliae-print":"caeciliae")},_defs=document.createElementNS(svgns,"defs"),defText=make("text",""),defText.setAttribute("class","goudy"),_defs.appendChild(defText),_defText=make("text",""),_defText.setAttribute("class","goudy"),_defs.appendChild(_defText),defChant=make("text","p"),defChant.setAttribute("class","caeciliae"),_defs.appendChild(defChant),defChantSvg=make("text","p"),defChantSvg.setAttribute("class","caeciliaeSvg"),_defs.appendChild(defChantSvg);var d=make("linearGradient");d.setAttribute("gradientUnits","objectBoundingBox"),d.setAttribute("id","gradRedBlack");var f=make("stop");f.setAttribute("offset","0"),f.setAttribute("stop-color","#e22"),d.appendChild(f),f=make("stop"),f.setAttribute("offset","100"),f.setAttribute("stop-color","#000"),d.appendChild(f),gradients.RedBlack=d,d=make("linearGradient"),d.setAttribute("gradientUnits","objectBoundingBox"),d.setAttribute("id","gradBlackRed");var f=make("stop");f.setAttribute("offset","0"),f.setAttribute("stop-color","#000"),d.appendChild(f),f=make("stop"),f.setAttribute("offset","100"),f.setAttribute("stop-color","#e22"),d.appendChild(f),gradients.BlackRed=d;var u;if(staffInFont)u=document.createElementNS(svgns,"text"),u.textContent="'",u.setAttribute("transform","scale(0.5,1)");else{u=document.createElementNS(svgns,"g");var h=1,g=document.createElementNS(svgns,"path"),m="h1v"+h+"h-1zm0 -"+spaceheight;g.setAttribute("d","M0 0"+m.repeat(4)),u.appendChild(g);var p=document.createElementNS(svgns,"g");g=document.createElementNS(svgns,"path"),g.setAttribute("d","M0 "+spaceheight+m),p.appendChild(g),p.setAttribute("id","ledgerb"),_defs.appendChild(p),p=document.createElementNS(svgns,"g"),g=document.createElementNS(svgns,"path"),g.setAttribute("d","M0 "+4*-spaceheight+m),p.appendChild(g),p.setAttribute("id","ledgera"),_defs.appendChild(p)}u.setAttribute("id","staff"),_defs.appendChild(u),svg.appendChild(_defs),textElem=document.createElementNS(svgns,"g"),textElem.setAttribute("transform","translate(0,"+staffoffset+")"),textElem.setAttribute("class","caeciliae"),svg.appendChild(textElem);var v=$("#chant-preview");if(0==v.length)$(document.body).append(svg);else{v.append(svg),lastClefBeforeNeume=function(e){var t,n={clefTone:9};for(t in _clefs){if(!(e>t))break;n=_clefs[t]}return n},lastClefBeforePunctum=function(e){var t,n={clefTone:9};for(t in _clefs)try{var i=parseInt($(svg).find("#neume"+t).children()[0].id.match(/\d+$/)[0]);if(!(e>i))break;n=_clefs[t].info}catch(a){}return n};var x=function(e){var t,n=null;for(t in _accidentals){if(!(e>=t))break;n=_accidentals[t]}return n};ToneInfo.prototype.play=function(e){var t=lastClefBeforePunctum(e).clefTone,n=this.match&&(this.match[rtg.dot]||this.match[rtg.episema])?2:1;if(1==n){var i=$("#punctum"+(1+e));i.length&&(i=i[0].tone,i&&i.match[rtg.quilisma]&&(n=2))}return this.clef||this.accidental||"number"!=typeof this.index?!1:(playTone(this.index-t,x(e),n),n)};var b=function(t){var n=selectedPunctumTag;if(n){var i=n.parentNode,a=selectedPunctum-/^punctum(\d+)$/.exec(i.childNodes[0].id)[1],r=i.neume,s=r.info.tones[a];if(s&&s.match){var o,c,l=s.match[rtg.tone];if(l){var d=s.index+t;if(0>d?d=0:d>12&&(d=12),t=d-s.index,0==t)return;o=String.fromCharCode(l.charCodeAt(0)+t)}else{c=s.match[rtg.clef],l=parseInt(c.slice(-1));var o=l+t;if(1>o?o=1:o>4&&(o=4),t=o-l,0==t)return;c=c.slice(0,-1)+o}e=$("#editor");var f=e.val(),u=getHeaderLen(f);u+=r.index;var h=f.slice(0,u);f=f.slice(u),u=T(!0);var g=u+s.match[0].length,m=f.slice(0,u);m+=f.slice(u,g).replace(l,o),u=r.gabc.length,m+=f.slice(g,u),f=h+m+f.slice(u),r.gabc=m;var p=r.info,v=r.info=getChantFragment(m,$(svg).find("defs")[0]);if(c)for(k in _clefs[selectedNeume].clefs){var x=_clefs[selectedNeume].clefs[k];x.setAttributeNS(xlinkns,"href","#"+c)}stopScore(),v.tones[a].play(selectedPunctum);var b=$(v.def).clone()[0];b.neume=r,b.setAttribute("id",i.id),b.setAttribute("x",i.getAttribute("x")),b.setAttribute("y",i.getAttribute("y")),b.setAttribute("transform",i.getAttribute("transform")),$(i).replaceWith(b),r.wChant=useWidth(b),processLedger(r,b),relayoutChant(svg),0==a&&r.custos&&addCustos(r.custos.parentNode,r);var y=b.parentNode,C=y.info.htone,A=y.info.ltone;p.htone<=r.info.htone?y.info.htone=Math.max(y.info.htone,r.info.htone):(y.info.htone=10,$(y).find("[id^=neume]").each(function(){y.info.htone=Math.max(y.info.htone,this.neume.info.htone)})),p.ltone>=r.info.ltone?y.info.ltone=Math.min(y.info.ltone,r.info.ltone):(y.info.ltone=3,$(y).find("[id^=neume]").each(function(){y.info.ltone=Math.min(y.info.ltone,this.neume.info.ltone)}));var w=$(y.parentNode).children("#system0")[0].info.y;if(c||C!=y.info.htone||A!=y.info.ltone)for(var S=finishStaff(y),_=staffoffset+S+verticalSpace+y.info.y,k=parseInt(y.id.match(/\d+$/)[0])+1;y=$(y).siblings("#system"+k)[0];)y.info.y=_,S=finishStaff(y),_=staffoffset+S+verticalSpace+y.info.y,++k;svg.setAttribute("height",$(svg).children("g")[0].getBBox().height+w+_heightCorrection-_defText.getExtentOfChar("q").height),a=selectedPunctum-a,selectedPunctumTag=null,a=setUpPunctaIn(b,a),selectedNeumeTag=b,e.val(f)}}},T=function(e){if(null!=selectedPunctum&&selectedPunctumTag){var t=selectedPunctumTag,n=selectedPunctum-t.id.match(/^punctum(\d+)$/)[1],i=t.parentNode,a=parseInt(t.getAttribute("offset"))||0,r=parseInt(t.getAttribute("len"))||3;return n&&(a+=r,r=parseInt(t.getAttribute("len1"))),e?a:(selectGabc(i.neume.index+a,r),void 0)}},y=function(e,t){if(e=parseInt(e),0>e&&(e=-1),e!=selectedPunctum){var n,i=0;if(0>e)t=!0,n=$();else if(n=$(svg).find("#punctum"+e),0==n.length&&(i=1,--e,n=$(svg).find("#punctum"+e),0==n.length||2!=n.attr("count")))return selectedPunctumTag=null,void 0;selectedPunctum=e+i,selectedPunctumTag=n[0];var a=n.parent().attr("id");if(a&&(a=/neume(\d+)/i.exec(a)),selectedNeume=a?parseInt(a[1]):-1,selectedNeumeTag=selectedPunctumTag&&selectedPunctumTag.parentNode,$(svg).find(".selectable").attr({"class":"selectable",style:""}),n.attr("class","selectable selected"+(2==n.attr("count")?"-"+(1+i):"")),2==n.attr("count")&&setGradient(n[0],i),!t){stopScore();var r=selectedPunctum-/^punctum(\d+)$/.exec(selectedNeumeTag.childNodes[0].id)[1];selectedNeumeTag.neume.info.tones[r].play(selectedPunctum)}}},C=function(e){var t=$(svg).find("#neume"+e+">tspan");punctumToSelect=/punctum(\d+)/i.exec(t.attr("id")),punctumToSelect&&y(parseInt(punctumToSelect[1]))};$(document).on("click","tspan.selectable[id^=punctum]",function(){y(/punctum(\d+)/i.exec(this.id)[1])}).on("click","tspan.selectable[id^=neumetext]",function(){var e=parseInt(this.getAttribute("selectIndex"));e>=0&&selectGabc(e,-1)});var A=function(e){if(e.target.tagName.match(/textarea|input|select/i))return y(-1),void 0;var t=selectedPunctum;if(e.ctrlKey){var n=selectedNeume;switch(e.which){case 37:--n;break;case 39:++n;break;case 38:return b(2),e.preventDefault(),void 0;case 40:return b(-2),e.preventDefault(),void 0;case 13:return M(),void 0;case 32:return playScore(),void 0;default:return}C(n)}else{switch(e.which){case 37:--t;break;case 39:++t;break;case 38:return b(1),e.preventDefault(),void 0;case 40:return b(-1),e.preventDefault(),void 0;case 13:return T(),e.preventDefault(),void 0;case 32:return playScore(!0),e.preventDefault(),void 0;case 27:return stopScore(),void 0;default:return console.info(e.which),void 0}y(t)}};$(document).keydown(A)}var w=[],S=0,_=0;window.updateGabc=updateGabc=function(){var e=$(".jgabc:visible");e.each(function(e,t){var n=$(t),i=n.clone().toggleClass("jgabc jgabc-svg").text("");n.hide(),$(svg).clone().appendTo(i),n.after(i);var a=n.attr("src");a&&(W=200,++S,$.get(a,function(e){n.html(e),++_==S&&(W=0,G(),N(0,!0,!0))}))}),w=$(".jgabc"),setTimeout(G,100)};var k=null,L=null,N=function(e,t,n){if(M(),k&&clearTimeout(k),!t){var i=500;return k=setTimeout(function(){N(null,!0)},i),void 0}k=null,$.each(w,function(e,t){var i=$(t).next(".jgabc-svg").find("svg")[0];i&&(t.innerHTML.match(/^\s*$/)||n&&t.hasSvg||(updateChant(t.innerHTML,i,!0),t.hasSvg=!0))})},I=function(e){if(L&&clearTimeout(L),!e){var t=500;return L=setTimeout(function(){I(!0)},t),void 0}L=null;try{relayoutChant(svg)}catch(n){}$.each(w,function(e,t){var n=$(t).next(".jgabc-svg").find("svg")[0];n&&relayoutChant(n)}),$.each(otherElements,function(e,t){var n=$(t),i=n.is("svg")?n[0]:n.find("svg")[0];i&&(relayoutChant(i),n.trigger("relayout"))})};updateAllChantWidth=navigator.userAgent.match(/\bChrome\b/)?function(){I(!0)}:function(){I()};var M=function(){updateChant($("#editor").val(),svg)};forceUpdateChant=function(){updateChant($("#editor").val(),svg,!0)};var O=function(e){return e.stopPropagation(),e.preventDefault(),!1},E=function(e){return e?(e^16*Math.random()>>e/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,E)},P=function(e){e.stopPropagation(),e.preventDefault();var t,n=$(this),i=e.originalEvent.dataTransfer.files.length,a=uuid&&uuid.v4?uuid.v4():E();for(t=0;i>t;++t){var r=e.originalEvent.dataTransfer.files[t],s=new FileReader;s.onload=function(e){var t=processDraggedFile(e.target.result);1==i&&n.val(t).keyup(),"function"==typeof processGabc&&processGabc(t,a,i)},s.readAsText(r)}};$("#editor").keyup(M).bind("dragover",O).bind("drop",P),$(window).resize(updateAllChantWidth);var B=0,F=0,W=0,G=function(){if(svg)if(svg.parentNode&&0==svg.parentNode.clientWidth)setTimeout(G,100);else{B=textWidth("abcdefghijklmnopqrstuvwxyz",fontclass,!0);var e=getChantWidth("4q5P"),t=getChantWidth("P");notewidth=getChantWidth("p"),e==t?(neume=_neumeLig,indices=_indicesLig,makeClefSpan=_clefSpanLig):(neume=_neumeChar,indices=_indicesChar,makeClefSpan=_clefSpanChar),B!=F&&(_txtWidths={},F=B,forceUpdateChant(),N()),++W<100&&setTimeout(G,300)}};setTimeout(G,100)}});var processDraggedFile=function(e){return e};window.updateChant=updateChant;var neume=_neumeChar,indices=_indicesChar,makeClefSpan=_clefSpanChar,internationalTextBoxKeyDown=function(){var e={222:{"false":{a:"á",e:"é",i:"í",o:"ó",u:"ú",y:"ý",A:"Á",E:"É",I:"Í",O:"Ó",U:"Ú",Y:"Ý","æ":"ǽ","œ":"oé","Æ":"Ǽ","Œ":"Oé"},"true":{a:"ä",e:"ë",i:"ï",o:"ö",u:"ü",y:"ÿ",A:"Ä",E:"Ë",I:"Ï",O:"Ö",U:"Ü","æ":"aë","œ":"oë","Æ":"Aë","Œ":"Oë"}},69:{"false":{a:"æ",o:"œ",A:"Æ",O:"Œ"},"true":{a:"æ",o:"œ",A:"Æ",O:"Œ"}},8:{"false":{"†":"+","æ":"ae","œ":"oe","Æ":"Ae","Œ":"Oe","á":"a","é":"e","í":"i","ó":"o","ú":"u","ý":"y","Á":"A","É":"E","Í":"I","Ó":"O","Ú":"U","Ý":"Y","ä":"a","ë":"e","ï":"i","ö":"o","ü":"u","ÿ":"y","Ä":"A","Ë":"E","Ï":"I","Ö":"O","Ü":"U","Ǽ":"Aé","ǽ":"aé"},"true":{}}};return function(t){if("function"==typeof getHeaderLen&&getHeaderLen(this.value)>0){var n=this.value.lastIndexOf("(",this.selectionStart-1),i=this.value.lastIndexOf(")",this.selectionStart-1);if(n>i)return}if(187==t.which&&t.shiftKey){var a=this.selectionEnd,r=1;return this.value=this.value.slice(0,this.selectionStart)+"†"+this.value.slice(a),this.selectionStart=this.selectionEnd=a+r,t.preventDefault(),void 0}var s=$("#cbEnglish")[0];if(!s||!s.checked){var o=e[t.which];if(o&&this.selectionStart==this.selectionEnd&&this.selectionStart>0){var c=this.value[this.selectionStart-1],l=o[t.shiftKey][c];if(l){var a=this.selectionEnd,r=l.length-1;return this.value=this.value.slice(0,--this.selectionStart)+l+this.value.slice(a),this.selectionStart=this.selectionEnd=a+r,t.preventDefault(),void 0}}}}}();
=======
String.prototype.repeat=function(b){return new Array(b+1).join(this)};if(!String.prototype.trimRight){String.prototype.trimRight=function(){return this.replace(/\s+$/,"")}}var gabcSettings={trimStaff:true};var uuid;var _indicesChar={flat:[57585,58176,57586,58177,57587,58178,57588,58179,57589,58180,57590,58181,57591],natural:[57593,58182,57594,58183,57595,58184,57596,58185,57597,58186,57598,58187,57599],flat_line:58176,natural_line:58182,punctum:57603,diamond:57619,virga:57635,v:57635,leftVirga:57651,quilisma:57667,w:57667,bottomPartPodatus:57684,topPartPodatus:57699,podatus:[null,57715,57731,57748,57763],o:57779,O:57795,diamond_tilde:57811,">":57827,"<":57843,upper_tilde:57859,lower_tilde:57875,porrectus:[null,57891,57907,57923,57939],r:57971,s:57987,custos:58019,"+":58019,dot:58035,apos:58050,ictus:58050,ictus_above:58053,ictus_below:58050,underscore:58066,episema:58066,episema_below:58066,episema_above:58069,underscore_longer:58082,episema_longer:58082,clivis:[null,58115,58131,58147,58163],accent_above_staff:58188,connecting_line:[undefined,undefined,59139,59155,59171,59187],decorative_line:[undefined,59203,59219,59235,59251,59267]};var vCodes={Abar:"a",Vbar:"v",Rbar:"r"};var _indicesLig={flat:"b",natural:"a",punctum:"p",diamond:"n",virga:"v",v:"v",leftVirga:"c",quilisma:"q",w:"q",podatus:"P",bottomPartPodatus:57684,topPartPodatus:"P",o:"o",O:"O",diamond_tilde:"N",">":"L","<":"k",upper_tilde:"K",lower_tilde:"l",porrectus:"R",r:"w",s:"s",custos:"u","+":"u",dot:".",apos:"I",ictus:"I",ictus_above:"I",ictus_below:"i",underscore:"H",episema:"H",episema_above:"H",episema_below:"h",underscore_longer:58082,episema_longer:58082,clivis:"C",accent_above_staff:"~",connecting_line:"x",decorative_line:"X"};var fontclass="goudy";var _neumeLig=function(f,d){if(arguments.length<2){return""}if(typeof(f)!=="string"){if(arguments.length==2&&typeof(f)=="number"){return _neumeChar(f,d)}return""}var c="";var g=1;while(g<arguments.length){c+=_ci[arguments[g++]]}return c+f};var _neumeChar=function(d,c){if(arguments.length<2){return""}var f=d;var d,c;d=parseInt(c);c=0;if(typeof(f)=="object"){if(arguments.length>2){c=parseInt(arguments[2])}f=f[Math.abs(c-d)];if(arguments.length==2){d=0}}return String.fromCharCode(f+d)};var _clefSpanLig=function(f){var c=parseInt(f.clef.slice(-1),10);var d=c*2-1;var b="";if(f.clef.length==3){b+=neume(indices.flat,d+1)+"-"}return make("tspan",String(d)+(f.index==2?"d":"f")+"-"+b)};var _clefSpanChar=function(h,f){var b,d=parseInt(h.clef.slice(-1),10),c=0,g;if(h.index==2){g="d-";c=2-d}else{g="f-";c=3-d}if(h.clef.length==3){g+=neume(indices.flat,4)+"-"}c*=spaceheight;f[0]=Math.min(f[0],c);b=make("tspan",g);b.setAttribute("dy",c);return b};var _ci=["B","A","0","1","2","3","4","5","6","7","8","9","Z"];var staffheight=48;var spaceheight=staffheight/4;var notewidth=staffheight/6;var spaceBetweenNeumes=notewidth;var slashSpace=staffheight/20;var verticalSpace=staffheight/4;var fontsize=spaceheight*3/2;var spaceWidth=spaceheight*3/4;var staffoffset=Math.ceil(staffheight-spaceheight/2);var svgns="http://www.w3.org/2000/svg";var xlinkns="http://www.w3.org/1999/xlink";var staffInFont=false;var fontExt="ttf";var fontExtS="svg#webfont";var fontFormat="truetype";var fontFormatS="svg";var filenameCaeciliae="Caeciliae-"+(staffInFont?"Regular.":"Staffless.")+fontExt;var filenameCaeciliaeS="Caeciliae-"+(staffInFont?"Regular.":"Staffless.")+fontExtS;var filenameCaeciliaePrint="Caeciliae-"+(staffInFont?"Regular":"Staffless")+"-Print."+fontExt;var localCaeciliae="Caeciliae"+(staffInFont?"":" Staffless");var familyCaeciliae="Caeciliae"+(staffInFont?"":" Staffless");var styleCaeciliae="font-family: '"+familyCaeciliae+"'; font-size:"+staffheight+"px;";var styleCaeciliaeSvg="font-family: '"+familyCaeciliae+" SVG'; font-size:"+staffheight+"px;";var styleGoudy="font-family: 'OFL Sorts Mill Goudy TT'; font-size: "+fontsize+"px;";var styleFont="@font-face {font-family: '"+familyCaeciliae+"'; font-weight: normal; font-style: normal;src: local('"+localCaeciliae+"'); src: url('"+filenameCaeciliae+"') format('"+fontFormat+"')}@font-face {font-family: '"+familyCaeciliae+" SVG'; font-weight: normal; font-style: normal;src: url('"+filenameCaeciliaeS+"') format('"+fontFormatS+"')}@font-face {font-family: '"+familyCaeciliae+" Print'; font-weight: normal; font-style: normal;src: url('"+filenameCaeciliaePrint+"') format('"+fontFormat+"')}@font-face {font-family: 'OFL Sorts Mill Goudy TT'; font-style: italic; font-weight: normal; src: local('OFL Sorts Mill Goudy Italic TT'), local('OFLGoudyStMTT-Italic'), url('OFLGoudyStMTT-Italic.ttf') format('truetype');}@font-face {font-family: 'OFL Sorts Mill Goudy TT'; font-style: normal; font-weight: normal; src: local('OFL Sorts Mill Goudy TT'), local('OFLGoudyStMTT'), url('OFLGoudyStMTT.ttf') format('truetype');}";var svgWidth;var _svg,svg;var textElem;var codea="a".charCodeAt(0);var codem=codea+12;var codeA="A".charCodeAt(0);var codeM=codeA+12;var regexTranslate=/translate\((-?\d+(?:\.\d+)?)(?:[,\s]\s*(-?\d+(?:.\d+)?))?\)/;var regexTranslateG=/translate\((-?\d+(?:\.\d+)?)(?:[,\s]\s*(-?\d+(?:.\d+)?))?\)/g;var regexHeaderEnd=/(?:^|\n)%%\s?\n/;var regexOuter=/((([^\(\r\n]+)($|\())|\()([^\)]*)($|\))(?:(\s+)|(?=(?:\([^\)]*\))+(\s*))|)/g;var regexTag=/<(\/)?(b|i|sc|v)>/i;var regexSqBrackets=/\[([^\]]*)(?:\]|$)/;var regexTags=/(<(b|i|sc)>)(.*?)(?:(<\/\1>)|$)/i;var regexTagsSp=/<sp>([^<]*)<\/sp>/gi;var spSubstitutions={"'ae":"ǽ","'æ":"ǽ",ae:"æ",oe:"œ","'œ":"œ","'oe":"œ",AE:"Æ",OE:"Œ",Ae:"Æ",Oe:"Œ","V/":"V","R/":"R","A/":"A"};String.prototype.replaceSpTags=function(){return this.replace(regexTagsSp,function(c){var b=c.slice(4,-5);return spSubstitutions[b]||b})};var regexInner=/(?:[!\/ ,;:`]+|[^\)!\/ ,;:`\[]+)|(\[[^\]]*(?:$|\]))/g;var rog={syl:3,gabc:5,whitespace:7};var linkSelector="";var linkDownloadSelector="";var setPdfLinkSelector=function(b){linkSelector=b};var onDragStart=function(b){console.info(b);b.originalEvent.dataTransfer.setData("DownloadURL",this.getAttribute("data-downloadurl"))};var setGabcLinkSelector=function(b){linkDownloadSelector=b;$(b).bind("dragstart",onDragStart)};var regexToneModifiers=/(')|(\.{1,2})|(_{1,4}0?)/g;var regexTones=new RegExp("([/ ,;:`]+)|((?:[fF]|[cC][bB]?)[1-4])|(?:(-)?(([A-M])|([a-m]))(([Vv]{1,3})|(s{1,3})|((<)|(>)|(~))|(w)|(o)|(O)|((x)|(y))|(q)|((R)|(r0)|(r(?![1-5])))|(r[1-5])|(\\+))?((?:"+String(regexToneModifiers).replace(/^\/|\/\w*$/g,"").replace(/\((?!\?:)/g,"(?:")+")*)|(z0))|\\[([^\\]]*)(?:\\]|$)","g");var regexTonesSpliceIndex=27;var regexToneModifiersCount=4;var rtg={whitespace:1,clef:2,initioDebilis:3,tone:4,toneUpper:5,toneLower:6,noteType:7,virga:8,stropha:9,liquescentia:10,ascendingLiquescentia:11,descendingLiquescentia:12,diminutiveLiquescentia:13,quilisma:14,oriscus:15,oriscusReverse:16,accidental:17,flat:18,natural:19,q:20,lineaPunctum:22,lineaPunctumCavum:23,punctumCavum:24,rNumber:25,custos:26,ictus:27,dot:28,episema:29,custos:30,bracketed:31};var regexVowel=/(?:[cgq]u|[iy])?([aeiouyáéëíóúýǽæœ]+)/i;var transforms=[["/"," ",",",";",":","`",""],["'","_","+",";","|",",",""],[/\//g,/ /g,/,/g,/;/g,/:/g,/`/g,/!/g]];var abcs={};var _defs=null;var defText=null;var _defText=null;var defChant=null;var masks=[];var selectedPunctum=-1;var selectedNeume=-1;var selectedPunctumTag=null;var selectedNeumeTag=null;var _timeoutGabcUpdate=null;var _minUpdateInterval=1700;var _heightCorrection=0;var _clefs=[];var _accidentals=[];var _tones=[];var utf8_bom=String.fromCharCode(239)+String.fromCharCode(187)+String.fromCharCode(191);function encode_utf8(b){return utf8_bom+unescape(encodeURIComponent(b))}function decode_utf8(b){return decodeURIComponent(escape(b))}function Header(h){if(typeof(h)!="string"){h=""}this.comments=[];this.cValues={};this.original="";var f=h.match(regexHeaderEnd);if(f){var d=this.original=h.slice(0,f.index+f[0].length);var c=d.split(/\r?\n/g);for(i in c){var b=c[i],f=regexHeaderLine.exec(b);if(f){if(this[f[1]]){var g=f[1]+"Array";if(!this[g]){this[g]=[this[f[1]]]}this[g].push(f[2])}else{this[f[1]]=f[2]}}else{if((f=regexHeaderComment.exec(b))){if(b!="%%"){f=regexHeaderLine.exec(b.slice(1));if(f){this.cValues[f[1]]=f[2]}else{this.comments[i]=b}}}}}}}Header.prototype.toString=function(){var b=[];for(key in this){if(key=="length"||key=="original"||key=="comments"||key=="cValues"||(typeof this[key])!="string"){continue}var d=this[key+"Array"];if(d){for(i in d){b.push(key+": "+d[i]+";")}}else{b.push(key+": "+this[key]+";")}}for(key in this.cValues){if(key.length==0){continue}b.push("%"+key+": "+this.cValues[key]+";")}for(i in this.comments){try{b.splice(i,0,this.comments[i])}catch(c){}}return b.join("\n")+"\n%%\n"};function getHeaderLen(c){var b=c.match(regexHeaderEnd);if(b){return b.index+b[0].length}else{return 0}}var regexHeaderLine=/^([\w-_]+):\s*([^;\r\n]*)(?:;|$)/i;var regexHeaderComment=/^%.*/;function getHeader(b){return new Header(b)}function updateLinks(g){var h=getHeader(g);if(h){g=g.slice(h.original.length)}else{h="%%\n"}if(linkSelector){$(linkSelector).attr("href","http://gregorio.gabrielmass.com/cgi/process.pl?gregtext="+window.escape(h+g)+"&gregfontselect=17&gregtextfontselect=12&greginitialselect=43&gregspaceselect=7mm&gregredselect=N&greglinethickselect=10&gregpaperselect=letterpaper&gregfaceselect=libertine&gregcropselect=N")}try{if(linkDownloadSelector){var d=encode_utf8(h+g);var c="data:text/plain;charset=utf8;base64,"+btoa(d);var b=h.name||"Untitled";if(!b.match(/\.gabc$/)){b+=".gabc"}$(linkDownloadSelector).attr("charset","UTF-8").attr("href",c).attr("data-downloadurl","text/plain:"+b+":"+c)}}catch(f){}return[h,g]}var gabcProcessTime=0;var _nextUpdate=new Date().getTime();var dontUpdateChant=false;var otherElements=[];function updateChant(p,h,k){var f=h;var b=$(h);if(!b.is("svg")){b=b.find("svg");if(!b.length){b=$(_svg).clone().appendTo(h)}h=b[0]}if(h!=_svg&&otherElements.indexOf(h)<0&&f){otherElements.push(f)}if(dontUpdateChant||!p){return}var q=updateLinks(p);if(_timeoutGabcUpdate){clearTimeout(_timeoutGabcUpdate)}if(!k){var g=gabcProcessTime+100;_timeoutGabcUpdate=setTimeout(function(){updateChant(p,h,true)},g);return}_nextUpdate=new Date().getTime()+100+gabcProcessTime;var c=new Date();p=q;_timeoutGabcUpdate=null;var d=$(h).find(">g")[0];if(!d){return}var l=[0];var n=getChant(p,h,d,l);var o=n.getBBox().height+l[0]+_heightCorrection-_defText.getExtentOfChar("q").height;$(h).height(o);if(h.parentNode.tagName.match(/span/i)){$(h).css("width",n.getBBox().width)}gabcProcessTime=new Date()-c;console.info("Update chant time: "+gabcProcessTime);if(gabcProcessTime>3000){gabcProcessTime=3000}}function make(c,f,d){var b=document.createElementNS(svgns,c);if(f){b.appendChild(document.createTextNode(f))}if(d){switch(typeof(d)){case"string":b.setAttribute("class",d);break;case"object":for(a in d){b.setAttribute(a,d[a])}break}}return b}var _txtWidths={};function textWidth(d,o,h){var c=0;var g=undefined;if(d.length===0){return 0}if(typeof(o)=="number"&&typeof(h)=="number"){c=o;g=h;o=h=undefined;if(g===0){return 0}}var b=h?_defText:defText;if($.isArray(d)){var f;var l;if(d.length==1&&d[0].tags.length==0){d=d[0].text;if(d.length==0){return 0}if(o==undefined){o=""}if(c==0&&!g&&(l=o+","+d)&&(f=_txtWidths[l])){return f}}else{if(c==0&&!g&&(l=JSON.stringify(d))&&(f=_txtWidths[l])){return f}$(b).empty();var p=0;var k=0;d.forEach(function(v){var t=v.span();b.appendChild(t);var u=Math.max(c,k);var q=t.textContent.length;var s=Math.min(k+q,c+(g||1000000))-u;u-=k;k+=q;try{if(s>0&&u>=0){p+=t.getSubStringLength(u,s)}}catch(r){console.warn(r)}});if(l){_txtWidths[l]=p||b.getComputedTextLength()}return p}}else{if(typeof(d)=="object"){if(d.childNodes.length==1){var n=d.firstChild;var l=$(n).attr("class").replace(new RegExp("(?:^|\\s)"+fontclass+"(?:\\s|$)|\\s+$","g"),"")+","+n.textContent;var f=_txtWidths[l];if(f){return f}}$(b).empty().append($(d).clone());var p=b.getComputedTextLength();if(l){_txtWidths[l]=p}return p}}if(o){b.setAttribute("class",o)}$(b).text(d.replace(/ /g,"\u00a0"));var p=b.getSubStringLength(c,g||d.length);if(l){_txtWidths[l]=p}return p;return p}function useWidth(b,k,h){if(b.tagName.match(/^use$/i)){b=document.getElementById(b.getAttribute("href").slice(1))}if(typeof(k)=="undefined"){return getChantWidth(b.textContent)}else{var c=0;var f="";var d="";var n=[];for(var g=0;g<b.childNodes.length;++g){var l=b.childNodes[g];if(c>=k){if(n.length==0&&getChantWidth(l.textContent)<=2){f=f.slice(0,0-d.length)}else{d=""}n.push(getChantWidth(f));if(n.length==2){return n}f=d;k+=h}f+=l.textContent;d=l.textContent;c+=1}n.push(getChantWidth(f));return n}}function getChantWidth(b){defChant.textContent=b;return defChant.getComputedTextLength()}function selectGabc(h,c){var g=$("#editor");h+=getHeaderLen(g.val());if(g.is(":visible")){g=g[0]}else{g=$("#hymngabc")[0];var f=0,d;for(d in _hymnGabcMap){if(d>h){break}f=_hymnGabcMap[d]+h-d}h=f}if(c==-1){var b=$(g).val().slice(h).match(/^[^) ]*/);c=b[0].length}g.select(h,c);g.selectionStart=h;g.selectionEnd=h+c}function getTagsFrom(b){var c,d=[];while(c=regexTag.exec(b)){d.push(c[2]);var f=c.index+c[0].length;if(c.index==0){b=b.slice(c[0].length)}else{b=b.slice(0,c.index)+b.slice(f)}}return d}function tagsForText(f,k){if(typeof(f)=="string"){f=[f]}var d=[];var c=f[0];if(!k){k=[]}var g;while(g=regexTag.exec(c)){var h=c.slice(0,g.index);if(h.length>0){d.push(new TagInfo(h,k))}if(g[1]!="/"){if(k.indexOf(g[2])<0){k.push(g[2])}}else{var b=k.indexOf(g[2]);if(b>=0){k.splice(b,1)}}var l=g.index+g[0].length;c=c.slice(l)}f[0]=c;return d}function TagInfo(c,d){this.tags=$.merge([],d||[]);this.text=c.replace(/ /g,"\u00a0");if(d&&d.indexOf("v")>=0){this.span=this.spanV;this.spans=[];var c="";var b=this.text.match(/\\[^\\\s]*|[^\\]+/g);for(var f=0;f<b.length;++f){var g=b[f];if(g[0]=="\\"){g=g.slice(1);var h=vCodes[g];if(h){this.spans.push({txt:h});c+=h;continue}}this.spans.push(g);c+=g}this.text=c}}TagInfo.prototype.span=function(){var b=make("tspan",this.text,fontclass+" "+this.tags.join(" "));return b};TagInfo.prototype.spanV=function(){var g=fontclass+" "+this.tags.join(" ");var b=make("tspan","",g);for(var d=0;d<this.spans.length;++d){var f=this.spans[d];switch(typeof(f)){case"object":b.appendChild(make("tspan",f.txt,"versiculum"));break;case"string":b.appendChild(document.createTextNode(f));break}}return b};var finishStaff=function(d){var b=d.parentNode;var c=parseInt(d.id.match(/\d+$/)[0]);var k=d.info;var h=k.ltone;var g=k.htone;h=(3-h);h=(h<=0)?0:((h*spaceheight)/2);g=(g-9);g=(g<=0)?0:((g*spaceheight)/2);var l=Math.ceil(0.1*staffheight+fontsize+h+g);k.vOffset=k.y;if(k.txtInitial){k.txtInitial.setAttribute("y",l+k.y)}if(k.txtAnnotation){k.txtAnnotation.setAttribute("y",k.y+Math.ceil(g)-25)}k.eText.setAttribute("y",l);k.eTrans.setAttribute("y",l+fontsize);k.eText.setAttribute("transform","translate("+k.x+","+k.vOffset+")");k.eTrans.setAttribute("transform","translate("+k.x+","+k.vOffset+")");if(b){b.appendChild(k.eText);b.appendChild(k.eTrans)}if(k.eTrans.childNodes.length>0){l+=fontsize}if(g>0){k.vOffset+=g;if(c==0){var f=0;$(d).children("[id^=neume]").each(function(){f=Math.min(f,this.neume.info.mindy)});_heightCorrection=f+g}d.setAttribute("transform","translate("+k.x+", "+(k.y+g)+")")}return l};var trimStaff=function(k,c){var o;var l=$(k).find("use[href=#staff]");if(c){o=c}else{var b=$(k).find("[id^=neume]:last");var n=$(k.parentNode).find("[id^=neumetext]:last");href=b.attr("href");if(href){if(!/\:$/.exec(href)){return}}else{if(!/\|$/.exec(b.text())){return}}var d=/\d+$/.exec(b.prop("id"))[0];var p=/\d+$/.exec(n.prop("id"))[0];if(p>d){return}o=parseFloat(b.attr("x"));var f=b.attr("transform");var g=regexTranslate.exec(f);if(g&&g[1]){o+=parseFloat(g[1])}o+=b[0].neume.wChant}var h="scale("+o+",1)";l.attr("transform",function(r,q){return q.replace(/scale\([^\)]*\)/,h)})};var justifyLine=function(k,f,g){var p=0;var t=0;var l=k.words;if(!g){var n=2*spaceBetweenNeumes;t=svgWidth-k.info.x-n;var d,u;var r=l.length-1;while(r>=0&&!(d&&u)){var c=l[r--];var q=c.length-1;while(q>=0&&!(d&&u)){var x=c[q--];if(!d&&x.tagName.match(/^use|text$/i)&&x.neume){d=x;continue}else{if(!u&&x.tagName.match(/^tspan$/i)){u=x;continue}}}}if(d){if(f){p=d.neume.x+(d.neume.transformX||0)}else{p=parseFloat($(d).attr("x"));var h=f?d.neume.transform:$(d).attr("transform");var o=regexTranslate.exec(h);if(o&&o[1]){p+=parseFloat(o[1])}}p+=d.neume.wChant}if(u){var v;if(f&&u.neume){v=u.neume.x}else{v=parseFloat($(u).attr("x"));v+=textWidth(u)-n}p=Math.max(p,v)}}if(g||p>0){var b=t-p;var s=l.length-1;var w=b/s;if(g||b>0){while(s>=0){l[s].forEach(function(y){if(y.neume){y.neume.justifyOffset=Math.round(b)}if($(y).attr("transform")){if(f&&y.neume){$(y).attr("x",y.neume.x)}$(y).attr("transform",function(A,z){return"translate("+Math.round(b+(y.neume&&y.neume.transformX||0))+")"})}else{$(y).attr("x",function(A,z){return(f?y.neume.x:(z?parseFloat(z):0))+Math.round(b)})}});b-=w;--s}}}};var addCustos=function(o,l,d,h){var c=l.info.ftone;var n=neume(indices.custos,c);var p=o.custos;if(p){p.textContent=n;if(o.custosLedger){try{o.removeChild(o.custosLedger);delete o.custosLedger}catch(k){}}}else{p=make("text",n);p.setAttribute("class",defChant.getAttribute("class"));p.setAttribute("y",0)}if(d||typeof(d)=="undefined"){justifyLine(o,typeof(l.x)!="undefined");d=true}var b=d?svgWidth-o.info.x-(staffheight/15):h;p.setAttribute("x",b);o.appendChild(p);o.custos=l.custos=p;var f=c>10;var g=c<2;if(f||g){o.custosLedger=l.custosLedger=insertLedger(f,o,p,true)}};function relayoutChant(h){var c=svgWidth=$(h.parentNode).width(),V=$(h),aa=V.children("g"),H=V.find("#commentary"),M=0,T=0,F=0,R=0,l=V.find("#system"+F),q=l[0],O,K,v,o,Q=l[0].info,u,Z,g,X,U=V.find("defs")[0],n=Q.y,N,f=[],J,S,Y=[],E=c-Q.x-spaceBetweenNeumes;tagsBetweenText=[];Q.ltone=3;Q.htone=10;if(H.length){H.attr("x",c-H[0].getComputedTextLength())}lastClefBeforeNeume=function(ab){var y,x={clefTone:9};for(y in _clefs){if(y<ab){x=_clefs[y]}else{break}}return x};lastClefBeforePunctum=function(ab){var ac,x={clefTone:9};for(ac in _clefs){try{var y=parseInt($(h).find("#neume"+ac).children()[0].id.match(/\d+$/)[0]);if(y<ab){x=_clefs[ac].info}else{break}}catch(ad){}}return x};var I=function(y,ac){var ab,x=null;for(ab in _accidentals){if(ab<=y){x=_accidentals[ab]}else{break}}return x};while(true){Z=u;g=K;O=aa.find("#neume"+R);K=aa.find("#neumetext"+R);v=aa.find("#neumetrans"+R);u=O[0]?O[0].neume:(K[0]?K[0].neume:{match:{}});delete u.custos;var b=aa.find("#neumemask"+R);o=$.merge($.merge($.merge($.merge($(),O),K),v),b);J=o.toArray();S=O.toArray().concat(b.toArray());var d=false;for(W in u.ledgers){d=true;break}N=u.offset||0;if(o.length==0){break}T+=Math.min(0,N);if(u.wChant>0&&(M<T||!K.length)){M=T}else{if(Z.lastOnLineHyphen){$(Z.lastOnLineHyphen).remove();delete Z.lastOnLineHyphen}}var C=K.length?M+u.wText+Math.max(Math.floor(N),0):C||0;if(u.match[7]&&u.match.index>0){C+=5}var t=M+u.wChant+(u.spaceBeforeNextNeume||spaceBetweenNeumes)-Math.min(N,0);var p;u.x=M;if(Math.max(C,t)>E){var k=lastClefBeforeNeume(R);var D=k?k.wChant:0;if(g.length&&!Z.lastOnLineHyphen&&!g.text().slice(-1).match(/-|\s/)){Z.lastOnLineHyphen=new TagInfo("-").span();g.append(Z.lastOnLineHyphen)}C-=M;t-=M;M=0;T=D+(u.spaceBeforeNextNeume||spaceBetweenNeumes)+N;if(u.wChant>0&&M<T){M=T}C+=M;t+=M;u.x=M;++F;if(f.length){Y.push(f);f=[]}q.words=Y;Y=[];tagsBetweenText=[];X=q;trimStaff(q,c-Q.x);var L=finishStaff(q);l=V.find("#system"+F);if(l.length){q=l[0];q.info.htone=10;q.info.ltone=3}else{var s=staffoffset+L+verticalSpace+Q.y;q=addStaff(h,q.parentNode,0,s,F,null,U);q.info.vOffset=q.info.y;l=$(q)}Q=q.info;E=c-Q.x-(u.spaceBeforeNextNeume||spaceBetweenNeumes)}f=f.concat(o.toArray());if(O.length){Q.ltone=Math.min(Q.ltone,u.info.ltone);Q.htone=Math.max(Q.htone,u.info.htone);l.append(O);if(X&&!u.gabc.match(/^[,;:]+$/)){addCustos(X,u);X=null}}if(v.length){v[0].neume=u}if(K.length){$(Q.eText).append(K);$(Q.eTrans).append(v);var P=tagsBetweenText.length-1;if(P<=0){tagsBetweenText[0]=S}else{var r=tagsBetweenText[0][0];var z=r.neume.x+r.neume.wChant;z+=(u.transformX||0);var w=M;if(N<0){w-=N}var B=0;for(var W=1;W<=P;++W){B+=tagsBetweenText[W][0].neume.wChant}var A=w-z-B;A/=(P+1);var G=z+A;for(var W=1;W<=P;++W){for(j in tagsBetweenText[W]){tagsBetweenText[W][j].neume.x=G}G+=A+tagsBetweenText[W][0].neume.wChant}tagsBetweenText=[S]}}else{if(tagsBetweenText.length>0&&!u.info.ftone){tagsBetweenText.push(S);if((f.length==1&&f[0]==O[0])||(f.length==2&&f[0]==O[0]&&f[1]==b[0])){Y.push(f);f=[]}}}if(d){processLedger(u,O[0],f)}if(u.match[7]){Y.push(f);f=[]}M=C;T=t;++R}if(f.length){Y.push(f)}q.words=Y;justifyLine(q,true,true);if(q.custos){$(q.custos).remove();q.custos=undefined}if(q.custosLedger){$(q.custosLedger).remove();q.custosLedger=undefined}trimStaff(q,c-Q.x);finishStaff(q);trimStaff(q);while(l.length){++F;l=V.find("#system"+F);l.remove()}h.setAttribute("height",$(h).children("g")[0].getBBox().height+n+_heightCorrection-_defText.getExtentOfChar("q").height)}function getChant(aF,aw,aT,aC){if(!aC){aC=[]}var ah=aF[0];aF=aF[1];var Q=aF.match(/[\r\n]\s*[-\w]+:[^;]+;\s*[\r\n]/);if(Q){aF=aF.slice(0,Q.index)}var c=aw?(aw.parentNode&&aw.parentNode.id=="chant-preview"):false;var H=$(aw).find("defs")[0];if(!H){H=_defs}var aA;var O=0;var J=0;var g=aT?true:false;if(aT){$(aT).empty()}else{aT=make("g");aT.setAttribute("transform","translate(0,"+staffoffset+")");aT.setAttribute("class","caeciliae")}if(c){_clefs=[];_accidentals=[];_tones=[]}var aJ=$(aw.parentNode).width();var aG=ah["user-notes"];var aq=ah.commentary;var aQ=0;if(typeof(aG)=="string"&&aG.length>0){var E=make("text",aG);E.setAttribute("id","userNotes");E.setAttribute("class",fontclass+" i");E.setAttribute("y",16-staffoffset);aT.appendChild(E);aQ=20}if(typeof(aq)=="string"&&aq.length>0){var E=make("text",aq);E.setAttribute("id","commentary");E.setAttribute("class",fontclass+" i");E.setAttribute("y",16-staffoffset);aT.appendChild(E);E.setAttribute("x",aJ-E.getComputedTextLength());aQ=20}aC[0]=aQ;regexOuter.lastIndex=0;var at=0;var af=0;var s;var aH;var w=null;var o;var an;var aK;var aB=0;var P=true;var Y;var u=0;var l=[];var aj=[];var L=[];var F,b,az;var aR=false;var aD;var al=fontclass;var d=[];var K=addStaff(aw,aT,0,aQ,u,null,H);var aE=K.info;try{var B=$(aw.parentNode).css("padding-left");if(B){aJ-=parseFloat(B)}}catch(V){}svgWidth=aJ;while(gmatch=regexOuter.exec(aF)){var Z=gmatch[5]?gmatch[5].match(/[,;:]+|[^\/,;:]*\/*/g):["",""];Z.splice(-1,1);var aS;var aI=gmatch.index;for(var ai=0;ai<Z.length;++ai){var aA=(Z.length==1)?gmatch:(ai==0?gmatch.slice(0,6):((ai==Z.length-1)?gmatch.slice(4):["",""]));if(aA.length==5){aA.splice(0,0,"","","","")}aA.index=aI;aI=aA.index+aA[1].length;var ay=Z[ai];var ae=ay.match(/\//g);if(ae){ae=ae.length;ay=ay.slice(0,-ae);aS=ae*slashSpace}else{aS=spaceBetweenNeumes}var T={index:aI,match:aA,ledgers:{},wChant:0,wText:0,spaceBeforeNextNeume:aS};var ar=[];if(ay){T.gabc=ay;T.info=getChantFragment(T.gabc,H);F=T.info.clef||F;if(c){if(T.info.clef){_clefs[O]=az=T;az.clefs=[];_accidentals[J]=F.length==3?-1:null}_tones=_tones.concat(T.info.tones)}defChant.textContent=T.info.def.textContent;T.wChant=defChant.getComputedTextLength();if(T.gabc==F){b=T.wChant}}else{T.info={}}if(aj.length>0&&aD&&(aD[7]||aD[8])){l.push(aj);aj=[]}var ak=aA[7]||aA[8];var E=aA[3]||ak;var f=regexSqBrackets.exec(E);if(f){E=E.slice(0,f.index)+E.slice(f.index+f[0].length);f=f[1]}if(aA[3]&&ak){E+=ak}T.txt=E;T.translation=f;var v=0;if(E){if(P&&aA[3]){P=false;if(ah["initial-style"]!="0"){var p=E[0];E=E.slice(1);if(E.replace(/[{}]/g,"").length==0){E="-"}var U=aE.txtInitial=make("text",p);U.setAttribute("transform","translate(0,"+aE.vOffset+")");U.setAttribute("class","greinitial");aT.appendChild(U);var ac=U.getComputedTextLength();var I=ah.annotation;if(typeof(I)=="string"&&I.length>0){var Q=/([a-g]\d?\*?\s*)$/.exec(I);var au="</sc>";if(Q){I=I.slice(0,Q.index);au+=Q[0]}I=I.replace(/\b[A-Z\d]+\b/,function(x){return x.toLowerCase()})+au;var aO=aE.txtAnnotation=make("text");var h=tagsForText("<sc><v>"+I+"</v></sc>");for(S in h){aO.appendChild(h[S].span())}aO.setAttribute("class","greannotation");aO.setAttribute("y",aE.vOffset-25);aT.appendChild(aO);var ap=aO.getComputedTextLength();var z=Math.max(ap,ac)/2;aO.setAttribute("x",z-(ap/2));U.setAttribute("x",z-(ac/2));aB=Math.max(ap,ac)+5}else{aB=ac+5}aE.eText.setAttribute("transform","translate("+aB+","+aE.vOffset+")");aE.eTrans.setAttribute("transform","translate("+aB+","+aE.vOffset+")");aE.x=aB;var t=$(K).find("use[href=#staff]")[0];t.setAttribute("transform","scale("+(aJ-aB)+",1)")}}E=E.replace(/^\s+/,"").replace(/\r\n/g," ").replace(/\n/g," ").replace(/<v>(?:\\greheightstar|\$\\star\$)<\/v>/g,"*").replaceSpTags();var aU=[E];ar=tagsForText(aU,L);E=aU[0];var ag="";if(ar.length>0){ar.forEach(function(x){ag+=x.text})}if(E.length>0){var ad=E.replace(/[{}]/g,"");if(ad.length>0){ar.push(new TagInfo(ad,L))}}E=ag+E;T.wText=textWidth(ar);if(E){var k=E.indexOf("{"),R=E.indexOf("}"),aV;if(k>=0&&R>k){var n=E.slice(k+1,R);E=E.slice(0,k)+n+E.slice(R+1);--R;aV={index:k,"0":n,"1":n}}else{if(/^english$/i.exec(ah["centering-scheme"])){aV={index:0,"0":E.replace(/[,.:;\s]*$/,""),"1":E.replace(/[,.:;\s]*$/,"")}}else{aV=regexVowel.exec(E)}}if(!aV){aV={index:0,"0":E.trimRight(),"1":E.trimRight()}}try{var aP=aV.index+aV[0].length-aV[1].length;v-=textWidth(ar,0,aP);v-=textWidth(ar,aP,aV[1].length)/2}catch(V){}v+=notewidth/2}}var ab=T.info.startsWithAccidental?getChantWidth("b-"):0;v+=ab;T.offset=v;af+=Math.min(0,v);if(T.wChant>0&&(at<af||!E)){at=af}var ax=E?at+T.wText+Math.max(Math.floor(v),0):ax||0;if(aA[7]&&aA.index>0){ax+=5}var r=Math.max(at,af)+T.wChant+aS-Math.min(v,0);var av=T.wText==0?Math.max(av||0,at):Math.max(ax,r);var G;if(an||av>=aJ-aB-aS-T.wChant){aR=K;aR.justify=an?an.justify:true;if(!aR.justify){aK=at}an=undefined;d=[];if(w&&E&&$(w).text().slice(-1)!="-"){w.appendChild(T.lastOnLineHyphen=new TagInfo("-").span())}if(aj.length>0){l.push(aj);aj=[]}K.words=l;l=[];var M=finishStaff(K);var aN=staffoffset+M+verticalSpace+aE.y;K=addStaff(aw,aT,0,aN,++u,null,H);K.info.vOffset=K.info.y;aE=K.info;aE.eText.setAttribute("transform","translate(0,"+aE.vOffset+")");aE.eTrans.setAttribute("transform","translate(0,"+aE.vOffset+")");av-=at;ax-=at;r-=at;if(F){var s=make("use");s.setAttribute("class","clef");s.setAttributeNS(xlinkns,"href","#"+F);s.setAttribute("x",0);s.setAttribute("y",0);K.appendChild(s);if(az&&az.clefs){az.clefs.push(s)}at=0;af=b+aS+v;if(T.wChant>0&&at<af){at=af}av+=at;ax+=at;r+=at}else{at=0}}an=T.gabc&&T.gabc.match(/z/i);if(an){an.justify=T.gabc.match(/z/)}if(T.gabc){if(aR&&!T.gabc.match(/^[,;:]+$/)){addCustos(aR,T,aR.justify,aK);aR=false;aB=0}if(T.info.mask){aH=make("use");aH.setAttributeNS(xlinkns,"href","#"+T.info.mask);aH.setAttribute("id","neumemask"+O);aH.setAttribute("class","caeciliae");aH.setAttribute("x",at);aH.setAttribute("y",0);aj.push(aH);masks[u].firstChild.appendChild(aH)}else{aH=null}aE.ltone=Math.min(aE.ltone,T.info.ltone);aE.htone=Math.max(aE.htone,T.info.htone);if(c){s=$(T.info.def).clone()[0]}else{s=make("use");s.setAttributeNS(xlinkns,"href","#"+T.gabc)}s.setAttribute("id","neume"+O);s.setAttribute("x",at);s.setAttribute("y",0);s.neume=T;if(c){J=setUpPunctaIn(s,J);if(ak){var n=F&&F.length==3?-1:null;if(_accidentals[_accidentals.length-1]!=n){_accidentals[J]=n}}}K.appendChild(s);aj.push(s);currentUse=[s];if(aH){currentUse.push(aH)}if(E){var q=d.length-1;if(q<=0){d[0]=currentUse}else{var ao=d[0][0];var D=parseFloat(ao.getAttribute("x"))+ao.neume.wChant;var aM=ao.getAttribute("transform");if(aM){var Q=regexTranslate.exec(aM);D+=parseFloat(Q[1])}var C=at;if(v<0){C-=v}var am=0;for(var S=1;S<=q;++S){am+=d[S][0].neume.wChant}var X=C-D-am;X/=(q+1);var N=D+X;for(var S=1;S<=q;++S){$(d[S]).attr("x",N);N+=X+d[S][0].neume.wChant}d=[currentUse]}}else{if(d.length>0&&!T.info.ftone){d.push(currentUse);if((aj.length==1&&aj[0]==s)||(aj.length==2&&aj[0]==aH&&aj[1]==s)){l.push(aj);aj=[]}}else{if(T.info.ftone){d=[]}}}}else{s=aH=null}if(E){Y=w;pneume=o;w=make("tspan");o=T;var aL=at;if(s){T.transform="translate("+(-v)+")";T.transformX=-v;if(v>0){if(aL-v>=af){T.wText-=v;s.setAttribute("transform",T.transform);if(aH){aH.setAttribute("transform",T.transform)}}else{aL+=v;T.wText+=v}}else{s.setAttribute("transform",T.transform);if(aH){aH.setAttribute("transform",T.transform)}}}if(Y){var W=parseFloat(Y.getAttribute("x"),10);var aW=W+textWidth(Y);if(aW<aL){if($(Y).text().slice(-1)!="-"){Y.appendChild(new TagInfo("-").span());pneume.wText=textWidth(Y);aW=W+pneume.wText;if(aW>aL){var A=aW-aL;aL=aW;if(s){s.setAttribute("x",at+A);if(aH){aH.setAttribute("x",at+A)}}ax+=A;r+=A}}}}w.setAttribute("id","neumetext"+O);w.setAttribute("x",aL);w.setAttribute("class",al+" selectable");w.setAttribute("selectIndex",T.index);w.neume=T;at=ax;af=r;ar.forEach(function(x){w.appendChild(x.span())});if(f){var aa=new TagInfo(f,["i","trans"]).span();aa.setAttribute("id","neumetrans"+O);aa.setAttribute("x",aL);aj.push(aa);aE.eTrans.appendChild(aa)}aj.push(w);aE.eText.appendChild(w)}else{if(s){af=Math.max(af,at+getChantWidth(T.info.def.textContent)+aS);at=ax}else{af=Math.max(af,at)}}O++;aD=aA;if(ak){w=null}processLedger(T,s,aj)}}finishStaff(K);if(gabcSettings.trimStaff){trimStaff(K)}return aT}var boolArray=[true,false];function processLedger(f,c,d){for(i in f.ledgers){$(f.ledgers[i]).remove()}f.ledgers={};if(f.info.ledgerA&&(f.info.ledgerA.length||f.info.ledgerB.length)&&c){var b=c.parentNode;var g=[];processLedgerHelper(f.info.ledgerA,g,true);processLedgerHelper(f.info.ledgerB,g,false);g.forEach(function(h){var k=insertLedger(h,b,c);f.ledgers[h.above]=k;if(d){d.push(k)}})}}function processLedgerHelper(d,h,c){var b=null,g=0;for(a in d){var f=d[a];if(f-1==b){++g}else{if(f-2==b){g+=2}else{if(g>0){h.push({i:b,len:g,above:c})}b=f;g=1}}}if(g>0){h.push({i:b,len:g,above:c})}}function insertLedger(n,g,b,f){var k=0,l=1;if(typeof(n)=="object"){k=n.i;l=n.len;n=n.above}var o=make("use");o.setAttributeNS(xlinkns,"href",n?"#ledgera":"#ledgerb");o.setAttribute("y",b.getAttribute("y"));var c=b.getAttribute("transform");var d=parseFloat(b.getAttribute("x"));if(c){while(m=regexTranslateG.exec(c)){d+=parseFloat(m[1])}}var h=useWidth(b,k,l);d+=h[0];h=h[1];if(f){d-=0.25*notewidth;o.setAttribute("transform","translate("+d+") scale("+(h+0.25*notewidth)+",1)")}else{d-=0.75*notewidth;o.setAttribute("transform","translate("+d+") scale("+(h+1.5*notewidth)+",1)")}if(b){g.insertBefore(o,b)}else{g.appendChild(o)}return o}var ToneInfo=function(b){for(i in b){this[i]=b[i]}};(function(){var h,b,c,f,g;getChantFragment=function(o,k){if(abcs[o]!=undefined){return abcs[o]}var F=undefined;if(o.indexOf("r")>-1){F=o.replace(/r/g,"!");getChantFragment(F,k)}b=make("text");g=3;f=0;b.setAttribute("id",o);var L=null,l,M,t,z=o.length,q=0,s=0,r,A,N,G=false,y=0;ledgerA=[],ledgerB=[];c=0;regexInner.lastMatch=0;var w=[];while(r=regexInner.exec(o)){if(r[1]){continue}h=[];var u=-1;chant=r[0];regexTones.exec("");var v;while(v=regexTones.exec(chant)){++y;var n=[];if(v[regexTonesSpliceIndex]){var I=v[regexTonesSpliceIndex];var K;while(K=regexToneModifiers.exec(I)){if(K[3]){var E=K[3].match(/0/)?-1:0;var p=K[3].length+E-1;K[3]=K[3].slice(E-1);var D=1;var H=h.length;while(D<=p&&D<=H){var x=h[H-D];if(!x.match[rtg.episema]){x.match[rtg.episema]=K[3];x.episemaLoc=E}++D}}if(K[2]){var p=K[2].length;if(p>1){var x=h[h.length-1];if(!x.match[rtg.dot]){x.match[rtg.dot]="."}}}$.extend(n,K)}}else{n=new Array(regexToneModifiersCount)}var C=v.index;v=v.splice(0,regexTonesSpliceIndex).concat(n.splice(1,n.length-1)).concat(v.splice(1,v.length-1));v.index=C+r.index;if(v[rtg.bracketed]){continue}if(v[rtg.clef]){A=v[rtg.clef];N=(A[0]=="f")?5:1;N+=(parseInt(A.slice(-1))*2)}tone=v[0];if(v[rtg.whitespace]){for(var D=0;D<transforms[0].length;++D){tone=tone.replace(transforms[2][D],transforms[1][D])}var J=make("tspan",tone);J.setAttribute("offset",v.index);J.setAttribute("len",v[0].length);b.appendChild(J);f=Math.max(f,(/[`,]/.exec(v[rtg.whitespace])&&9.5)||0);w.push(J=new ToneInfo({match:[]}));J.match[rtg.whitespace]=v[rtg.whitespace]}else{var B=parseInt(v[rtg.tone]||v[rtg.clef]&&v[rtg.clef].slice(0,1),23)-10;if(v[rtg.tone]&&v[rtg.tone].length==1){g=Math.min(g,B);f=Math.max(f,B);if(L==null&&!v[rtg.accidental]){L=B}}else{f=Math.max(f,(v[rtg.clef]&&(parseInt(v[rtg.clef].slice(-1))*2+2))||0)}if(B>10){ledgerA.push(y-1)}else{if(B<2){ledgerB.push(y-1)}}var J=new ToneInfo({match:v,index:B,relativeTone:u<0?0:B-u,modifiers:v[rtg.noteType],clef:v[rtg.clef],episemaLoc:(v[rtg.episema]&&v[rtg.episema].match(/0/))?-1:0,diamond:v[rtg.toneUpper]?true:false,markings:v[rtg.ictus]||v[rtg.dot]||v[rtg.episema],liq:v[rtg.diminutiveLiquescentia],accidental:v[rtg.accidental]});h.push(J);w.push(J);u=B}}for(var D=0;D<h.length;++D){D=d(D)}}k.appendChild(b);return abcs[o]={ltone:g,htone:f,ftone:L,tones:w,startsWithAccidental:(w.length>0&&w[0].match[rtg.accidental])?true:false,mask:F,clef:A,clefTone:N,mindy:c,ledgerA:ledgerA,ledgerB:ledgerB,def:b}};var d=function(z){var q=function(K,I,J){if(!J){J=I}if(K==-1){G+=neume(indices.episema_below,I);g=Math.min(g,I-1)}else{G+=neume(indices.episema_above,J);f=Math.max(f,J+1)}},k=function(J,I){if(J==1){G+=neume(indices.ictus_above,I);f=Math.max(f,I+1)}else{G+=neume(indices.ictus_below,I);g=Math.min(g,I-1)}},s=function(K){if(!K||!G||G.length==0){return}var J=make("tspan",G);J.setAttribute("offset",K.match.index);J.setAttribute("len",K.match[0].length);for(var I=1;I<arguments.length;++I){J.setAttribute("len"+I,arguments[I].match[0].length)}if(arguments.length>1){J.setAttribute("count",arguments.length)}b.appendChild(J);G=""},G="",o=1,r=1,l="",H=h[z],w=(h.length>z+1)?h[z+1]:null,E=(h.length>z+2)?h[z+2]:null,t=(h.length>z+3)?h[z+3]:null,x=(z>0)?h[z-1]:null,p=indices.punctum;if(z>0&&H.relativeTone==0){G+="'"}if(H.diamond){p=H.liq?indices.diamond_tilde:indices.diamond;var B=Math.abs(H.relativeTone);if(x&&x.diamond&&(B==2)){G+="'"}if(w&&!w.diamond){l="-"}}else{if(H.clef){var A=[c];b.appendChild(makeClefSpan(H,A));c=A[0];return z}else{if(H.modifiers){if(H.match[rtg.accidental]){if(z==0){startsWithAccidental=true}var C=(H.match[rtg.flat])?"flat":"natural";G+=neume(indices[C],H.index)+"-";s(H);return z}else{if(H.match[rtg.virga]){p=indices.v;r=H.match[rtg.virga].length;l="'"}else{if(H.match[rtg.stropha]){p=indices.s;r=H.match[rtg.stropha].length;l="'"}else{if(indices[H.modifiers[0]]){p=indices[H.modifiers[0]];if(w&&(w.relativeTone>0&&w.relativeTone<=5)&&H.modifiers=="w"&&(!E||E.relativeTone>=0)){G+=neume(p,H.index);if(H.match[rtg.ictus]){k(-1,H.index)}if(H.match[rtg.episema]){q(-1,H.index)}s(H);if(w.relativeTone>1){G+=neume(indices.connecting_line,H.index,w.index)}++z;p=indices.topPartPodatus;H=w;H.episemaLoc=1}}}}}}else{if(w&&!w.diamond&&(!w.modifiers||w.liq)){if(w.relativeTone>0&&w.relativeTone<=5){if(E&&!E.diamond&&(!E.modifiers||E.modifiers=="~")&&E.relativeTone<0&&E.relativeTone>=-4){p=indices.punctum;if(!E.modifiers&&t&&t.relativeTone>=1&&t.relativeTone<=5){--z;H.episemaLoc=0;w.episemaLoc=0}else{G+=neume(p,H.index);var y=w.index;var F=Math.min(H.index,E.index);if(H.match[rtg.episema]){q(H.episemaLoc,F,y)}if(H.match[rtg.ictus]){k(H.episemaLoc,H.index);H.match[rtg.ictus]=undefined}s(H);if(w.relativeTone>1){G+=neume(indices.connecting_line,H.index,w.index)}if(E.modifiers=="~"){--z;p=undefined}else{G+=neume(p,w.index);if(w.match[rtg.episema]){q(H.episemaLoc,F,y)}if(w.match[rtg.ictus]){k(w.episemaLoc,w.index);w.match[rtg.ictus]=undefined}s(w);if(E.relativeTone<-1){G+=neume(indices.connecting_line,E.index,w.index)}H=E;if(E.match[rtg.episema]){H.episemaTone=E.episemaLoc==-1?F:y}if(E.modifiers=="~"){p=indices.lower_tilde}o=3;++z}}}else{if(w.relativeTone<=5){H.episemaLoc=-1;w.episemaLoc=1;p=indices.topPartPodatus;o=2;if(E&&E.relativeTone<=0){l="-"}if(w.liq){G+=neume(indices["<"],H.index);p=indices.upper_tilde}else{G+=neume(indices.bottomPartPodatus,H.index)}s(H);if(w.relativeTone>1){G+=neume(indices.connecting_line,H.index,w.index)}var D=H;H=w;w=D}}++z}else{if(w.relativeTone<0&&w.relativeTone>=-5){if(!H.markings&&E&&!E.diamond&&(!E.modifiers||E.modifiers=="~")&&E.relativeTone>=1&&E.relativeTone<=4&&w.relativeTone>=-4){if(H.relativeTone>=2&&H.relativeTone<=5){G+=neume(indices.connecting_line,H.index-H.relativeTone,H.index)}else{if(H.relativeTone<1){var u=Math.max(-w.relativeTone,1);G+=(b.childNodes.length>0?"-":"")+neume(indices.decorative_line,H.index-u,H.index)}}if(E.modifiers=="~"){--z;G+=neume(p,H.index);s(H);G+=neume(indices.connecting_line,w.index,H.index);p=undefined}else{G+=neume(indices.porrectus,H.index,w.index);s(H,w);G+=neume(indices.decorative_line,w.index,E.index);w.episemaLoc=-1;if(!t||t.relativeTone>=0||t.relativeTone<-5){p=indices.topPartPodatus;E.episeamLoc=1;H=E;o=3;++z}else{p=undefined;E.connectingLine=true;o=2}}}else{o=2;if(w.liq){var u=Math.min(-w.relativeTone,2);G+=neume(indices.decorative_line,H.index-u,H.index);G+=neume(indices[">"],H.index);s(H);p=indices.lower_tilde}else{if(H.relativeTone>0&&H.relativeTone<=5&&(x.modifiers=="w"||H.connectingLine)){if(H.relativeTone>1){G+=neume(indices.connecting_line,x.index,H.index)}}else{G+=neume(indices.decorative_line,w.index,H.index)}G+=neume(indices.punctum,H.index);if(H.match[rtg.episema]){q(H.episemaLoc,w.index,H.index);o=1}if(H.match[rtg.ictus]){k(H.episemaLoc,H.index);H.match[rtg.ictus]=undefined}if(w.match[rtg.episema]){D=w.episemaLoc==-1?F:y;H.episemaTone=1;if(w.episemaLoc!=-1){w.episemaTone=H.index}}if(H.match[rtg.dot]){if(w.match[rtg.dot]){if(w.match[rtg.dot].length==1){w.match[rtg.dot]=".."}}else{G+=neume(indices.dot,H.index);o=1}}s(H)}if(w.relativeTone<-1){G+=neume(indices.connecting_line,w.index,H.index)}var D=H;H=w;w=D}++z}}}}}}var D=neume(p,H.index);if(r>1){D=(D+"'").repeat(r).slice(0,-1)}G+=D;if(H.match[rtg.ictus]){k(H.episemaLoc,H.index)}if(H.match[rtg.episema]){var D=H.episemaTone||H.index;q(H.episemaLoc,D)}if(o>1){if(w.match[rtg.ictus]){k(w.episemaLoc,w.index)}if(w.match[rtg.episema]&&!H.episemaTone){q(w.episemaLoc,w.index)}}var v,n;if(o>1){v=Math.min(w.index,H.index);n=Math.max(w.index,H.index);if((n-v)>=2||v%2==0){v=undefined}}var D=H.match[rtg.dot];if(D){if(H.index==v){G+=neume(indices.dot,v-1)}else{G+=neume(indices.dot,H.index)}D=D.length}else{D=0}if(w&&(D>1||(o>1&&(D=w.match[rtg.dot])))){if(w.index==v){G+=neume(indices.dot,v-1)}else{G+=neume(indices.dot,w.index)}}if(D&&h[z+1]){l+="--"}G+=l;if(p){s(H)}return z}})();function addStaff(r,o,n,k,p,s,b){var d="staffmask"+p;var A="staff"+p;var h="system"+p;var c;if(masks[p]){var z=masks[p].firstChild;while(z.childElementCount>1){z.removeChild(z.childNodes[1])}c=z.firstChild}else{var v=masks[p],u,w;if(v&&v.parentNode!=b){v=$(b).find("#"+d)[0]}if(v){u=v;w=u.firstChild;c=$(w).find(">rect")[0]}else{u=make("mask");u.setAttribute("maskUnits","objectBoundingBox");u.setAttribute("id",d);w=make("g");w.setAttribute("class","caeciliae");u.appendChild(w);c=make("rect");w.appendChild(c);b.appendChild(u)}masks[p]=u;u.setAttribute("transform","translate(0,"+(k)+")")}c.setAttribute("y",-staffheight);c.setAttribute("width","10000");c.setAttribute("height",1+staffheight);c.setAttribute("fill","white");var t=make("g");var q=t.info={ltone:3,htone:10,vOffset:0,x:0,y:parseInt(k),eText:make("text"),eTrans:make("text")};q.eText.setAttribute("class",fontclass);q.eTrans.setAttribute("class",fontclass);var f=make("g");t.setAttribute("id",h);f.setAttribute("id",A);f.setAttribute("mask","url(#"+d+")");var l=make("use");l.setAttributeNS(xlinkns,"href","#staff");if(!s){s=$(r.parentNode).width()}l.setAttribute("transform","translate("+(n)+") scale("+(s)+",1)");f.appendChild(l);t.appendChild(f);o.appendChild(t);return t}var gradients={};function setGradient(n,d){var k=d==0?"RedBlack":"BlackRed",b=n.parentNode,f=[],q=$(n).index(),g,p=useWidth(b,q,1),h=b.neume.wChant||useWidth(b),c="grad"+k+p.join("_")+"_"+h;if(!(c in gradients)){var l=$(gradients[k]).clone(),o=l.find("stop");l.attr("id",c);$(o[0]).attr("offset",(p[0]+(0.25*p[1]))/h);$(o[1]).attr("offset",(p[0]+(0.75*p[1]))/h);_defs.appendChild(l[0]);gradients[c]=l[0]}n.setAttribute("style","fill:url(#"+c+")")}function setUpPunctaIn(b,c){var g=0,d=c,f=b.neume.info.tones;$(b).children().each(function(){var k=f[g];if(k.match[rtg.accidental]){_accidentals[c]=k.match[rtg.flat]?(k.index-_clefs[_clefs.length-1].info.clefTone):null}else{if(k.match[rtg.whitespace]&&k.match[rtg.whitespace].match(/[,;:]/)){_accidentals[c]=(_clefs.length&&_clefs[_clefs.length-1].gabc.length==3)?-1:null}}this.setAttribute("id","punctum"+c);this.tone=k;var h=parseInt(this.getAttribute("count"))||1;if(h==2){if(c==selectedPunctum){selectedPunctumTag=this;this.setAttribute("class","selectable selected-1");setGradient(this,0)}else{if(c+1==selectedPunctum){selectedPunctumTag=this;this.setAttribute("class","selectable selected-2");setGradient(this,1)}else{this.setAttribute("class","selectable")}}}else{if(c==selectedPunctum){selectedPunctumTag=this;this.setAttribute("class","selectable selected")}else{this.setAttribute("class","selectable")}}g+=parseInt(this.getAttribute("count"))||1;c=d+g});return c}var playTone=function(){console.warn("Audiolet library not loaded.")};var playScore=playTone;var stopScore=playTone;var baseFreq=370;$(function(){var f=function(){try{var s=new Audiolet();var X=function(Z,Y){AudioletGroup.apply(this,[s,0,1]);this.sine=new Sine(s,Z);this.gain=new Gain(s);this.env=new PercussiveEnvelope(s,1,0.3,(Y||1)*0.3,function(){this.audiolet.scheduler.addRelative(0,this.remove.bind(this))}.bind(this));this.envMulAdd=new Multiply(s,0.2,0);this.sine.connect(this.gain);this.gain.connect(this.outputs[0]);this.env.connect(this.envMulAdd);this.envMulAdd.connect(this.gain,0,1)};extend(X,AudioletGroup);var U=function(aa,Z){var Y=new X(aa,Z);Y.connect(s.output)};var W={0:0,1:2,2:4,3:5,4:7,5:9,6:11};playTone=function(ab,Y,aa){var Z=baseFreq;Y=ab==Y;while(ab<0){ab+=7,Z/=2}while(ab>=7){ab-=7,Z*=2}if(ab>0){Z*=Math.pow(2,(W[ab]-(Y?1:0))/12)}U(Z,aa)};var V=false;tempo=150;var b;playScore=function(Z){var Y=Z?0:(selectedPunctum||0);while(b&&b.next()){}b=new PSequence(_tones,1,Y);V=true;s.scheduler.setTempo(tempo);s.scheduler.play([b],1,function(aa){var ab;while(!(V=V&&Y<_tones.length)||!(ab=aa.play(Y))){++Y;if(!(aa=b.next())){K(-1);V=false;return}}K(Y,true);if(ab){s.scheduler.setTempo(tempo/ab)}++Y})};stopScore=function(){V=false}}catch(T){console.warn(T)}};var k=function(){if(typeof(Audiolet)=="function"){try{f()}catch(b){}}else{$.getScript("audiolet.js",f)}};if(typeof(Sink)=="function"){k()}else{$.getScript("sink.js",k)}if($("link[href=style\\.css]").length==0){$(document.head).append($('<link rel="stylesheet" type="text/css" href="style.css">'))}var B=$("#tbl");if(B){for(var n=57568;n<65535;n+=16){var z=document.createElement("row");var C=document.createElement("td");var A=document.createElement("td");C.innerText="0x"+n.toString(16);var J="";for(var O=0;O<16;++O){J+=String.fromCharCode(n+O)+"_"}A.innerText=J;A.className="caeciliae";z.appendChild(C);z.appendChild(A);B.append(z)}}if(typeof(document.createElementNS)!="function"){return}_svg=svg=document.createElementNS(svgns,"svg");svg.setAttribute("style","width:100%;height:0");setPrintFont=function(b){$(svg).find(".caeciliae,.caeciliae-print").attr("class",b?"caeciliae-print":"caeciliae")};_defs=document.createElementNS(svgns,"defs");defText=make("text","");defText.setAttribute("class","goudy");_defs.appendChild(defText);_defText=make("text","");_defText.setAttribute("class","goudy");_defs.appendChild(_defText);defChant=make("text","p");defChant.setAttribute("class","caeciliae");_defs.appendChild(defChant);defChantSvg=make("text","p");defChantSvg.setAttribute("class","caeciliaeSvg");_defs.appendChild(defChantSvg);var L=make("linearGradient");L.setAttribute("gradientUnits","objectBoundingBox");L.setAttribute("id","gradRedBlack");var P=make("stop");P.setAttribute("offset","0");P.setAttribute("stop-color","#e22");L.appendChild(P);P=make("stop");P.setAttribute("offset","100");P.setAttribute("stop-color","#000");L.appendChild(P);gradients.RedBlack=L;L=make("linearGradient");L.setAttribute("gradientUnits","objectBoundingBox");L.setAttribute("id","gradBlackRed");var P=make("stop");P.setAttribute("offset","0");P.setAttribute("stop-color","#000");L.appendChild(P);P=make("stop");P.setAttribute("offset","100");P.setAttribute("stop-color","#e22");L.appendChild(P);gradients.BlackRed=L;var D;if(staffInFont){D=document.createElementNS(svgns,"text");D.textContent="'";D.setAttribute("transform","scale(0.5,1)")}else{D=document.createElementNS(svgns,"g");var g=1;var w=document.createElementNS(svgns,"path");var r="h1v"+g+"h-1zm0 -"+spaceheight;w.setAttribute("d","M0 0"+r.repeat(4));D.appendChild(w);var h=document.createElementNS(svgns,"g");w=document.createElementNS(svgns,"path");w.setAttribute("d","M0 "+spaceheight+r);h.appendChild(w);h.setAttribute("id","ledgerb");_defs.appendChild(h);h=document.createElementNS(svgns,"g");w=document.createElementNS(svgns,"path");w.setAttribute("d","M0 "+(-spaceheight*4)+r);h.appendChild(w);h.setAttribute("id","ledgera");_defs.appendChild(h)}D.setAttribute("id","staff");_defs.appendChild(D);svg.appendChild(_defs);textElem=document.createElementNS(svgns,"g");textElem.setAttribute("transform","translate(0,"+staffoffset+")");textElem.setAttribute("class","caeciliae");svg.appendChild(textElem);var E=$("#chant-preview");if(E.length==0){$(document.body).append(svg)}else{E.append(svg);lastClefBeforeNeume=function(T){var s,b={clefTone:9};for(s in _clefs){if(s<T){b=_clefs[s]}else{break}}return b};lastClefBeforePunctum=function(T){var U,b={clefTone:9};for(U in _clefs){try{var s=parseInt($(svg).find("#neume"+U).children()[0].id.match(/\d+$/)[0]);if(s<T){b=_clefs[U].info}else{break}}catch(V){}}return b};var G=function(s,U){var T,b=null;for(T in _accidentals){if(T<=s){b=_accidentals[T]}else{break}}return b};ToneInfo.prototype.play=function(b){var U=lastClefBeforePunctum(b).clefTone;var T=this.match&&(this.match[rtg.dot]||this.match[rtg.episema])?2:1;if(T==1){var s=$("#punctum"+(1+b));if(s.length){s=s[0].tone;if(s&&s.match[rtg.quilisma]){T=2}}}if(!this.clef&&!this.accidental&&typeof(this.index)=="number"){playTone(this.index-U,G(b),T);return T}return false};var I=function(U){var aq=selectedPunctumTag;if(!aq){return}var an=aq.parentNode;var ai=selectedPunctum-/^punctum(\d+)$/.exec(an.childNodes[0].id)[1];var ab=an.neume;var ap=ab.info.tones[ai];if(!ap||!ap.match){return}var ao=ap.match[rtg.tone],s,ae;if(!ao){ae=ap.match[rtg.clef];ao=parseInt(ae.slice(-1));var s=ao+U;if(s<1){s=1}else{if(s>4){s=4}}U=s-ao;if(U==0){return}ae=ae.slice(0,-1)+s}else{var T=ap.index+U;if(T<0){T=0}else{if(T>12){T=12}}U=T-ap.index;if(U==0){return}s=String.fromCharCode(ao.charCodeAt(0)+U)}e=$("#editor");var ac=e.val();var V=getHeaderLen(ac);V+=ab.index;var am=ac.slice(0,V);ac=ac.slice(V);V=d(true);var ad=V+ap.match[0].length;var ag=ac.slice(0,V);ag+=ac.slice(V,ad).replace(ao,s);V=ab.gabc.length;ag+=ac.slice(ad,V);ac=am+ag+ac.slice(V);ab.gabc=ag;var ak=ab.info;var W=ab.info=getChantFragment(ag,$(svg).find("defs")[0]);if(ae){for(ah in _clefs[selectedNeume].clefs){var al=_clefs[selectedNeume].clefs[ah];al.setAttributeNS(xlinkns,"href","#"+ae)}}stopScore();W.tones[ai].play(selectedPunctum);var af=$(W.def).clone()[0];af.neume=ab;af.setAttribute("id",an.id);af.setAttribute("x",an.getAttribute("x"));af.setAttribute("y",an.getAttribute("y"));af.setAttribute("transform",an.getAttribute("transform"));$(an).replaceWith(af);ab.wChant=useWidth(af);processLedger(ab,af);relayoutChant(svg);if(ai==0&&ab.custos){addCustos(ab.custos.parentNode,ab)}var Y=af.parentNode;var b=Y.info.htone;var Z=Y.info.ltone;if(ak.htone<=ab.info.htone){Y.info.htone=Math.max(Y.info.htone,ab.info.htone)}else{Y.info.htone=10;$(Y).find("[id^=neume]").each(function(){Y.info.htone=Math.max(Y.info.htone,this.neume.info.htone)})}if(ak.ltone>=ab.info.ltone){Y.info.ltone=Math.min(Y.info.ltone,ab.info.ltone)}else{Y.info.ltone=3;$(Y).find("[id^=neume]").each(function(){Y.info.ltone=Math.min(Y.info.ltone,this.neume.info.ltone)})}var aa=$(Y.parentNode).children("#system0")[0].info.y;if(ae||b!=Y.info.htone||Z!=Y.info.ltone){var X=finishStaff(Y);var aj=staffoffset+X+verticalSpace+Y.info.y;var ah=parseInt(Y.id.match(/\d+$/)[0])+1;while((Y=$(Y).siblings("#system"+ah)[0])){Y.info.y=aj;X=finishStaff(Y);aj=staffoffset+X+verticalSpace+Y.info.y;++ah}}svg.setAttribute("height",$(svg).children("g")[0].getBBox().height+aa+_heightCorrection-_defText.getExtentOfChar("q").height);ai=selectedPunctum-ai;selectedPunctumTag=null;ai=setUpPunctaIn(af,ai);selectedNeumeTag=af;e.val(ac)};var d=function(V){if(!(selectedPunctum!=null&&selectedPunctumTag)){return}var s=selectedPunctumTag;var U=selectedPunctum-s.id.match(/^punctum(\d+)$/)[1];var T=s.parentNode;var W=parseInt(s.getAttribute("offset"))||0;var b=parseInt(s.getAttribute("len"))||3;if(U){W+=b;b=parseInt(s.getAttribute("len1"))}if(V){return W}selectGabc(T.neume.index+W,b)};var K=function(s,b){s=parseInt(s);if(s<0){s=-1}if(s==selectedPunctum){return}var W=0,V;if(s<0){b=true;V=$()}else{V=$(svg).find("#punctum"+s);if(V.length==0){W=1;--s;V=$(svg).find("#punctum"+s);if(V.length==0||V.attr("count")!=2){selectedPunctumTag=null;return}}}selectedPunctum=s+W;selectedPunctumTag=V[0];var U=V.parent().attr("id");if(U){U=/neume(\d+)/i.exec(U)}selectedNeume=U?parseInt(U[1]):-1;selectedNeumeTag=selectedPunctumTag&&selectedPunctumTag.parentNode;$(svg).find(".selectable").attr({"class":"selectable",style:""});V.attr("class","selectable selected"+(V.attr("count")==2?"-"+(1+W):""));if(V.attr("count")==2){setGradient(V[0],W)}if(!b){stopScore();var T=selectedPunctum-/^punctum(\d+)$/.exec(selectedNeumeTag.childNodes[0].id)[1];selectedNeumeTag.neume.info.tones[T].play(selectedPunctum)}};var t=function(s){var b=$(svg).find("#neume"+s+">tspan");punctumToSelect=/punctum(\d+)/i.exec(b.attr("id"));if(punctumToSelect){K(parseInt(punctumToSelect[1]))}};$(document).on("click","tspan.selectable[id^=punctum]",function(b){K(/punctum(\d+)/i.exec(this.id)[1])}).on("click","tspan.selectable[id^=neumetext]",function(T){var s=$(this);var b=parseInt(this.getAttribute("selectIndex"));if(b>=0){selectGabc(b,-1)}});var l=function(s){if(s.target.tagName.match(/textarea|input|select/i)){K(-1);return}var b=selectedPunctum;if(s.ctrlKey){var T=selectedNeume;switch(s.which){case 37:--T;break;case 39:++T;break;case 38:I(2);s.preventDefault();return;case 40:I(-2);s.preventDefault();return;case 13:u();return;case 32:playScore();return;default:return}t(T)}else{switch(s.which){case 37:--b;break;case 39:++b;break;case 38:I(1);s.preventDefault();return;case 40:I(-1);s.preventDefault();return;case 13:d();s.preventDefault();return;case 32:playScore(true);s.preventDefault();return;case 27:stopScore();return;default:console.info(s.which);return}K(b)}};$(document).keydown(l)}var p=[];var Q=0;var M=0;window.updateGabc=updateGabc=function(){var b=$(".jgabc:visible");b.each(function(T,U){var s=$(U);var V=s.clone().toggleClass("jgabc jgabc-svg").text("");s.hide();$(svg).clone().appendTo(V);s.after(V);var W=s.attr("src");if(W){c=200;++Q;$.get(W,function(X){s.html(X);if(++M==Q){c=0;N();x(0,true,true)}})}});p=$(".jgabc");setTimeout(N,100)};var F=null;var q=null;var x=function(U,T,b){u();if(F){clearTimeout(F)}if(!T){var s=500;F=setTimeout(function(){x(null,true)},s);return}F=null;$.each(p,function(W,X){var V=$(X).next(".jgabc-svg").find("svg")[0];if(!V){return}if(X.innerHTML.match(/^\s*$/)){return}if(b&&X.hasSvg){return}updateChant(X.innerHTML,V,true);X.hasSvg=true})};var S=function(T){if(q){clearTimeout(q)}if(!T){var b=500;q=setTimeout(function(){S(true)},b);return}q=null;try{relayoutChant(svg)}catch(s){}$.each(p,function(V,W){var U=$(W).next(".jgabc-svg").find("svg")[0];if(!U){return}relayoutChant(U)});$.each(otherElements,function(W,X){var V=$(X),U=V.is("svg")?V[0]:V.find("svg")[0];if(!U){return}relayoutChant(U);V.trigger("relayout")})};if(navigator.userAgent.match(/\bChrome\b/)){updateAllChantWidth=function(b){S(true)}}else{updateAllChantWidth=function(b){S()}}var u=function(){updateChant($("#editor").val(),svg)};forceUpdateChant=function(){updateChant($("#editor").val(),svg,true)};var y=function(b){b.stopPropagation();b.preventDefault();return false};var R=function(b){return b?(b^Math.random()*16>>b/4).toString(16):([10000000]+-1000+-4000+-8000+-100000000000).replace(/[018]/g,R)};var v=function(W){W.stopPropagation();W.preventDefault();var V;var U=$(this);var X=W.originalEvent.dataTransfer.files.length;var s=(uuid&&uuid.v4)?uuid.v4():R();for(V=0;V<X;++V){var T=W.originalEvent.dataTransfer.files[V];var b=new FileReader();b.onload=function(Z){var Y=processDraggedFile(Z.target.result);if(X==1){U.val(Y).keyup()}if(typeof(processGabc)=="function"){processGabc(Y,s,X)}};b.readAsText(T)}};$("#editor").keyup(u).bind("dragover",y).bind("drop",v);$(window).resize(updateAllChantWidth);var H=0;var o=0;var c=0;var N=function(){if(svg){if(svg.parentNode&&svg.parentNode.clientWidth==0){setTimeout(N,100)}else{H=textWidth("abcdefghijklmnopqrstuvwxyz",fontclass,true);var s=getChantWidth("4q5P");var b=getChantWidth("P");notewidth=getChantWidth("p");if(s==b){neume=_neumeLig;indices=_indicesLig;makeClefSpan=_clefSpanLig}else{neume=_neumeChar;indices=_indicesChar;makeClefSpan=_clefSpanChar}if(H!=o){_txtWidths={};o=H;forceUpdateChant();x()}if(++c<100){setTimeout(N,300)}}}};setTimeout(N,100)});var processDraggedFile=function(b){return b};window.updateChant=updateChant;var neume=_neumeChar;var indices=_indicesChar;var makeClefSpan=_clefSpanChar;function gabcEditorKeyDown(p){var q=$(this),h=q.val(),c=this.selectionStart,r=this.selectionEnd;switch(p.which){case 66:if(p.ctrlKey||p.altKey){p.preventDefault();o=h.indexOf(" ",this.selectionEnd);if(o<=0){o=h.length}q.val(h.slice(0,o)+" ()"+h.slice(o));this.selectionEnd=this.selectionStart=o+2}break;case 83:if(c==r&&(p.ctrlKey||p.altKey)&&h[c-1]!="("&&h[c]!=")"){p.preventDefault();q.val(h.slice(0,c)+"()"+h.slice(c));this.selectionEnd=this.selectionStart=c+1}break;case 9:var o,t,g;p.preventDefault();if(p.shiftKey){o=this.selectionStart;g=h.lastIndexOf("\n%%\n",o-1);o=h.lastIndexOf(")",o-1);if(o<=g){o=h.lastIndexOf(")")}if(o>=0){t=o;o=h.lastIndexOf("(",o)}}else{o=this.selectionEnd;var s=/(\()|(-(?!\())|(\s+(?![:;!.])|[^)\s]$)/g;s.lastIndex=o;var n;while((n=s.exec(h))&&(n[2]||n[3])){if(n[3]&&(n.index==0||h[n.index-1]==")")){continue}o=n.index;var b=h.lastIndexOf("\n",o-1)+1,l=h.indexOf("\n",o);if(l<0){l=h.length}if(h[l]=="\r"){l--}var u=h.slice(b,l);if(u.match(/^(?:\s*(?:%.*|[-\w]+:[^;]+;)\s*|%%)$/)){continue}else{break}}if(n){if(n[1]){o=n.index}else{if(n[2]||n[3]){o=n.index+1;h=h.slice(0,o)+"()"+h.slice(o);q.val(h)}else{o=h.indexOf("(")}}}else{o=h.indexOf("(")}o=h.indexOf("(",o);if(o>=0){t=h.indexOf(")",o)}}if(o>=0&&t>=0){this.selectionStart=o+1;this.selectionEnd=t}break;case 57:if(p.shiftKey){var d=this.value.slice(r),k=d.indexOf(")"),f=d.indexOf("(");if(k<0||(f>=0&&f<k)){this.value=this.value.slice(0,this.selectionStart)+"()"+this.value.slice(r);this.selectionStart=this.selectionEnd=c+1;p.preventDefault();return}}break;case 48:if(p.shiftKey){if(c==r&&h[c]==")"){p.preventDefault();this.selectionStart=this.selectionEnd=c+1}}break;case 8:var r=this.selectionEnd;if(r==this.selectionStart&&r>0&&this.value[r]==")"&&this.value[r-1]=="("){p.preventDefault();this.value=this.value.slice(0,this.selectionStart-1)+this.value.slice(r+1);this.selectionStart=this.selectionEnd=r-1}break}}var internationalTextBoxKeyDown=(function(){var c=0;var b={222:{"false":{a:"á",e:"é",i:"í",o:"ó",u:"ú",y:"ý",A:"Á",E:"É",I:"Í",O:"Ó",U:"Ú",Y:"Ý","æ":"ǽ","œ":"oé","Æ":"Ǽ","Œ":"Oé"},"true":{a:"ä",e:"ë",i:"ï",o:"ö",u:"ü",y:"ÿ",A:"Ä",E:"Ë",I:"Ï",O:"Ö",U:"Ü","æ":"aë","œ":"oë","Æ":"Aë","Œ":"Oë"}},69:{"false":{a:"æ",o:"œ",A:"Æ",O:"Œ"},"true":{a:"æ",o:"œ",A:"Æ",O:"Œ"}},8:{"false":{"†":"+","æ":"ae","œ":"oe","Æ":"Ae","Œ":"Oe","á":"a","é":"e","í":"i","ó":"o","ú":"u","ý":"y","Á":"A","É":"E","Í":"I","Ó":"O","Ú":"U","Ý":"Y","ä":"a","ë":"e","ï":"i","ö":"o","ü":"u","ÿ":"y","Ä":"A","Ë":"E","Ï":"I","Ö":"O","Ü":"U","Ǽ":"Aé","ǽ":"aé"},"true":{}}};return function(l){if(typeof(getHeaderLen)=="function"&&getHeaderLen(this.value)>0){var g=this.value.lastIndexOf("(",this.selectionStart-1);var n=this.value.lastIndexOf(")",this.selectionStart-1);if(n<g){return}}if(l.which==187&&l.shiftKey){var f=this.selectionStart;var k=1;this.value=this.value.slice(0,f)+"†"+this.value.slice(this.selectionEnd);this.selectionStart=this.selectionEnd=f+k;l.preventDefault();return}var o=$("#cbEnglish")[0];if(o&&o.checked){return}var q=b[l.which];if(q&&this.selectionStart==this.selectionEnd&&this.selectionStart>0){var h=this.value[this.selectionStart-1];var d=q[l.shiftKey][h];if(d){var p=this.selectionEnd;var k=d.length-1;this.value=this.value.slice(0,--this.selectionStart)+d+this.value.slice(p);this.selectionStart=this.selectionEnd=p+k;l.preventDefault();return}}}})();
>>>>>>> Stashed changes
