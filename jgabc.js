function encode_utf8(e){return utf8_bom+unescape(encodeURIComponent(e))}function decode_utf8(e){return decodeURIComponent(escape(e))}function Header(e){"string"!=typeof e&&(e=""),this.comments=[],this.cValues={},this.original="";var t=e.match(regexHeaderEnd);if(t){var n=this.original=e.slice(0,t.index+t[0].length),a=n.split(/\r?\n/g);for(i in a){var r=a[i],t=regexHeaderLine.exec(r);if(t)if(this[t[1]]){var s=t[1]+"Array";this[s]||(this[s]=[this[t[1]]]),this[s].push(t[2])}else this[t[1]]=t[2];else(t=regexHeaderComment.exec(r))&&"%%"!=r&&(t=regexHeaderLine.exec(r.slice(1)),t?this.cValues[t[1]]=t[2]:this.comments[i]=r)}}}function getHeaderLen(e){var t=e.match(regexHeaderEnd);return t?t.index+t[0].length:0}function getHeader(e){return new Header(e)}function updateLinks(e){var t=getHeader(e);t?e=e.slice(t.original.length):t="%%\n",linkSelector&&$(linkSelector).attr("href","http://gregorio.gabrielmass.com/cgi/process.pl?gregtext="+window.escape(t+e)+"&gregfontselect=17&gregtextfontselect=12&greginitialselect=43&gregspaceselect=7mm&gregredselect=N&greglinethickselect=10&gregpaperselect=letterpaper&gregfaceselect=libertine&gregcropselect=N");try{if(linkDownloadSelector){var n=encode_utf8(t+e),i="data:text/plain;charset=utf8;base64,"+btoa(n),a=t.name||"Untitled";a.match(/\.gabc$/)||(a+=".gabc"),$(linkDownloadSelector).attr("charset","UTF-8").attr("href",i).attr("data-downloadurl","text/plain:"+a+":"+i)}}catch(r){}return[t,e]}function updateChant(e,t,n){var i=t,a=$(t);if(a.is("svg")||(a=a.find("svg"),a.length||(a=$(_svg).clone().appendTo(t)),t=a[0]),t!=_svg&&otherElements.indexOf(t)<0&&i&&otherElements.push(i),!dontUpdateChant&&e){var r=updateLinks(e);if(_timeoutGabcUpdate&&clearTimeout(_timeoutGabcUpdate),!n){var s=gabcProcessTime+100;return _timeoutGabcUpdate=setTimeout(function(){updateChant(e,t,!0)},s),void 0}_nextUpdate=(new Date).getTime()+100+gabcProcessTime;var o=new Date;e=r,_timeoutGabcUpdate=null;var l=$(t).find(">g")[0];if(l){var c=[0],d=getChant(e,t,l,c),f=d.getBBox().height+c[0]+_heightCorrection-_defText.getExtentOfChar("q").height;$(t).height(f),t.parentNode.tagName.match(/span/i)&&$(t).css("width",d.getBBox().width),gabcProcessTime=new Date-o,console.info("Update chant time: "+gabcProcessTime),gabcProcessTime>3e3&&(gabcProcessTime=3e3)}}}function make(e,t,n){var i=document.createElementNS(svgns,e);if(t&&i.appendChild(document.createTextNode(t)),n)switch(typeof n){case"string":i.setAttribute("class",n);break;case"object":for(a in n)i.setAttribute(a,n[a])}return i}function textWidth(e,t,n){var i=0,a=void 0;if(0===e.length)return 0;if("number"==typeof t&&"number"==typeof n&&(i=t,a=n,t=n=void 0,0===a))return 0;var r=n?_defText:defText;if($.isArray(e)){var s,o;if(1!=e.length||0!=e[0].tags.length){if(0==i&&!a&&(o=JSON.stringify(e))&&(s=_txtWidths[o]))return s;$(r).empty();var l=0,c=0;return e.forEach(function(e){var t=e.span();r.appendChild(t);var n=Math.max(i,c),s=t.textContent.length,o=Math.min(c+s,i+(a||1e6))-n;n-=c,c+=s;try{o>0&&n>=0&&(l+=t.getSubStringLength(n,o))}catch(d){console.warn(d)}}),o&&(_txtWidths[o]=l||r.getComputedTextLength()),l}if(e=e[0].text,0==e.length)return 0;if(void 0==t&&(t=""),0==i&&!a&&(o=t+","+e)&&(s=_txtWidths[o]))return s}else if("object"==typeof e){if(1==e.childNodes.length){var d=e.firstChild,o=$(d).attr("class").replace(new RegExp("(?:^|\\s)"+fontclass+"(?:\\s|$)|\\s+$","g"),"")+","+d.textContent,s=_txtWidths[o];if(s)return s}$(r).empty().append($(e).clone());var l=r.getComputedTextLength();return o&&(_txtWidths[o]=l),l}t&&r.setAttribute("class",t),$(r).text(e.replace(/ /g," "));var l=r.getSubStringLength(i,a||e.length);return o&&(_txtWidths[o]=l),l}function useWidth(e,t,n){if(e.tagName.match(/^use$/i)&&(e=document.getElementById(e.getAttribute("href").slice(1))),"undefined"==typeof t)return getChantWidth(e.textContent);for(var i=0,a="",r="",s=[],o=0;o<e.childNodes.length;++o){var l=e.childNodes[o];if(i>=t){if(0==s.length&&getChantWidth(l.textContent)<=2?a=a.slice(0,0-r.length):r="",s.push(getChantWidth(a)),2==s.length)return s;a=r,t+=n}a+=l.textContent,r=l.textContent,i+=1}return s.push(getChantWidth(a)),s}function getChantWidth(e){return defChant.textContent=e,defChant.getComputedTextLength()}function selectGabc(e,t,n){var i=$("#"+$(n).parent().attr("for"));if(0==i.length&&(i=$("#editor")),e+=getHeaderLen(i.val()),i.is(":visible"))i=i[0];else{i=$("#hymngabc")[0];var a,r=0;for(a in _hymnGabcMap){if(a>e)break;r=_hymnGabcMap[a]+e-a}e=r}if(-1==t){var s=$(i).val().slice(e).match(/^[^) ]*/);t=s[0].length}i.select(e,t),i.selectionStart=e,i.selectionEnd=e+t}function getTagsFrom(e){for(var t,n=[];t=regexTag.exec(e);){n.push(t[2]);var i=t.index+t[0].length;e=0==t.index?e.slice(t[0].length):e.slice(0,t.index)+e.slice(i)}return n}function tagsForText(e,t){"string"==typeof e&&(e=[e]);var n=[],i=e[0];t||(t=[]);for(var a;a=regexTag.exec(i);){var r=i.slice(0,a.index);if(r.length>0&&n.push(new TagInfo(r,t)),"/"!=a[1])t.indexOf(a[2])<0&&t.push(a[2]);else{var s=t.indexOf(a[2]);s>=0&&t.splice(s,1)}var o=a.index+a[0].length;i=i.slice(o)}return e[0]=i,n}function TagInfo(e,t){if(this.tags=$.merge([],t||[]),this.text=e.replace(/ /g," "),t&&t.indexOf("v")>=0){this.span=this.spanV,this.spans=[];for(var e="",n=this.text.match(/\\[^\\\s]*|[^\\]+/g),i=0;i<n.length;++i){var a=n[i];if("\\"==a[0]){a=a.slice(1);var r=vCodes[a];if(r){this.spans.push({txt:r}),e+=r;continue}}this.spans.push(a),e+=a}this.text=e}}function relayoutChant(e){var t,n,i,a,r,s,o,l,c,d,f,u=svgWidth=$(e.parentNode).width(),h=$(e),g=h.children("g"),m=h.find("#commentary"),p=0,v=0,x=0,b=0,T=h.find("#system"+x),y=T[0],C=T[0].info,A=h.find("defs")[0],w=C.y,S=[],k=[],_=u-C.x-spaceBetweenNeumes;for(tagsBetweenText=[],C.ltone=3,C.htone=10,m.length&&m.attr("x",u-m[0].getComputedTextLength()),lastClefBeforeNeume=function(t){var n,i={clefTone:9};for(n in e.clefs){if(!(t>n))break;i=e.clefs[n]}return i},lastClefBeforePunctum=function(t){var n,i={clefTone:9};for(n in e.clefs)try{var a=parseInt($(e).find("#neume"+n).children()[0].id.match(/\d+$/)[0]);if(!(t>a))break;i=e.clefs[n].info}catch(r){}return i};;){s=r,o=n,t=g.find("#neume"+b),n=g.find("#neumetext"+b),i=g.find("#neumetrans"+b),r=t[0]?t[0].neume:n[0]?n[0].neume:{match:{}},delete r.custos;var L=g.find("#neumemask"+b);a=$.merge($.merge($.merge($.merge($(),t),n),i),L),d=a.toArray(),f=t.toArray().concat(L.toArray());var N=!1;for(H in r.ledgers){N=!0;break}if(c=r.offset||0,0==a.length)break;v+=Math.min(0,c),r.wChant>0&&(v>p||!n.length)?p=v:s.lastOnLineHyphen&&($(s.lastOnLineHyphen).remove(),delete s.lastOnLineHyphen);var I=n.length?p+r.wText+Math.max(Math.floor(c),0):I||0;r.match[7]&&r.match.index>0&&(I+=5);var M=p+r.wChant+(r.spaceBeforeNextNeume||spaceBetweenNeumes)-Math.min(c,0);if(r.x=p,Math.max(I,M)>_){var O=lastClefBeforeNeume(b),P=O?O.wChant:0;!o.length||s.lastOnLineHyphen||o.text().slice(-1).match(/-|\s/)||(s.lastOnLineHyphen=new TagInfo("-").span(),o.append(s.lastOnLineHyphen)),I-=p,M-=p,p=0,v=P+(r.spaceBeforeNextNeume||spaceBetweenNeumes)+c,r.wChant>0&&v>p&&(p=v),I+=p,M+=p,r.x=p,++x,S.length&&(k.push(S),S=[]),y.words=k,k=[],tagsBetweenText=[],l=y,trimStaff(y,u-C.x);var E=finishStaff(y);if(T=h.find("#system"+x),T.length)y=T[0],y.info.htone=10,y.info.ltone=3;else{var B=staffoffset+E+verticalSpace+C.y;y=addStaff(e,y.parentNode,0,B,x,null,A),y.info.vOffset=y.info.y,T=$(y)}C=y.info,_=u-C.x-(r.spaceBeforeNextNeume||spaceBetweenNeumes)}if(S=S.concat(a.toArray()),t.length&&(C.ltone=Math.min(C.ltone,r.info.ltone),C.htone=Math.max(C.htone,r.info.htone),T.append(t),l&&!r.gabc.match(/^[,;:]+$/)&&(addCustos(l,r),l=null)),i.length&&(i[0].neume=r),n.length){$(C.eText).append(n),$(C.eTrans).append(i);var F=tagsBetweenText.length-1;if(0>=F)tagsBetweenText[0]=f;else{var D=tagsBetweenText[0][0],W=D.neume.x+D.neume.wChant;W+=r.transformX||0;var G=p;0>c&&(G-=c);for(var U=0,H=1;F>=H;++H)U+=tagsBetweenText[H][0].neume.wChant;var R=G-W-U;R/=F+1;for(var q=W+R,H=1;F>=H;++H){for(j in tagsBetweenText[H])tagsBetweenText[H][j].neume.x=q;q+=R+tagsBetweenText[H][0].neume.wChant}tagsBetweenText=[f]}}else tagsBetweenText.length>0&&!r.info.ftone&&(tagsBetweenText.push(f),(1==S.length&&S[0]==t[0]||2==S.length&&S[0]==t[0]&&S[1]==L[0])&&(k.push(S),S=[]));N&&processLedger(r,t[0],S),r.match[7]&&(k.push(S),S=[]),p=I,v=M,++b}for(S.length&&k.push(S),y.words=k,justifyLine(y,!0,!0),y.custos&&($(y.custos).remove(),y.custos=void 0),y.custosLedger&&($(y.custosLedger).remove(),y.custosLedger=void 0),trimStaff(y,u-C.x),finishStaff(y),trimStaff(y);T.length;)++x,T=h.find("#system"+x),T.remove();var V=$(e).children("g")[0].getBBox().height+w+_heightCorrection-_defText.getExtentOfChar("q").height;e.setAttribute("height",V),$(e).height(V)}function getChant(e,t,n,i){i||(i=[]);var a=e[0];e=e[1];var r=e.match(/[\r\n]\s*[-\w]+:[^;]+;\s*[\r\n]/);r&&(e=e.slice(0,r.index));var s=t.parentNode.getAttribute("for"),o=$("#"+s);o.is("textarea")||(s=o=null);var l=t?t.parentNode&&("chant-preview"==t.parentNode.id||s):!1,c=$(t).find("defs")[0];c||(c=_defs);var d,f=0,u=0;n?$(n).empty():(n=make("g"),n.setAttribute("transform","translate(0,"+staffoffset+")"),n.setAttribute("class","caeciliae")),l&&(t.clefs=[],t.accidentals=[],t.tones=[]);var h=$(t.parentNode).width(),g=a["user-notes"],m=a.commentary,p=String(a.cValues.timing||"").split(" ")||[],v=String(a.cValues.volume||"").split(" ")||[],x=0;if("string"==typeof g&&g.length>0){var b=make("text",g);b.setAttribute("id","userNotes"),b.setAttribute("class",fontclass+" i"),b.setAttribute("y",16-staffoffset),n.appendChild(b),x=20}if("string"==typeof m&&m.length>0){var b=make("text",m);b.setAttribute("id","commentary"),b.setAttribute("class",fontclass+" i"),b.setAttribute("y",16-staffoffset),n.appendChild(b),b.setAttribute("x",h-b.getComputedTextLength()),x=20}i[0]=x,regexOuter.lastIndex=0;var T,y,C,A,w,S,k,_,L,N,I=0,M=0,O=null,P=0,E=!0,B=0,F=[],D=[],W=[],G=!1,U=fontclass,j=[],H=addStaff(t,n,0,x,B,null,c),R=H.info;try{var q=$(t.parentNode).css("padding-left");q&&(h-=parseFloat(q))}catch(V){}for(svgWidth=h;gmatch=regexOuter.exec(e);){var z=gmatch[5]?gmatch[5].match(/[`,;:]+|[^\/,;:]*\/*/g):["",""];z.splice(-1,1);for(var K,X=gmatch.index,Y=0;Y<z.length;++Y){var d=1==z.length?gmatch:0==Y?gmatch.slice(0,6):Y==z.length-1?gmatch.slice(4):["",""];5==d.length&&d.splice(0,0,"","","",""),d.index=X+=d[1].length;var Z=z[Y];X+=Z.length;var J=Z.match(/\//g);if(J?(J=J.length,Z=Z.slice(0,-J),K=J*slashSpace):K=spaceBetweenNeumes,"z0"!=Z){var Q={index:d.index,match:d,ledgers:{},wChant:0,wText:0,spaceBeforeNextNeume:K},et=[];Z?(Q.gabc=Z,Q.info=getChantFragment(Q.gabc,c),k=Q.info.clef||k,l&&(Q.info.clef&&(t.clefs[f]=L=Q,L.clefs=[],t.accidentals[u]=3==k.length?-1:null),t.tones=t.tones.concat(Q.info.tones)),defChant.textContent=Q.info.def.textContent,Q.wChant=defChant.getComputedTextLength(),Q.gabc==k&&(_=Q.wChant)):Q.info={},D.length>0&&N&&(N[7]||N[8])&&(F.push(D),D=[]);var tt=d[7]||d[8],b=d[3]||tt,nt=regexSqBrackets.exec(b);nt&&(b=b.slice(0,nt.index)+b.slice(nt.index+nt[0].length),nt=nt[1]),d[3]&&tt&&(b+=tt),Q.txt=b,Q.translation=nt;var it=0;if(b){if(E&&d[3]&&(E=!1,"0"!=a["initial-style"])){var at=b[0];b=b.slice(1),0==b.replace(/[{}]/g,"").length&&(b="-");var rt=R.txtInitial=make("text",at);rt.setAttribute("transform","translate(0,"+R.vOffset+")"),rt.setAttribute("class","greinitial"),n.appendChild(rt);var st=rt.getComputedTextLength(),ot=a.annotation;if("string"==typeof ot&&ot.length>0){var r=/([a-g]\d?\*?\s*)$/.exec(ot),lt="</sc>";r&&(ot=ot.slice(0,r.index),lt+=r[0]),ot=ot.replace(/\b[A-Z\d]+\b/,function(e){return e.toLowerCase()})+lt;var ct=R.txtAnnotation=make("text"),dt=tagsForText("<sc><v>"+ot+"</v></sc>");for(Pt in dt)ct.appendChild(dt[Pt].span());ct.setAttribute("class","greannotation"),ct.setAttribute("y",R.vOffset-25),n.appendChild(ct);var ft=ct.getComputedTextLength(),ut=Math.max(ft,st)/2;ct.setAttribute("x",ut-ft/2),rt.setAttribute("x",ut-st/2),P=Math.max(ft,st)+5}else P=st+5;R.eText.setAttribute("transform","translate("+P+","+R.vOffset+")"),R.eTrans.setAttribute("transform","translate("+P+","+R.vOffset+")"),R.x=P;var ht=$(H).find("use[href=#staff]")[0];ht.setAttribute("transform","scale("+(h-P)+",1)")}b=b.replace(/^\s+/,"").replace(/\r\n/g," ").replace(/\n/g," ").replace(/<v>(?:\\greheightstar|\$\\star\$)<\/v>/g,"*").replaceSpTags();var gt=[b];et=tagsForText(gt,W),b=gt[0];var mt="";if(et.length>0&&et.forEach(function(e){mt+=e.text}),b.length>0){var pt=b.replace(/[{}]/g,"");pt.length>0&&et.push(new TagInfo(pt,W))}if(b=mt+b,Q.wText=textWidth(et),b){var vt,xt=b.indexOf("{"),bt=b.indexOf("}");if(xt>=0&&bt>xt){var Tt=b.slice(xt+1,bt);b=b.slice(0,xt)+Tt+b.slice(bt+1),--bt,vt={index:xt,0:Tt,1:Tt}}else vt=/^english$/i.exec(a["centering-scheme"])?{index:0,0:b.replace(/[,.:;\s]*$/,""),1:b.replace(/[,.:;\s]*$/,"")}:regexVowel.exec(b);vt||(vt={index:0,0:b.trimRight(),1:b.trimRight()});try{var yt=vt.index+vt[0].length-vt[1].length;it-=textWidth(et,0,yt),it-=textWidth(et,yt,vt[1].length)/2}catch(V){}it+=notewidth/2}}var Ct=Q.info.startsWithAccidental?getChantWidth("b-"):0;it+=Ct,Q.offset=it,M+=Math.min(0,it),Q.wChant>0&&(M>I||!b)&&(I=M);var At=b?I+Q.wText+Math.max(Math.floor(it),0):At||0;d[7]&&d.index>0&&(At+=5);var wt=Math.max(I,M)+Q.wChant+K-Math.min(it,0),St=0==Q.wText?Math.max(St||0,I):Math.max(At,wt);if(A||St>=h-P-K-Q.wChant){G=H,G.justify=A?A.justify:!0,G.justify||(w=I),A=void 0,j=[],O&&b&&"-"!=$(O).text().slice(-1)&&O.appendChild(Q.lastOnLineHyphen=new TagInfo("-").span()),D.length>0&&(F.push(D),D=[]),H.words=F,F=[];var $t=finishStaff(H),kt=staffoffset+$t+verticalSpace+R.y;if(H=addStaff(t,n,0,kt,++B,null,c),H.info.vOffset=H.info.y,R=H.info,R.eText.setAttribute("transform","translate(0,"+R.vOffset+")"),R.eTrans.setAttribute("transform","translate(0,"+R.vOffset+")"),St-=I,At-=I,wt-=I,k){var T=make("use");T.setAttribute("class","clef"),T.setAttributeNS(xlinkns,"href","#"+k),T.setAttribute("x",0),T.setAttribute("y",0),H.appendChild(T),L&&L.clefs&&L.clefs.push(T),I=0,M=_+K+it,Q.wChant>0&&M>I&&(I=M),St+=I,At+=I,wt+=I}else I=0}if(A=Q.gabc&&Q.gabc.match(/z(?!0)/i),A&&(A.justify=Q.gabc.match(/z/)),Q.gabc){if(G&&!Q.gabc.match(/^[`,;:]+$/)&&(addCustos(G,Q,G.justify,w),G=!1,P=0),Q.info.mask?(y=make("use"),y.setAttributeNS(xlinkns,"href","#"+Q.info.mask),y.setAttribute("id","neumemask"+f),y.setAttribute("class","caeciliae"),y.setAttribute("x",I),y.setAttribute("y",0),D.push(y),masks[B].firstChild.appendChild(y)):y=null,R.ltone=Math.min(R.ltone,Q.info.ltone),R.htone=Math.max(R.htone,Q.info.htone),l?T=$(Q.info.def).clone()[0]:(T=make("use"),T.setAttributeNS(xlinkns,"href","#"+Q.gabc)),T.setAttribute("id","neume"+f),T.setAttribute("x",I),T.setAttribute("y",0),T.neume=Q,l&&(u=setUpPunctaIn(T,u,t),tt)){var Tt=k&&3==k.length?-1:null;t.accidentals[t.accidentals.length-1]!=Tt&&(t.accidentals[u]=Tt)}if(H.appendChild(T),D.push(T),currentUse=[T],y&&currentUse.push(y),b){var _t=j.length-1;if(0>=_t)j[0]=currentUse;else{var Lt=j[0][0],Nt=parseFloat(Lt.getAttribute("x"))+Lt.neume.wChant,It=Lt.getAttribute("transform");if(It){var r=regexTranslate.exec(It);Nt+=parseFloat(r[1])}var Mt=I;0>it&&(Mt-=it);for(var Ot=0,Pt=1;_t>=Pt;++Pt)Ot+=j[Pt][0].neume.wChant;var Et=Mt-Nt-Ot;Et/=_t+1;for(var Bt=Nt+Et,Pt=1;_t>=Pt;++Pt)$(j[Pt]).attr("x",Bt),Bt+=Et+j[Pt][0].neume.wChant;j=[currentUse]}}else j.length>0&&!Q.info.ftone?(j.push(currentUse),(1==D.length&&D[0]==T||2==D.length&&D[0]==y&&D[1]==T)&&(F.push(D),D=[])):Q.info.ftone&&(j=[])}else T=y=null;if(b){S=O,pneume=C,O=make("tspan"),C=Q;var Ft=I;if(T&&(Q.transform="translate("+-it+")",Q.transformX=-it,it>0?Ft-it>=M?(Q.wText-=it,T.setAttribute("transform",Q.transform),y&&y.setAttribute("transform",Q.transform)):(Ft+=it,Q.wText+=it):(T.setAttribute("transform",Q.transform),y&&y.setAttribute("transform",Q.transform))),S){var Dt=parseFloat(S.getAttribute("x"),10),Wt=Dt+textWidth(S);if(Ft>Wt&&"-"!=$(S).text().slice(-1)&&(S.appendChild(new TagInfo("-").span()),pneume.wText=textWidth(S),Wt=Dt+pneume.wText,Wt>Ft)){var Gt=Wt-Ft;Ft=Wt,T&&(T.setAttribute("x",I+Gt),y&&y.setAttribute("x",I+Gt)),At+=Gt,wt+=Gt}}if(O.setAttribute("id","neumetext"+f),O.setAttribute("x",Ft),O.setAttribute("class",U+" selectable"),O.setAttribute("selectIndex",Q.index),O.neume=Q,I=At,M=wt,et.forEach(function(e){O.appendChild(e.span())}),nt){var Ut=new TagInfo(nt,["i","trans"]).span();Ut.setAttribute("id","neumetrans"+f),Ut.setAttribute("x",Ft),D.push(Ut),R.eTrans.appendChild(Ut)}D.push(O),R.eText.appendChild(O)}else T?(M=Math.max(M,I+getChantWidth(Q.info.def.textContent)+K),I=At):M=Math.max(M,I);f++,N=d,tt&&(O=null),processLedger(Q,T,D)}}}if(finishStaff(H),gabcSettings.trimStaff&&trimStaff(H),l){for(var jt=[],Ht=[],Rt=100,qt=0,Vt=0;qt+Vt<t.tones.length;qt++){for(;!(t.tones[qt+Vt].isPlayable()||(++Vt,qt+Vt>=t.tones.length)););if(qt+Vt>=t.tones.length)break;var zt=v[qt],Kt=p[qt]?/(\d+(?:\.\d+)?)(?:\:(\d+(?:\.\d+)?))?/.exec(p[qt]):null;Rt=zt&&parseInt(zt)||Rt,jt[qt+Vt]=Rt,Kt&&Kt.length&&(Ht[qt+Vt]={length:parseFloat(Kt[1])},Kt[2]&&(Ht[qt+Vt].restAfter=parseFloat(Kt[2])))}t.volumes=jt,t.timings=Ht}return n}function processLedger(e,t,n){for(i in e.ledgers)$(e.ledgers[i]).remove();if(e.ledgers={},e.info.ledgerA&&(e.info.ledgerA.length||e.info.ledgerB.length)&&t){var a=t.parentNode,r=[];processLedgerHelper(e.info.ledgerA,r,!0),processLedgerHelper(e.info.ledgerB,r,!1),r.forEach(function(i){var r=insertLedger(i,a,t);e.ledgers[i.above]=r,n&&n.push(r)})}}function processLedgerHelper(e,t,n){var i=null,r=0;for(a in e){var s=e[a];s-1==i?++r:s-2==i?r+=2:(r>0&&t.push({i:i,len:r,above:n}),i=s,r=1)}r>0&&t.push({i:i,len:r,above:n})}function insertLedger(e,t,n,i){var a=0,r=1;"object"==typeof e&&(a=e.i,r=e.len,e=e.above);var s=make("use");s.setAttributeNS(xlinkns,"href",e?"#ledgera":"#ledgerb"),s.setAttribute("y",n.getAttribute("y"));var o=n.getAttribute("transform"),l=parseFloat(n.getAttribute("x"));if(o)for(;m=regexTranslateG.exec(o);)l+=parseFloat(m[1]);var c=useWidth(n,a,r);return l+=c[0],c=c[1],i?(l-=.25*notewidth,s.setAttribute("transform","translate("+l+") scale("+(c+.25*notewidth)+",1)")):(l-=.75*notewidth,s.setAttribute("transform","translate("+l+") scale("+(c+1.5*notewidth)+",1)")),n?t.insertBefore(s,n):t.appendChild(s),s}function addStaff(e,t,n,i,a,r,s){var o,l="staffmask"+a,c="staff"+a,d="system"+a;if(masks[a]){for(var f=masks[a].firstChild;f.childElementCount>1;)f.removeChild(f.childNodes[1]);o=f.firstChild}else{var u,h,g=masks[a];g&&g.parentNode!=s&&(g=$(s).find("#"+l)[0]),g?(u=g,h=u.firstChild,o=$(h).find(">rect")[0]):(u=make("mask"),u.setAttribute("maskUnits","objectBoundingBox"),u.setAttribute("id",l),h=make("g"),h.setAttribute("class","caeciliae"),u.appendChild(h),o=make("rect"),h.appendChild(o),s.appendChild(u)),masks[a]=u,u.setAttribute("transform","translate(0,"+i+")")}o.setAttribute("y",-staffheight),o.setAttribute("width","10000"),o.setAttribute("height",1+staffheight),o.setAttribute("fill","white");var m=make("g"),p=m.info={ltone:3,htone:10,vOffset:0,x:0,y:parseInt(i),eText:make("text"),eTrans:make("text")};p.eText.setAttribute("class",fontclass),p.eTrans.setAttribute("class",fontclass);var v=make("g");m.setAttribute("id",d),v.setAttribute("id",c),v.setAttribute("mask","url(#"+l+")");var x=make("use");return x.setAttributeNS(xlinkns,"href","#staff"),r||(r=$(e.parentNode).width()),x.setAttribute("transform","translate("+n+") scale("+r+",1)"),v.appendChild(x),m.appendChild(v),t.appendChild(m),m}function setGradient(e,t){var n=0==t?"RedBlack":"BlackRed",i=e.parentNode,a=$(e).index(),r=useWidth(i,a,1),s=i.neume.wChant||useWidth(i),o="grad"+n+r.join("_")+"_"+s;if(!(o in gradients)){var l=$(gradients[n]).clone(),c=l.find("stop");l.attr("id",o),$(c[0]).attr("offset",(r[0]+.25*r[1])/s),$(c[1]).attr("offset",(r[0]+.75*r[1])/s),_defs.appendChild(l[0]),gradients[o]=l[0]}e.setAttribute("style","fill:url(#"+o+")")}function setUpPunctaIn(e,t,n){var i=0,a=t,r=e.neume.info.tones,s=n.clefs;return $(e).children().each(function(){var e=r[i];e.match[rtg.accidental]?n.accidentals[t]=e.match[rtg.flat]?e.index-s[s.length-1].info.clefTone:null:e.match[rtg.whitespace]&&e.match[rtg.whitespace].match(/[,;:]/)&&(n.accidentals[t]=s.length&&3==s[s.length-1].gabc.length?-1:null),this.setAttribute("id","punctum"+t),this.tone=e;var o=parseInt(this.getAttribute("count"))||1;2==o?t==selectedPunctum?(selectedPunctumTag=this,this.setAttribute("class","selectable selected-1"),setGradient(this,0)):t+1==selectedPunctum?(selectedPunctumTag=this,this.setAttribute("class","selectable selected-2"),setGradient(this,1)):this.setAttribute("class","selectable"):t==selectedPunctum?(selectedPunctumTag=this,this.setAttribute("class","selectable selected")):this.setAttribute("class","selectable"),i+=parseInt(this.getAttribute("count"))||1,t=a+i}),t}function gabcEditorKeyDown(e){var t=$(this),n=t.val(),i=this.selectionStart,a=this.selectionEnd;switch(e.which){case 66:(e.ctrlKey||e.altKey)&&(e.preventDefault(),r=n.indexOf(" ",this.selectionEnd),0>=r&&(r=n.length),t.val(n.slice(0,r)+" ()"+n.slice(r)),this.selectionEnd=this.selectionStart=r+2);break;case 83:i==a&&(e.ctrlKey||e.altKey)&&"("!=n[i-1]&&")"!=n[i]&&(e.preventDefault(),t.val(n.slice(0,i)+"()"+n.slice(i)),this.selectionEnd=this.selectionStart=i+1);break;case 9:var r,s,o;if(e.preventDefault(),e.shiftKey)r=this.selectionStart,o=n.lastIndexOf("\n%%\n",r-1),r=n.lastIndexOf(")",r-1),o>=r&&(r=n.lastIndexOf(")")),r>=0&&(s=r,r=n.lastIndexOf("(",r));else{r=this.selectionEnd;var l=/(\()|(-(?!\())|(\s+(?![:;!.]))|([^)\s]$)/g;l.lastIndex=r;for(var c;(c=l.exec(n))&&(c[2]||c[3]);)if(!c[3]||0!=c.index&&")"!=n[c.index-1]){r=c.index;var d=n.lastIndexOf("\n",r-1)+1,f=n.indexOf("\n",r);0>f&&(f=n.length),"\r"==n[f]&&f--;var u=n.slice(d,f);if(!u.match(/^(?:\s*(?:%.*|[-\w]+:[^;]+;)\s*|%%)$/))break}c?c[1]?r=c.index:c[2]||c[3]||c[4]?(c[2]&&(r=c.index+1),n=n.slice(0,r)+"()"+n.slice(r),t.val(n)):r=n.indexOf("("):r=n.indexOf("("),r=n.indexOf("(",r),r>=0&&(s=n.indexOf(")",r))}r>=0&&s>=0&&(this.selectionStart=r+1,this.selectionEnd=s);break;case 57:if(e.shiftKey){var h=this.value.slice(a),g=h.indexOf(")"),m=h.indexOf("(");if(0>g||m>=0&&g>m)return this.value=this.value.slice(0,this.selectionStart)+"()"+this.value.slice(a),this.selectionStart=this.selectionEnd=i+1,e.preventDefault(),void 0}break;case 48:e.shiftKey&&i==a&&")"==n[i]&&(e.preventDefault(),this.selectionStart=this.selectionEnd=i+1);break;case 8:var a=this.selectionEnd;a==this.selectionStart&&a>0&&")"==this.value[a]&&"("==this.value[a-1]&&(e.preventDefault(),this.value=this.value.slice(0,this.selectionStart-1)+this.value.slice(a+1),this.selectionStart=this.selectionEnd=a-1)}}String.prototype.repeat=function(e){return new Array(e+1).join(this)},String.prototype.trimRight||(String.prototype.trimRight=function(){return this.replace(/\s+$/,"")});var gabcSettings={trimStaff:!0},uuid,_indicesChar={flat:[57585,58176,57586,58177,57587,58178,57588,58179,57589,58180,57590,58181,57591],natural:[57593,58182,57594,58183,57595,58184,57596,58185,57597,58186,57598,58187,57599],flat_line:58176,natural_line:58182,punctum:57603,diamond:57619,virga:57635,v:57635,leftVirga:57651,quilisma:57667,w:57667,bottomPartPodatus:57684,topPartPodatus:57699,podatus:[null,57715,57731,57748,57763],o:57779,O:57795,diamond_tilde:57811,">":57827,"<":57843,upper_tilde:57859,lower_tilde:57875,porrectus:[null,57891,57907,57923,57939],r:57971,s:57987,custos:58019,"+":58019,dot:58035,apos:58050,ictus:58050,ictus_above:58053,ictus_below:58050,underscore:58066,episema:58066,episema_below:58066,episema_above:58069,underscore_longer:58082,episema_longer:58082,clivis:[null,58115,58131,58147,58163],accent_above_staff:58188,connecting_line:[void 0,void 0,59139,59155,59171,59187],decorative_line:[void 0,59203,59219,59235,59251,59267]},vCodes={Abar:"a",Vbar:"v",Rbar:"r"},_indicesLig={flat:"b",natural:"a",punctum:"p",diamond:"n",virga:"v",v:"v",leftVirga:"c",quilisma:"q",w:"q",podatus:"P",bottomPartPodatus:57684,topPartPodatus:"P",o:"o",O:"O",diamond_tilde:"N",">":"L","<":"k",upper_tilde:"K",lower_tilde:"l",porrectus:"R",r:"w",s:"s",custos:"u","+":"u",dot:".",apos:"I",ictus:"I",ictus_above:"I",ictus_below:"i",underscore:"H",episema:"H",episema_above:"H",episema_below:"h",underscore_longer:58082,episema_longer:58082,clivis:"C",accent_above_staff:"~",connecting_line:"x",decorative_line:"X"},fontclass="goudy",_neumeLig=function(e,t){if(arguments.length<2)return"";if("string"!=typeof e)return 2==arguments.length&&"number"==typeof e?_neumeChar(e,t):"";for(var n="",i=1;i<arguments.length;)n+=_ci[arguments[i++]];return n+e},_neumeChar=function(e,t){if(arguments.length<2)return"";var e,t,n=e;return e=parseInt(t),t=0,"object"==typeof n&&(arguments.length>2&&(t=parseInt(arguments[2])),n=n[Math.abs(t-e)],2==arguments.length&&(e=0)),String.fromCharCode(n+e)},_clefSpanLig=function(e){var t=parseInt(e.clef.slice(-1),10),n=2*t-1,i="";return 3==e.clef.length&&(i+=neume(indices.flat,n+1)+"-"),make("tspan",String(n)+(2==e.index?"d":"f")+"-"+i)},_clefSpanChar=function(e,t){var n,i,a=parseInt(e.clef.slice(-1),10),r=0;return 2==e.index?(i="d-",r=2-a):(i="f-",r=3-a),3==e.clef.length&&(i+=neume(indices.flat,4)+"-"),r*=spaceheight,t[0]=Math.min(t[0],r),n=make("tspan",i),n.setAttribute("dy",r),n},_ci=["B","A","0","1","2","3","4","5","6","7","8","9","Z"],staffheight=48,spaceheight=staffheight/4,notewidth=staffheight/6,spaceBetweenNeumes=notewidth,slashSpace=staffheight/20,verticalSpace=staffheight/4,fontsize=3*spaceheight/2,spaceWidth=3*spaceheight/4,staffoffset=Math.ceil(staffheight-spaceheight/2),svgns="http://www.w3.org/2000/svg",xlinkns="http://www.w3.org/1999/xlink",staffInFont=!1,fontExt="ttf",fontExtS="svg#webfont",fontFormat="truetype",fontFormatS="svg",filenameCaeciliae="Caeciliae-"+(staffInFont?"Regular.":"Staffless.")+fontExt,filenameCaeciliaeS="Caeciliae-"+(staffInFont?"Regular.":"Staffless.")+fontExtS,filenameCaeciliaePrint="Caeciliae-"+(staffInFont?"Regular":"Staffless")+"-Print."+fontExt,localCaeciliae="Caeciliae"+(staffInFont?"":" Staffless"),familyCaeciliae="Caeciliae"+(staffInFont?"":" Staffless"),styleCaeciliae="font-family: '"+familyCaeciliae+"'; font-size:"+staffheight+"px;",styleCaeciliaeSvg="font-family: '"+familyCaeciliae+" SVG'; font-size:"+staffheight+"px;",styleGoudy="font-family: 'OFL Sorts Mill Goudy TT'; font-size: "+fontsize+"px;",styleFont="@font-face {font-family: '"+familyCaeciliae+"'; font-weight: normal; font-style: normal;src: local('"+localCaeciliae+"'); src: url('"+filenameCaeciliae+"') format('"+fontFormat+"')}"+"@font-face {font-family: '"+familyCaeciliae+" SVG'; font-weight: normal; font-style: normal;src: url('"+filenameCaeciliaeS+"') format('"+fontFormatS+"')}"+"@font-face {font-family: '"+familyCaeciliae+" Print'; font-weight: normal; font-style: normal;src: url('"+filenameCaeciliaePrint+"') format('"+fontFormat+"')}"+"@font-face {font-family: 'OFL Sorts Mill Goudy TT'; font-style: italic; font-weight: normal; src: local('OFL Sorts Mill Goudy Italic TT'), local('OFLGoudyStMTT-Italic'), url('OFLGoudyStMTT-Italic.ttf') format('truetype');}"+"@font-face {font-family: 'OFL Sorts Mill Goudy TT'; font-style: normal; font-weight: normal; src: local('OFL Sorts Mill Goudy TT'), local('OFLGoudyStMTT'), url('OFLGoudyStMTT.ttf') format('truetype');}",svgWidth,_svg,svg,textElem,codea="a".charCodeAt(0),codem=codea+12,codeA="A".charCodeAt(0),codeM=codeA+12,regexTranslate=/translate\((-?\d+(?:\.\d+)?)(?:[,\s]\s*(-?\d+(?:.\d+)?))?\)/,regexTranslateG=/translate\((-?\d+(?:\.\d+)?)(?:[,\s]\s*(-?\d+(?:.\d+)?))?\)/g,regexHeaderEnd=/(?:^|\n)%%\s?\n/,regexOuter=/((([^\(\r\n]+)($|\())|\()([^\)]*)($|\))(?:(\s+)|(?=(?:\([^\)]*\))+(\s*))|)/g,regexTag=/<(\/)?(b|i|sc|v)>/i,regexSqBrackets=/\[([^\]]*)(?:\]|$)/,regexTags=/(<(b|i|sc)>)(.*?)(?:(<\/\1>)|$)/i,regexTagsSp=/<sp>([^<]*)<\/sp>/gi,spSubstitutions={"'ae":"ǽ","'æ":"ǽ",ae:"æ",oe:"œ","'œ":"œ","'oe":"œ",AE:"Æ",OE:"Œ",Ae:"Æ",Oe:"Œ","V/":"V","R/":"R","A/":"A"};String.prototype.replaceSpTags=function(){return this.replace(regexTagsSp,function(e){var t=e.slice(4,-5);return spSubstitutions[t]||t})};var regexInner=/(?:[!\/ ,;:`]+|[^\)!\/ ,;:`\[]+)|(\[[^\]]*(?:$|\]))/g,rog={syl:3,gabc:5,whitespace:7},linkSelector="",linkDownloadSelector="",setPdfLinkSelector=function(e){linkSelector=e},onDragStart=function(e){console.info(e),e.originalEvent.dataTransfer.setData("DownloadURL",this.getAttribute("data-downloadurl"))},setGabcLinkSelector=function(e){linkDownloadSelector=e,$(e).bind("dragstart",onDragStart)},regexToneModifiers=/(')|(\.{1,2})|(_{1,4}0?)/g,regexTones=new RegExp("([/ ,;:`]+)|((?:[fF]|[cC][bB]?)[1-4])|(?:(-)?(([A-M])|([a-m]))(([Vv]{1,3})|(s{1,3})|((<)|(>)|(~))|(w)|(o)|(O)|((x)|(y))|(q)|((R)|(r0)|(r(?![1-5])))|(r[1-5])|(\\+))?((?:"+String(regexToneModifiers).replace(/^\/|\/\w*$/g,"").replace(/\((?!\?:)/g,"(?:")+")*)|(z0))|\\[([^\\]]*)(?:\\]|$)","g"),regexTonesSpliceIndex=27,regexToneModifiersCount=4,rtg={whitespace:1,clef:2,initioDebilis:3,tone:4,toneUpper:5,toneLower:6,noteType:7,virga:8,stropha:9,liquescentia:10,ascendingLiquescentia:11,descendingLiquescentia:12,diminutiveLiquescentia:13,quilisma:14,oriscus:15,oriscusReverse:16,accidental:17,flat:18,natural:19,q:20,lineaPunctum:22,lineaPunctumCavum:23,punctumCavum:24,rNumber:25,custos:26,ictus:27,dot:28,episema:29,custos:30,bracketed:31},regexVowel=/(?:[cgq]u|[iy])?([aeiouyáéëíóúýǽæœ]+)/i,transforms=[["/"," ",",",";",":","`",""],["'","_","+",";","|",",",""],[/\//g,/ /g,/,/g,/;/g,/:/g,/`/g,/!/g]],abcs={},_defs=null,defText=null,_defText=null,defChant=null,masks=[],selectedPunctum=-1,selectedNeume=-1,selectedPunctumTag=null,selectedNeumeTag=null,_timeoutGabcUpdate=null,_minUpdateInterval=1700,_heightCorrection=0,utf8_bom=String.fromCharCode(239)+String.fromCharCode(187)+String.fromCharCode(191);Header.prototype.toString=function(){var e=[];for(key in this)if("length"!=key&&"original"!=key&&"comments"!=key&&"cValues"!=key&&"string"==typeof this[key]){var t=this[key+"Array"];if(t)for(i in t)e.push(key+": "+t[i]+";");else e.push(key+": "+this[key]+";")}for(key in this.cValues)0!=key.length&&e.push("%"+key+": "+this.cValues[key]+";");for(i in this.comments)try{e.splice(i,0,this.comments[i])}catch(n){}return e.join("\n")+"\n%%\n"};var regexHeaderLine=/^([\w-_]+):\s*([^;\r\n]*)(?:;|$)/i,regexHeaderComment=/^%.*/,gabcProcessTime=0,_nextUpdate=(new Date).getTime(),dontUpdateChant=!1,otherElements=[],_txtWidths={};TagInfo.prototype.span=function(){var e=make("tspan",this.text,fontclass+" "+this.tags.join(" "));return e},TagInfo.prototype.spanV=function(){for(var e=fontclass+" "+this.tags.join(" "),t=make("tspan","",e),n=0;n<this.spans.length;++n){var i=this.spans[n];switch(typeof i){case"object":t.appendChild(make("tspan",i.txt,"versiculum"));break;case"string":t.appendChild(document.createTextNode(i))}}return t};var finishStaff=function(e){var t=e.parentNode,n=parseInt(e.id.match(/\d+$/)[0]),i=e.info,a=i.ltone,r=i.htone;a=3-a,a=0>=a?0:a*spaceheight/2,r-=9,r=0>=r?0:r*spaceheight/2;var s=Math.ceil(.1*staffheight+fontsize+a+r);if(i.vOffset=i.y,i.txtInitial&&i.txtInitial.setAttribute("y",s+i.y),i.txtAnnotation&&i.txtAnnotation.setAttribute("y",i.y+Math.ceil(r)-25),i.eText.setAttribute("y",s),i.eTrans.setAttribute("y",s+fontsize),i.eText.setAttribute("transform","translate("+i.x+","+i.vOffset+")"),i.eTrans.setAttribute("transform","translate("+i.x+","+i.vOffset+")"),t&&(t.appendChild(i.eText),t.appendChild(i.eTrans)),i.eTrans.childNodes.length>0&&(s+=fontsize),r>0){if(i.vOffset+=r,0==n){var o=0;$(e).children("[id^=neume]").each(function(){o=Math.min(o,this.neume.info.mindy)}),_heightCorrection=o+r}e.setAttribute("transform","translate("+i.x+", "+(i.y+r)+")")}return s},trimStaff=function(e,t){var n,i=$(e).find("use[href=#staff]");if(t)n=t;else{var a=$(e).find("[id^=neume]:last"),r=$(e.parentNode).find("[id^=neumetext]:last");if(href=a.attr("href")){if(!/\:$/.exec(href))return}else if(!/\|$/.exec(a.text()))return;var s=/\d+$/.exec(a.prop("id"))[0],o=/\d+$/.exec(r.prop("id"))[0];if(o>s)return;n=parseFloat(a.attr("x"));var l=a.attr("transform"),c=regexTranslate.exec(l);c&&c[1]&&(n+=parseFloat(c[1])),n+=a[0].neume.wChant}var d="scale("+n+",1)";i.attr("transform",function(e,t){return t.replace(/scale\([^\)]*\)/,d)
})},justifyLine=function(e,t,n){var i=0,a=0,r=e.words;if(!n){var s=2*spaceBetweenNeumes;a=svgWidth-e.info.x-s;for(var o,l,c=r.length-1;c>=0&&(!o||!l);)for(var d=r[c--],f=d.length-1;f>=0&&(!o||!l);){var u=d[f--];!o&&u.tagName.match(/^use|text$/i)&&u.neume?o=u:l||!u.tagName.match(/^tspan$/i)||(l=u)}if(o){if(t)i=o.neume.x+(o.neume.transformX||0);else{i=parseFloat($(o).attr("x"));var h=t?o.neume.transform:$(o).attr("transform"),g=regexTranslate.exec(h);g&&g[1]&&(i+=parseFloat(g[1]))}i+=o.neume.wChant}if(l){var m;t&&l.neume?m=l.neume.x:(m=parseFloat($(l).attr("x")),m+=textWidth(l)-s),i=Math.max(i,m)}}if(n||i>0){var p=a-i,v=r.length-1,x=p/v;if(n||p>0)for(;v>=0;)r[v].forEach(function(e){e.neume&&(e.neume.justifyOffset=Math.round(p)),$(e).attr("transform")?(t&&e.neume&&$(e).attr("x",e.neume.x),$(e).attr("transform",function(){return"translate("+Math.round(p+(e.neume&&e.neume.transformX||0))+")"})):$(e).attr("x",function(n,i){return(t?e.neume.x:i?parseFloat(i):0)+Math.round(p)})}),p-=x,--v}},addCustos=function(e,t,n,i){var a=t.info.ftone,r=neume(indices.custos,a),s=e.custos;if(s){if(s.textContent=r,e.custosLedger)try{e.removeChild(e.custosLedger),delete e.custosLedger}catch(o){}}else s=make("text",r),s.setAttribute("class",defChant.getAttribute("class")),s.setAttribute("y",0);(n||"undefined"==typeof n)&&(justifyLine(e,"undefined"!=typeof t.x),n=!0);var l=n?svgWidth-e.info.x-staffheight/15:i;s.setAttribute("x",l),e.appendChild(s),e.custos=t.custos=s;var c=a>10,d=2>a;(c||d)&&(e.custosLedger=t.custosLedger=insertLedger(c,e,s,!0))},boolArray=[!0,!1],ToneInfo=function(e){for(i in e)this[i]=e[i]};!function(){var e,t,n,i,a;getChantFragment=function(s,o){if(void 0!=abcs[s]){var l=abcs[s];return 0==$(o).find("[id='"+s+"']").length&&(o.appendChild($.clone(l.def)),l.mask&&getChantFragment(l.mask,o)),l}var c=void 0;s.indexOf("r")>-1&&(c=s.replace(/r/g,"!"),getChantFragment(c,o)),t=make("text"),a=3,i=0,t.setAttribute("id",s);var d,f,u,h=null,g=0;ledgerA=[],ledgerB=[],n=0,regexInner.lastMatch=0;for(var m=[];d=regexInner.exec(s);)if(!d[1]){e=[];var p=-1;chant=d[0],regexTones.exec("");for(var v;v=regexTones.exec(chant);){++g;var x=[];if(v[regexTonesSpliceIndex])for(var b,T=v[regexTonesSpliceIndex];b=regexToneModifiers.exec(T);){if(b[3]){var y=b[3].match(/0/)?-1:0,C=b[3].length+y-1;b[3]=b[3].slice(y-1);for(var A=1,w=e.length;C>=A&&w>=A;){var S=e[w-A];S.match[rtg.episema]||(S.match[rtg.episema]=b[3],S.episemaLoc=y),++A}}if(b[2]){var C=b[2].length;if(C>1){var S=e[e.length-1];S.match[rtg.dot]||(S.match[rtg.dot]=".")}}$.extend(x,b)}else x=new Array(regexToneModifiersCount);var k=v.index;if(v=v.splice(0,regexTonesSpliceIndex).concat(x.splice(1,x.length-1)).concat(v.splice(1,v.length-1)),v.index=k+d.index,!v[rtg.bracketed])if(v[rtg.clef]&&(f=v[rtg.clef],u="f"==f[0]?5:1,u+=2*parseInt(f.slice(-1))),tone=v[0],v[rtg.whitespace]){for(var A=0;A<transforms[0].length;++A)tone=tone.replace(transforms[2][A],transforms[1][A]);var _=make("tspan",tone);_.setAttribute("offset",v.index),_.setAttribute("len",v[0].length),t.appendChild(_),i=Math.max(i,/[`,]/.exec(v[rtg.whitespace])&&9.5||0),m.push(_=new ToneInfo({match:[]})),_.match[rtg.whitespace]=v[rtg.whitespace]}else{var L=parseInt(v[rtg.tone]||v[rtg.clef]&&v[rtg.clef].slice(0,1),23)-10;v[rtg.tone]&&1==v[rtg.tone].length?(a=Math.min(a,L),i=Math.max(i,L),null!=h||v[rtg.accidental]||(h=L)):i=Math.max(i,v[rtg.clef]&&2*parseInt(v[rtg.clef].slice(-1))+2||0),L>10?ledgerA.push(g-1):2>L&&ledgerB.push(g-1);var _=new ToneInfo({match:v,index:L,relativeTone:0>p?0:L-p,modifiers:v[rtg.noteType],clef:v[rtg.clef],episemaLoc:v[rtg.episema]&&v[rtg.episema].match(/0/)?-1:0,diamond:v[rtg.toneUpper]?!0:!1,markings:v[rtg.ictus]||v[rtg.dot]||v[rtg.episema],liq:v[rtg.diminutiveLiquescentia],accidental:v[rtg.accidental]});e.push(_),m.push(_),p=L}}for(var A=0;A<e.length;++A)A=r(A)}return o.appendChild(t),abcs[s]={ltone:a,htone:i,ftone:h,tones:m,startsWithAccidental:m.length>0&&m[0].match[rtg.accidental]?!0:!1,mask:c,clef:f,clefTone:u,mindy:n,ledgerA:ledgerA,ledgerB:ledgerB,def:t}};var r=function(r){var s=function(e,t,n){n||(n=t),-1==e?(c+=neume(indices.episema_below,t),a=Math.min(a,t-1)):(c+=neume(indices.episema_above,n),i=Math.max(i,n+1))},o=function(e,t){1==e?(c+=neume(indices.ictus_above,t),i=Math.max(i,t+1)):(c+=neume(indices.ictus_below,t),a=Math.min(a,t-1))},l=function(e){if(e&&c&&0!=c.length){var n=make("tspan",c);n.setAttribute("offset",e.match.index),n.setAttribute("len",e.match[0].length);for(var i=1;i<arguments.length;++i)n.setAttribute("len"+i,arguments[i].match[0].length);arguments.length>1&&n.setAttribute("count",arguments.length),t.appendChild(n),c=""}},c="",d=1,f=1,u="",h=e[r],g=e.length>r+1?e[r+1]:null,m=e.length>r+2?e[r+2]:null,p=e.length>r+3?e[r+3]:null,v=r>0?e[r-1]:null,x=indices.punctum;if(r>0&&0==h.relativeTone&&(c+="'"),h.diamond){x=h.liq?indices.diamond_tilde:indices.diamond;var b=Math.abs(h.relativeTone);v&&v.diamond&&2==b&&(c+="'"),g&&!g.diamond&&(u="-")}else{if(h.clef){var T=[n];return t.appendChild(makeClefSpan(h,T)),n=T[0],r}if(h.modifiers){if(h.match[rtg.accidental]){0==r&&(startsWithAccidental=!0);var y=h.match[rtg.flat]?"flat":"natural";return c+=neume(indices[y],h.index)+"-",l(h),r}h.match[rtg.virga]?(x=indices.v,f=h.match[rtg.virga].length,u="'"):h.match[rtg.stropha]?(x=indices.s,f=h.match[rtg.stropha].length,u="'"):indices[h.modifiers[0]]&&(x=indices[h.modifiers[0]],g&&g.relativeTone>0&&g.relativeTone<=5&&"w"==h.modifiers&&(!m||m.relativeTone>=0)&&(c+=neume(x,h.index),h.match[rtg.ictus]&&o(-1,h.index),h.match[rtg.episema]&&s(-1,h.index),l(h),g.relativeTone>1&&(c+=neume(indices.connecting_line,h.index,g.index)),++r,x=indices.topPartPodatus,h=g,h.episemaLoc=1))}else if(g&&!g.diamond&&(!g.modifiers||g.liq))if(g.relativeTone>0&&g.relativeTone<=5){if(m&&!m.diamond&&(!m.modifiers||"~"==m.modifiers)&&m.relativeTone<0&&m.relativeTone>=-4)if(x=indices.punctum,!m.modifiers&&p&&p.relativeTone>=1&&p.relativeTone<=5)--r,h.episemaLoc=0,g.episemaLoc=0;else{c+=neume(x,h.index);var C=g.index,A=Math.min(h.index,m.index);h.match[rtg.episema]&&s(h.episemaLoc,A,C),h.match[rtg.ictus]&&(o(h.episemaLoc,h.index),h.match[rtg.ictus]=void 0),l(h),g.relativeTone>1&&(c+=neume(indices.connecting_line,h.index,g.index)),"~"==m.modifiers?(--r,x=void 0):(c+=neume(x,g.index),g.match[rtg.episema]&&s(h.episemaLoc,A,C),g.match[rtg.ictus]&&(o(g.episemaLoc,g.index),g.match[rtg.ictus]=void 0),l(g),m.relativeTone<-1&&(c+=neume(indices.connecting_line,m.index,g.index)),h=m,m.match[rtg.episema]&&(h.episemaTone=-1==m.episemaLoc?A:C),"~"==m.modifiers&&(x=indices.lower_tilde),d=3,++r)}else if(g.relativeTone<=5){h.episemaLoc=-1,g.episemaLoc=1,x=indices.topPartPodatus,d=2,m&&m.relativeTone<=0&&(u="-"),g.liq?(c+=neume(indices["<"],h.index),x=indices.upper_tilde):c+=neume(indices.bottomPartPodatus,h.index),l(h),g.relativeTone>1&&(c+=neume(indices.connecting_line,h.index,g.index));var w=h;h=g,g=w}++r}else if(g.relativeTone<0&&g.relativeTone>=-5){if(!h.markings&&m&&!m.diamond&&(!m.modifiers||"~"==m.modifiers)&&m.relativeTone>=1&&m.relativeTone<=4&&g.relativeTone>=-4){if(h.relativeTone>=2&&h.relativeTone<=5)c+=neume(indices.connecting_line,h.index-h.relativeTone,h.index);else if(h.relativeTone<1){var S=Math.max(-g.relativeTone,1);c+=(t.childNodes.length>0?"-":"")+neume(indices.decorative_line,h.index-S,h.index)}"~"==m.modifiers?(--r,c+=neume(x,h.index),l(h),c+=neume(indices.connecting_line,g.index,h.index),x=void 0):(c+=neume(indices.porrectus,h.index,g.index),l(h,g),c+=neume(indices.decorative_line,g.index,m.index),g.episemaLoc=-1,!p||p.relativeTone>=0||p.relativeTone<-5?(x=indices.topPartPodatus,m.episeamLoc=1,h=m,d=3,++r):(x=void 0,m.connectingLine=!0,d=2))}else{if(d=2,g.liq){var S=Math.min(-g.relativeTone,2);c+=neume(indices.decorative_line,h.index-S,h.index),c+=neume(indices[">"],h.index),l(h),x=indices.lower_tilde}else h.relativeTone>0&&h.relativeTone<=5&&("w"==v.modifiers||h.connectingLine)?h.relativeTone>1&&(c+=neume(indices.connecting_line,v.index,h.index)):c+=neume(indices.decorative_line,g.index,h.index),c+=neume(indices.punctum,h.index),h.match[rtg.episema]&&(s(h.episemaLoc,g.index,h.index),d=1),h.match[rtg.ictus]&&(o(h.episemaLoc,h.index),h.match[rtg.ictus]=void 0),g.match[rtg.episema]&&(w=-1==g.episemaLoc?A:C,h.episemaTone=1,-1!=g.episemaLoc&&(g.episemaTone=h.index)),h.match[rtg.dot]&&(g.match[rtg.dot]?1==g.match[rtg.dot].length&&(g.match[rtg.dot]=".."):(c+=neume(indices.dot,h.index),d=1)),l(h);g.relativeTone<-1&&(c+=neume(indices.connecting_line,g.index,h.index));var w=h;h=g,g=w}++r}}var w=neume(x,h.index);if(f>1&&(w=(w+"'").repeat(f).slice(0,-1)),c+=w,h.match[rtg.ictus]&&o(h.episemaLoc,h.index),h.match[rtg.episema]){var w=h.episemaTone||h.index;s(h.episemaLoc,w)}d>1&&(g.match[rtg.ictus]&&o(g.episemaLoc,g.index),g.match[rtg.episema]&&!h.episemaTone&&s(g.episemaLoc,g.index));var $,k;d>1&&($=Math.min(g.index,h.index),k=Math.max(g.index,h.index),(k-$>=2||0==$%2)&&($=void 0));var w=h.match[rtg.dot];return w?(c+=h.index==$?neume(indices.dot,$-1):neume(indices.dot,h.index),w=w.length):w=0,g&&(w>1||d>1&&(w=g.match[rtg.dot]))&&(c+=g.index==$?neume(indices.dot,$-1):neume(indices.dot,g.index)),w&&e[r+1]&&(u+="--"),c+=u,x&&l(h),r}}();var gradients={},playTone=function(){console.warn("Audiolet library not loaded.")},playScore=playTone,stopScore=playTone,baseFreq=370;$(function(){var e=function(){try{var e=new Audiolet,t=function(t,n,i){AudioletGroup.apply(this,[e,0,1]),this.sine=new Sine(e,t),this.gain=new Gain(e,.01*i),console.info(i),this.env=new PercussiveEnvelope(e,1,.3,.3*(n||1),function(){this.audiolet.scheduler.addRelative(0,this.remove.bind(this))}.bind(this)),this.envMulAdd=new Multiply(e,.002*i,0),this.sine.connect(this.gain),this.gain.connect(this.outputs[0]),this.env.connect(this.envMulAdd),this.envMulAdd.connect(this.gain,0,1)};extend(t,AudioletGroup);var n=function(n,i,a){var r=new t(n,i,a);r.connect(e.output)},i={0:0,1:2,2:4,3:5,4:7,5:9,6:11};playTone=function(e,t,a,r){var s=baseFreq;for(t=e==t;0>e;)e+=7,s/=2;for(;e>=7;)e-=7,s*=2;e>0&&(s*=Math.pow(2,(i[e]-(t?1:0))/12)),n(s,a,r)};var a=!1;tempo=150,setTempo=function(e){tempo=e||150},setRelativeTempo=function(e){tempo+=e,0>=tempo&&(tempo=150)};var r;playScore=function(t){for(var n=b,i=t?0:selectedPunctum||0;r&&r.next(););r=new PSequence(n.tones,1,i),a=!0,e.scheduler.setTempo(tempo),e.scheduler.play([r],1,function(t){for(var s;!(a=a&&i<n.tones.length)||!(s=t.play(i));)if(++i,!(t=r.next()))return y(-1),a=!1,void 0;y(i,!0),s&&e.scheduler.setTempo(tempo/s),++i})},stopScore=function(){a=!1}}catch(s){console.warn(s)}},t=function(){if("function"==typeof Audiolet)try{e()}catch(t){}else $.getScript("audiolet.js",e)};"function"==typeof Sink?t():$.getScript("sink.js",t),0==$("link[href=style\\.css]").length&&$(document.head).append($('<link rel="stylesheet" type="text/css" href="style.css">'));var n=$("#tbl");if(n)for(var i=57568;65535>i;i+=16){var a=document.createElement("row"),r=document.createElement("td"),s=document.createElement("td");r.innerText="0x"+i.toString(16);for(var o="",l=0;16>l;++l)o+=String.fromCharCode(i+l)+"_";s.innerText=o,s.className="caeciliae",a.appendChild(r),a.appendChild(s),n.append(a)}if("function"==typeof document.createElementNS){_svg=svg=document.createElementNS(svgns,"svg"),svg.setAttribute("style","width:100%;height:0"),setPrintFont=function(e){$(svg).find(".caeciliae,.caeciliae-print").attr("class",e?"caeciliae-print":"caeciliae")},_defs=document.createElementNS(svgns,"defs"),defText=make("text",""),defText.setAttribute("class","goudy"),_defs.appendChild(defText),_defText=make("text",""),_defText.setAttribute("class","goudy"),_defs.appendChild(_defText),defChant=make("text","p"),defChant.setAttribute("class","caeciliae"),_defs.appendChild(defChant),defChantSvg=make("text","p"),defChantSvg.setAttribute("class","caeciliaeSvg"),_defs.appendChild(defChantSvg);var c=make("linearGradient");c.setAttribute("gradientUnits","objectBoundingBox"),c.setAttribute("id","gradRedBlack");var d=make("stop");d.setAttribute("offset","0"),d.setAttribute("stop-color","#e22"),c.appendChild(d),d=make("stop"),d.setAttribute("offset","100"),d.setAttribute("stop-color","#000"),c.appendChild(d),gradients.RedBlack=c,c=make("linearGradient"),c.setAttribute("gradientUnits","objectBoundingBox"),c.setAttribute("id","gradBlackRed");var d=make("stop");d.setAttribute("offset","0"),d.setAttribute("stop-color","#000"),c.appendChild(d),d=make("stop"),d.setAttribute("offset","100"),d.setAttribute("stop-color","#e22"),c.appendChild(d),gradients.BlackRed=c;var f;if(staffInFont)f=document.createElementNS(svgns,"text"),f.textContent="'",f.setAttribute("transform","scale(0.5,1)");else{f=document.createElementNS(svgns,"g");var u=1,h=document.createElementNS(svgns,"path"),g="h1v"+u+"h-1zm0 -"+spaceheight;h.setAttribute("d","M0 0"+g.repeat(4)),f.appendChild(h);var m=document.createElementNS(svgns,"g");h=document.createElementNS(svgns,"path"),h.setAttribute("d","M0 "+spaceheight+g),m.appendChild(h),m.setAttribute("id","ledgerb"),_defs.appendChild(m),m=document.createElementNS(svgns,"g"),h=document.createElementNS(svgns,"path"),h.setAttribute("d","M0 "+4*-spaceheight+g),m.appendChild(h),m.setAttribute("id","ledgera"),_defs.appendChild(m)}f.setAttribute("id","staff"),_defs.appendChild(f),svg.appendChild(_defs),textElem=document.createElementNS(svgns,"g"),textElem.setAttribute("transform","translate(0,"+staffoffset+")"),textElem.setAttribute("class","caeciliae"),svg.appendChild(textElem);var p=$("#chant-preview,[id$=-preview][for]");if(0==p.length)$(document.body).append(svg);else{p.append(svg),lastClefBeforeNeume=function(e,t){var n,i={clefTone:9};for(n in t.clefs){if(!(e>n))break;i=t.clefs[n]}return i},lastClefBeforePunctum=function(e,t){var n,i={clefTone:9};for(n in t.clefs)try{var a=parseInt($(t).find("#neume"+n).children()[0].id.match(/\d+$/)[0]);if(!(e>a))break;i=t.clefs[n].info}catch(r){}return i};var v=function(e,t){var n,i=null;for(n in t.accidentals){if(!(e>=n))break;i=t.accidentals[n]}return i};ToneInfo.prototype.isPlayable=function(){return!this.clef&&!this.accidental&&"number"==typeof this.index},ToneInfo.prototype.play=function(e){var t=b,n=t.timings,i=t.volumes;if(clefIndex=lastClefBeforePunctum(e,t).clefTone,setDuration=n&&n[e],volume=i[e]||100,duration=setDuration||this.match&&(this.match[rtg.dot]||this.match[rtg.episema])?2:(this.match[rtg.virga]||"v").length,longDuration=0,setDuration)duration=setDuration.length,longDuration=duration+(setDuration.restAfter||0),console.info(setDuration);else{if(1==duration){var a=$(t).find("[id=punctum"+(1+e)+"]");a.length&&(a=a[0].tone,a&&a.match[rtg.quilisma]&&(duration=2))}longDuration=duration}return this.clef||this.accidental||"number"!=typeof this.index?!1:(playTone(this.index-clefIndex,v(e,t),duration,volume),longDuration)};var x=function(e){var t=selectedPunctumTag,n=b,i=$("#"+$(n).parent().attr("for"));if(0==i.length&&(i=$("#editor")),t){var a=t.parentNode,r=selectedPunctum-/^punctum(\d+)$/.exec(a.childNodes[0].id)[1],s=a.neume,o=s.info.tones[r];if(o&&o.match){var l,c,d=o.match[rtg.tone];if(d){var f=o.index+e;if(0>f?f=0:f>12&&(f=12),e=f-o.index,0==e)return;l=String.fromCharCode(d.charCodeAt(0)+e)}else{c=o.match[rtg.clef],d=parseInt(c.slice(-1));var l=d+e;if(1>l?l=1:l>4&&(l=4),e=l-d,0==e)return;c=c.slice(0,-1)+l}var u=i.val(),h=getHeaderLen(u);h+=s.index;var g=u.slice(0,h);u=u.slice(h),h=T(!0);var m=h+o.match[0].length,p=u.slice(0,h);p+=u.slice(h,m).replace(d,l),h=s.gabc.length,p+=u.slice(m,h),u=g+p+u.slice(h),s.gabc=p;var v=s.info,x=s.info=getChantFragment(p,$(n).find("defs")[0]);if(c)for(N in n.clefs[selectedNeume].clefs){var y=n.clefs[selectedNeume].clefs[N];y.setAttributeNS(xlinkns,"href","#"+c)}stopScore(),x.tones[r].play(selectedPunctum);var C=$(x.def).clone()[0];C.neume=s,C.setAttribute("id",a.id),C.setAttribute("x",a.getAttribute("x")),C.setAttribute("y",a.getAttribute("y")),C.setAttribute("transform",a.getAttribute("transform")),$(a).replaceWith(C),s.wChant=useWidth(C),processLedger(s,C),relayoutChant(n),0==r&&s.custos&&addCustos(s.custos.parentNode,s);var A=C.parentNode,w=A.info.htone,S=A.info.ltone;v.htone<=s.info.htone?A.info.htone=Math.max(A.info.htone,s.info.htone):(A.info.htone=10,$(A).find("[id^=neume]").each(function(){A.info.htone=Math.max(A.info.htone,this.neume.info.htone)})),v.ltone>=s.info.ltone?A.info.ltone=Math.min(A.info.ltone,s.info.ltone):(A.info.ltone=3,$(A).find("[id^=neume]").each(function(){A.info.ltone=Math.min(A.info.ltone,this.neume.info.ltone)}));var k=$(A.parentNode).children("#system0")[0].info.y;if(c||w!=A.info.htone||S!=A.info.ltone)for(var _=finishStaff(A),L=staffoffset+_+verticalSpace+A.info.y,N=parseInt(A.id.match(/\d+$/)[0])+1;A=$(A).siblings("#system"+N)[0];)A.info.y=L,_=finishStaff(A),L=staffoffset+_+verticalSpace+A.info.y,++N;n.setAttribute("height",$(n).children("g")[0].getBBox().height+k+_heightCorrection-_defText.getExtentOfChar("q").height),r=selectedPunctum-r,selectedPunctumTag=null,r=setUpPunctaIn(C,r,n),selectedNeumeTag=C,i.val(u)}}},b=svg,T=function(e){if(null!=selectedPunctum&&selectedPunctumTag){var t=selectedPunctumTag,n=selectedPunctum-t.id.match(/^punctum(\d+)$/)[1],i=t.parentNode,a=parseInt(t.getAttribute("offset"))||0,r=parseInt(t.getAttribute("len"))||3;return n&&(a+=r,r=parseInt(t.getAttribute("len1"))),e?a:(selectGabc(i.neume.index+a,r,b),void 0)}},y=function(e,t,n){if(n?b=n:n=b,e=parseInt(e),0>e&&(e=-1),e!=selectedPunctum){var i,a=0;if(0>e)t=!0,i=$();else if(i=$(n).find("#punctum"+e),0==i.length&&(a=1,--e,i=$(n).find("#punctum"+e),0==i.length||2!=i.attr("count")))return selectedPunctumTag=null,void 0;selectedPunctum=e+a,selectedPunctumTag=i[0];var r=i.parent().attr("id");if(r&&(r=/neume(\d+)/i.exec(r)),selectedNeume=r?parseInt(r[1]):-1,selectedNeumeTag=selectedPunctumTag&&selectedPunctumTag.parentNode,$(n).find(".selectable").attr({"class":"selectable",style:""}),i.attr("class","selectable selected"+(2==i.attr("count")?"-"+(1+a):"")),2==i.attr("count")&&setGradient(i[0],a),!t){stopScore();var s=selectedPunctum-/^punctum(\d+)$/.exec(selectedNeumeTag.childNodes[0].id)[1];selectedNeumeTag.neume.info.tones[s].play(selectedPunctum)}}},C=function(e){var t=$(b).find("#neume"+e+">tspan");punctumToSelect=/punctum(\d+)/i.exec(t.attr("id")),punctumToSelect&&y(parseInt(punctumToSelect[1]))};$(document).on("click","tspan.selectable[id^=punctum]",function(e){y(/punctum(\d+)/i.exec(this.id)[1],!1,$(e.target).parents("svg")[0])}).on("click","tspan.selectable[id^=neumetext]",function(){var e=parseInt(this.getAttribute("selectIndex"));e>=0&&selectGabc(e,-1,$(this).parents("svg")[0])});var A=function(e){if(27==e.which)return stopScore(),void 0;if(e.target.tagName.match(/textarea|input|select/i))return y(-1),void 0;var t=selectedPunctum;if(e.ctrlKey){var n=selectedNeume;switch(e.which){case 37:--n;break;case 39:++n;break;case 38:return x(2),e.preventDefault(),void 0;case 40:return x(-2),e.preventDefault(),void 0;case 13:return M(),void 0;case 32:return playScore(),void 0;case 107:return setRelativeTempo(1),void 0;case 109:return setRelativeTempo(-1),void 0;default:return}C(n)}else{switch(e.which){case 37:--t;break;case 39:++t;break;case 38:return x(1),e.preventDefault(),void 0;case 40:return x(-1),e.preventDefault(),void 0;case 13:return T(),e.preventDefault(),void 0;case 32:return playScore(!0),e.preventDefault(),void 0;case 107:return setRelativeTempo(10),e.preventDefault(),void 0;case 109:return setRelativeTempo(-10),e.preventDefault(),void 0;default:return console.info(e.which),void 0}y(t)}};$(document).keydown(A)}var w=[],S=0,k=0;window.updateGabc=updateGabc=function(){var e=$(".jgabc:visible");e.each(function(e,t){var n=$(t),i=n.clone().toggleClass("jgabc jgabc-svg").text("");n.hide(),$(svg).clone().appendTo(i),n.after(i);var a=n.attr("src");a&&(G=200,++S,$.get(a,function(e){n.html(e),++k==S&&(G=0,U(),N(0,!0,!0))}))}),w=$(".jgabc"),setTimeout(U,100)};var _=null,L=null,N=function(e,t,n){if(M(),_&&clearTimeout(_),!t){var i=500;return _=setTimeout(function(){N(null,!0)},i),void 0}_=null,$.each(w,function(e,t){var i=$(t).next(".jgabc-svg").find("svg")[0];i&&(t.innerHTML.match(/^\s*$/)||n&&t.hasSvg||(updateChant(t.innerHTML,i,!0),t.hasSvg=!0))})},I=function(e){if(L&&clearTimeout(L),!e){var t=500;return L=setTimeout(function(){I(!0)},t),void 0}L=null;try{relayoutChant(svg)}catch(n){}$.each(w,function(e,t){var n=$(t).next(".jgabc-svg").find("svg")[0];n&&relayoutChant(n)}),$.each(otherElements,function(e,t){var n=$(t),i=n.is("svg")?n[0]:n.find("svg")[0];i&&(relayoutChant(i),n.trigger("relayout"))})};updateAllChantWidth=navigator.userAgent.match(/\bChrome\b/)?function(){I(!0)}:function(){I()};var M=function(){updateChant($("#editor").val(),svg)};forceUpdateChant=function(){updateChant($("#editor").val(),svg,!0)};var O=function(e){return e.stopPropagation(),e.preventDefault(),!1},P=function(e){return e?(e^16*Math.random()>>e/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,P)},E=function(e){e.stopPropagation(),e.preventDefault();var t,n=$(this),i=e.originalEvent.dataTransfer.files.length,a=uuid&&uuid.v4?uuid.v4():P();for(t=0;i>t;++t){var r=e.originalEvent.dataTransfer.files[t],s=new FileReader;s.onload=function(e){var t=processDraggedFile(e.target.result);1==i&&n.val(t).keyup(),"function"==typeof processGabc&&processGabc(t,a,i)},s.readAsText(r)}};$("#editor").keyup(M).bind("dragover",O).bind("drop",E),$(window).resize(updateAllChantWidth);var B=0,F=0,D=0,W=0,G=0,U=function(){if(svg)if(svg.parentNode&&0==svg.parentNode.clientWidth)setTimeout(U,100);else{B=textWidth("abcdefghijklmnopqrstuvwxyz",fontclass,!0);var e=getChantWidth("4q5P"),t=getChantWidth("P");notewidth=getChantWidth("p"),D=getChantWidth("p p p p p p p p p p p p p p p"),e==t?(neume=_neumeLig,indices=_indicesLig,makeClefSpan=_clefSpanLig):(neume=_neumeChar,indices=_indicesChar,makeClefSpan=_clefSpanChar),B!=F&&(_txtWidths={},F=B,forceUpdateChant(),N()),D!=W&&(W=D,forceUpdateChant(),N()),++G<100&&setTimeout(U,300)}};setTimeout(U,100)}});var processDraggedFile=function(e){return e};window.updateChant=updateChant;var neume=_neumeChar,indices=_indicesChar,makeClefSpan=_clefSpanChar,internationalTextBoxKeyDown=function(){var e={222:{"false":{a:"á",e:"é",i:"í",o:"ó",u:"ú",y:"ý",A:"Á",E:"É",I:"Í",O:"Ó",U:"Ú",Y:"Ý","æ":"ǽ","œ":"oé","Æ":"Ǽ","Œ":"Oé"},"true":{a:"ä",e:"ë",i:"ï",o:"ö",u:"ü",y:"ÿ",A:"Ä",E:"Ë",I:"Ï",O:"Ö",U:"Ü","æ":"aë","œ":"oë","Æ":"Aë","Œ":"Oë"}},69:{"false":{a:"æ",o:"œ",A:"Æ",O:"Œ"},"true":{a:"æ",o:"œ",A:"Æ",O:"Œ"}},8:{"false":{"†":"+","æ":"ae","œ":"oe","Æ":"Ae","Œ":"Oe","á":"a","é":"e","í":"i","ó":"o","ú":"u","ý":"y","Á":"A","É":"E","Í":"I","Ó":"O","Ú":"U","Ý":"Y","ä":"a","ë":"e","ï":"i","ö":"o","ü":"u","ÿ":"y","Ä":"A","Ë":"E","Ï":"I","Ö":"O","Ü":"U","Ǽ":"Aé","ǽ":"aé"},"true":{}}};return function(t){if("function"==typeof getHeaderLen&&getHeaderLen(this.value)>0){var n=this.value.lastIndexOf("(",this.selectionStart-1),i=this.value.lastIndexOf(")",this.selectionStart-1);if(n>i)return}if(187==t.which&&t.shiftKey){var a=this.selectionStart,r=1;return this.value=this.value.slice(0,a)+"†"+this.value.slice(this.selectionEnd),this.selectionStart=this.selectionEnd=a+r,t.preventDefault(),void 0}var s=$("#cbEnglish")[0];if(!s||!s.checked){var o=e[t.which];if(o&&this.selectionStart==this.selectionEnd&&this.selectionStart>0){var l=this.value[this.selectionStart-1],c=o[t.shiftKey][l];if(c){var d=this.selectionEnd,r=c.length-1;return this.value=this.value.slice(0,--this.selectionStart)+c+this.value.slice(d),this.selectionStart=this.selectionEnd=d+r,t.preventDefault(),void 0}}}}}();