<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>Psalm Tone Tool</title>
	<script type="text/javascript" src="jquery.min.js"></script>
  <!--<script src="https://github.com/jamespadolsey/jQuery-Plugins/raw/master/cross-domain-ajax/jquery.xdomainajax.js"></script>-->
	
	<script type="text/javascript">var _local = true;</script>
  <script src="jgabc.js" type="text/javascript"></script>
	<script src="psalmtone.js" type="text/javascript"></script>
</head>
<body>
<a href="transcriber.html">GABC Transcription Tool</a>
<br/><br/>
<style>
.latex {
  font-family: Times, "Times New Roman", serif;	
  letter-spacing: 1px;
}

.latex sup {
  text-transform: uppercase;
  letter-spacing: 1px;
  font-size: 0.85em;
  vertical-align: 0.15em;
  margin-left: -0.36em;
  margin-right: -0.15em;
}

.latex sub {
  text-transform: uppercase;
  vertical-align: -0.5ex;
  margin-left: -0.1667em;
  margin-right: -0.125em;
  font-size: 1em;
}
</style>Tone: <select id="selTones"></select><select id="selEnd"></select><input type="checkbox" id="cbSolemn" name="solemn"/>Solemn Tone<br/>
Psalm GABC<br/><textarea id="versegabc" style="height: 25pt; width: 95%;">g hj jr 'k jr jr 'ih j.&#10;j jr h 'j jr ih..</textarea>
<br/>Mediant of <span id="sMedAccent"></span> accent<span id="sMedAccentS">s</span><span id="sMedPrepOuter"> with <span id="sMedPrep"></span> preperatory syllable<span id="sMedPrepS">s</span></span>
<br/>Termination of <span id="sTermAccent"></span> accent<span id="sTermAccentS">s</span><span id="sTermPrepOuter"> with <span id="sTermPrep"></span> preperatory syllable<span id="sTermPrepS">s</span></span><br/>
<br/>Psalm <select id="selPsalm"></select> <input type="checkbox" id="cbTeX" name="TeX"/>Generate <span class="latex">T<sub>E</sub>X</span> instead of HTML for 2nd verse and beyond<br/><textarea id="versetext" style="height: 50pt; width: 95%;"></textarea>
<br/>GABC<br/><textarea id="editor" style="height: 100; width: 95%;"></textarea>
<div height="50%" id="chant-preview" style="width: 95%;padding: 0 6pt 0 6pt">
</div>
<div id="verses" style="width: 95%; padding: 0px 6pt; font-family: 'OFL Sorts Mill Goudy TT';font-size:18px"></div>
<script>
if(location.search.match(/dominican/i))g_tones=d_tones;
var gSyl,syl,_clef;

function updateEditor() {
  var useTeX = $("#cbTeX")[0].checked;
  localStorage.cbTeX = useTeX;

  if(!gSyl) gSyl = $("#versegabc")[0].value;
  if(!syl)  syl = $("#versetext")[0].value;

  var lines = syl.split('\n');
  var gabcs = gSyl.split('\n');
  var gMediant = gabcs[0];
  var gTermination = gabcs.length == 1? "" : gabcs[1];
  var firstLine = splitLine(lines[0]);
  var gabc = "1. " + applyPsalmTone(firstLine[0].trim(),gMediant) + (firstLine.length == 1? "" : " *(:) " + applyPsalmTone(firstLine[1].trim(),gTermination) + " (::)");
  var flex = (firstLine[0].indexOf(sym_flex) >= 0);
  
  var medTones = getGabcTones(gMediant);
  var terTones = getGabcTones(gTermination);
  $("#sMedAccent")[0].innerText = String(medTones.accents);
  $("#sMedAccentS")[0].innerText = (medTones.accents == 1)? "" : "s";
  if(medTones.preparatory == 0) {
    $("#sMedPrepOuter").hide();
  } else {
    $("#sMedPrep")[0].innerText = String(medTones.preparatory);
    $("#sMedPrepS")[0].innerText = (medTones.preparatory == 1)? "" : "s";
    $("#sMedPrepOuter").show();
  }
  if(gTermination) {
	$("#sTermAccent")[0].innerText = String(terTones.accents);
    $("#sTermAccentS")[0].innerText = (terTones.accents == 1)? "" : "s";
    if(terTones.preparatory == 0) {
      $("#sTermPrepOuter").hide();
    } else {
      $("#sTermPrep")[0].innerText = String(terTones.preparatory);
      $("#sTermPrepS")[0].innerText = (terTones.preparatory == 1)? "" : "s";
      $("#sTermPrepOuter").show();
    }
  }
  var r = [];
  if(useTeX) r.push("<code>");
  for(var i=1; i<lines.length; ++i) {
    var line = splitLine(lines[i]);
    if(!flex) {
      var flexI = line[0].indexOf(sym_flex);
      if(flexI >= 0) {
        var syls = getSyllables(line[0].slice(0,flexI));
        var index = syls.length - 1;
        syls[index].punctuation += ' ' + sym_flex;
        syls[index].space = "";
        var sylcount = syls[index].word.length;
        index -= sylcount - 1;
        while((syls.length - index) < 3) {
          --index;
          sylcount = syls[index].word.length;
          index -= sylcount - 1;
        }
        syls.splice(0,index);
        gabc += "<i>Flex :</i>() " + applyPsalmTone(syls,getFlexGabc(medTones),false,false);
        gabc = gabc.slice(0,-1) + new Array(4).join(" " + medTones.toneTenor) + "  ::)";
        flex = true;
      }
    }
    r.push("<p style='margin: 6pt 0px;'>" +
    //"<span style='float:left;width:25pt;text-align:right;'>" + String(i + 1) + ".&nbsp;</span>"
    "&#09;"+ String(i+1) + "."
      + addBoldItalic(line[0], medTones.accents, medTones.preparatory, medTones.afterLastAccent, useTeX? 'tex' : 'html')
      + (line.length == 1? "" : " * " + addBoldItalic(line[1], terTones.accents, terTones.preparatory, terTones.afterLastAccent, useTeX? 'tex' : 'html'))
      + "</p>");
  }
  if(useTeX) r.push("</code>");
  try {
    gabc += "\n\n" + applyPsalmTone(gloria_patri_end_vowels,gTermination,false,false);
  } catch(e) { }
  $("#editor")[0].value = gabc;
  $("#editor").keyup();
  $("#verses")[0].innerHTML = r.join('');
}

function updateGabc() {
  gSyl = $("#versegabc")[0].value;
  updateEditor();
}

function updateText() {
  syl = $("#versetext")[0].value;
  updateEditor();
}

function updateEndings() {
  $("#selEnd").empty();
  var tone = $("#selTones")[0].value;
  localStorage.selTones = tone;
  var endings = getEndings(tone);
  var t = g_tones[tone];
  _clef = t.clef;
  var vgabc = $("#cbSolemn")[0].checked? t.solemn : t.mediant;
  if(vgabc == undefined) vgabc = t.mediant;
  vgabc += "\n";
  if(endings.length == 0) {
    vgabc += t.termination;
  } else {
	$("#selEnd").append('<option>' + endings.join('</option><option>') + '</option>');
	vgabc += t.terminations[$("#selEnd")[0].value];
  }
  $("#selEnd")[0].disabled = (endings.length <= 1);
  $("#versegabc")[0].value = vgabc;
  gSyl = vgabc;
  updateEditor();
}

function updateEnding() {
  var tone = $("#selTones")[0].value;
  var selEnd = $("#selEnd")[0].value;
  var solemn = $("#cbSolemn")[0].checked;
  localStorage.selEnd = selEnd;
  localStorage.cbSolemn = solemn;
  var t = g_tones[tone];
  var vgabc = solemn? t.solemn : t.mediant;
  if(vgabc == undefined) vgabc = t.mediant;
  if(t.terminations) {
    vgabc += "\n" + t.terminations[selEnd];
  } else {
    vgabc += "\n" + t.termination;
  }
  $("#versegabc")[0].value = vgabc;
  gSyl = vgabc;
  updateEditor();
}

function getPsalms() {
  var r = Array(151);
  for(var i=1; i <= 150; ++i) {
    r[i-1] = i;
  }
  r[150] = "Magnificat";
  return r;
}

function updatePsalm() {
  var psalmNum = $("#selPsalm")[0].value;
  localStorage.selPsalm = psalmNum;
  getPsalm(psalmNum,function(text) {
    $("#versetext")[0].value = text;
    updateText();
  });
}

$(function() {
//g_tones = d_tones;
  $("#selTones").append('<option>' + getPsalmTones().join('</option><option>') + '</option>');
  $("#selPsalm").append('<option>' + getPsalms().join('</option><option>') + '</option>');
  $("#versegabc").keyup(updateGabc);
  $("#versetext").keyup(updateText);
  $("#selTones").change(updateEndings);
  $("#selTones").keyup(updateEndings);
  $("#cbSolemn").change(updateEnding);
  $("#cbTeX").change(updateText);
  $("#selEnd").change(updateEnding);
  $("#selEnd").keyup(updateEnding);
  $("#selPsalm").change(updatePsalm);
  if(_local) $("#selPsalm").keyup(updatePsalm);
  $("#cbSolemn")[0].checked = (localStorage.cbSolemn == "true");
  $("#cbTeX")[0].checked = (localStorage.cbTeX == "true");
  $("#selPsalm")[0].value = localStorage.selPsalm || "Magnificat";
  $("#selTones")[0].value = localStorage.selTones || "1";
  updateEndings();
  if(("#selEnd")[0].firstChild) $("#selEnd")[0].value = localStorage.selEnd || $("#selEnd")[0].firstChild.innerText;
  updateEnding();
  updatePsalm();
  updateEditor();
});
</script>
</body>
</html>