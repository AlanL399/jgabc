<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>testProject</title>
	<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/themes/ui-lightness/jquery-ui.css"
		type="text/css" media="all" />

	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>

	<!--<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/jquery-ui.min.js"></script>-->

	<script src="jgabc.js" type="text/javascript"></script>
	<script src="psalmtone.js" type="text/javascript"></script>
</head>
<body>
Tone: <select id="selTones"></select><select id="selEnd"></select><br/>
Verse GABC<br/><textarea id="versegabc" style="height: 25pt; width: 95%;">g hj jr 'k jr jr 'ih j.&#10;j jr h 'j jr ih..</textarea>
<br/>Mediant of <span id="sMedAccent"></span> accent<span id="sMedAccentS">s</span><span id="sMedPrepOuter"> with <span id="sMedPrep"></span> preperatory syllable<span id="sMedPrepS">s</span></span>
<br/>Termination of <span id="sTermAccent"></span> accent<span id="sTermAccentS">s</span><span id="sTermPrepOuter"> with <span id="sTermPrep"></span> preperatory syllable<span id="sTermPrepS">s</span></span><br/>
Verse Text<br/><textarea id="versetext" style="height: 50pt; width: 95%;">Confitébor tibi, Dómine, in toto corde meo: * in consílio justórum, et congregatióne.
Magna ópera Dómini: * exquisíta in omnes voluntátes ejus.
Conféssio et magnificéntia opus ejus: * et justítia ejus manet in sæculum sæculi.
Memóriam fecit mirabílium suórum, miséricors et miserátor Dóminus: * escam dedit timéntibus se.
Memor erit in sæculum testaménti sui: * virtútem óperum suórum annuntiábit pópulo suo:
Ut det illis hereditátem géntium: * ópera mánuum ejus véritas, et judícium.
Fidélia ómnia mandáta ejus: confirmáta in saéculum saéculi, * facta in veritáte et æquitáte.
Redemptiónem misit pópulo suo: * mandávit in ætérnum testaméntum suum.
Sanctum, et terríbile nomen ejus: * inítium sapiéntiæ timor Dómini.
Intelléctus bonus ómnibus faciéntibus eum: * laudátio ejus manet in sæculum sæculi.
Glória Patri, et Fílio, * et Spirítui Sancto.
Sicut erat in princípio, et nunc, et semper, * et in sæcula sæculórum. Amen.</textarea>
<br/>
GABC<br/><textarea id="editor" style="height: 100; width: 95%;"></textarea>
<div height="50%" id="chant-preview" style="width: 95%;padding: 0 6pt 0 6pt">
</div>
<div id="verses" style="width: 95%; padding: 0px 6pt; font-family: 'OFL Sorts Mill Goudy TT';font-size:18px"></div>
<script>
var gSyl;
var syl;

function updateEditor() {
  if(!gSyl) gSyl = $("#versegabc")[0].value;
  if(!syl)  syl = $("#versetext")[0].value;

  var lines = syl.split('\n');
  var gabcs = gSyl.split('\n');
  var gMediant = gabcs[0];
  var gTermination = gabcs.length == 1? "" : gabcs[1];
  var firstLine = lines[0].split(' * ');
  var gabc = "1. " + applyPsalmTone(firstLine[0].trim(),gMediant) + (firstLine.length == 1? "" : " (:) * " + applyPsalmTone(firstLine[1].trim(),gTermination) + " (::)");
  $("#editor")[0].value = gabc;
  $("#editor").keyup();
  
  var medTones = getGabcTones(gMediant);
  var terTones = getGabcTones(gTermination);
  $("#sMedAccent")[0].innerText = String(medTones.accents);
  $("#sMedAccentS")[0].innerText = (medTones.accents == 1)? "" : "s";
  if(medTones.preparatory == 0) {
    $("#sMedPrepOuter").hide();
  } else {
    $("#sMedPrep")[0].innerText = String(medTones.preparatory);
    $("#sMedPrepS")[0].innerText = (medTones.preparatory == 1)? "" : "s";
    $("#sMedPrepOuter").show();
  }
  if(gTermination) {
	$("#sTermAccent")[0].innerText = String(terTones.accents);
    $("#sTermAccentS")[0].innerText = (terTones.accents == 1)? "" : "s";
    if(terTones.preparatory == 0) {
      $("#sTermPrepOuter").hide();
    } else {
      $("#sTermPrep")[0].innerText = String(terTones.preparatory);
      $("#sTermPrepS")[0].innerText = (terTones.preparatory == 1)? "" : "s";
      $("#sTermPrepOuter").show();
    }
  }
  var r = [];
  for(var i=1; i<lines.length; ++i) {
    var line = lines[i].split(' * ');
	r.push("<p style='margin: 6pt 0px;'><span style='float:left;width:25pt;text-align:right;'>" + String(i + 1) + ".&nbsp;</span>"
		+ addBoldItalic(line[0], medTones.accents, medTones.preparatory, medTones.afterLastAccent, 'html')
		+ (line.length == 1? "" : " * " + addBoldItalic(line[1], terTones.accents, terTones.preparatory, terTones.afterLastAccent, 'html'))
		+ "</p>");
  }
  $("#verses")[0].innerHTML = r.join('');
}

function updateGabc() {
  gSyl = $("#versegabc")[0].value;
  updateEditor();
}

function updateText() {
  syl = $("#versetext")[0].value;
  updateEditor();
}

function updateEndings() {
  $("#selEnd").empty();
  var tone = $("#selTones")[0].value;
  var endings = getEndings(tone);
  var t = g_tones[tone];
  var vgabc = t.mediant + "\n";
  if(endings.length == 0) {
    vgabc += t.termination;
  } else {
	$("#selEnd").append('<option>' + endings.join('</option><option>') + '</option>');
	vgabc += t.terminations[$("#selEnd")[0].value];
  }
  $("#versegabc")[0].value = vgabc;
  gSyl = vgabc;
  updateEditor();
}

function updateEnding() {
  var tone = $("#selTones")[0].value;
  var t = g_tones[tone];
  var vgabc = t.mediant + "\n" + t.terminations[$("#selEnd")[0].value];
  $("#versegabc")[0].value = vgabc;
  gSyl = vgabc;
  updateEditor();
}

$(function() {
  $("#selTones").append('<option>' + getPsalmTones().join('</option><option>') + '</option>');
  $("#versegabc").keyup(updateGabc);
  $("#versetext").keyup(updateText);
  $("#selTones").change(updateEndings);
  $("#selEnd").change(updateEnding);
  updateEndings();
  updateEditor();
});
</script>
</body>
</html>








