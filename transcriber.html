<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html manifest="cache.manifest">
<head><title>GABC Transcription Tool</title>
<script src="jquery.min.js" type="text/javascript"></script>
<script src="jgabc.js"></script>
<script src="psalmtone.js"></script>
<link rel="stylesheet" type="text/css" href="print.css" media="print" />
</head>
<body>
<style>
textarea{
  padding:0px;
}
.tap{
  padding-right:2px;
}
td{
  padding:0px;
}
</style>
<div class="print-hide">
<a href="psalmtone.htm">Psalm Tone Tool</a>
<div style="float:right"><a href="#" target="_blank" id="lnkGabc">Generate PDF</a></div>
<br/><br/>
<table width="100%">
<tr><td width="50%">
GABC<br><div class="tap"><textarea id="hymngabc" spellcheck="false" style="height: 50pt; width: 100%;">c4 c e g g gh g. , f e d c c. ;&#10;c e g g gh g. , f e d c c. :&#10;g g hi j ji g. , h g f e d. ;&#10;e g f e dc d. , e c d c c. ::</textarea></div>
<br>Text<br><div class="tap"><textarea id="hymntext" lang="la" style="height: 50pt; width: 100%;">1. Adoro te d(e)vote, latens Deitas,&#10;Quæ sub his figuris vere latitas;&#10;Tibi se cor meum totum subjicit,&#10;Quia te contemplans totum deficit.&#10; &#10;2. Visus, tactus, gustus in te fallitur,&#10;Sed auditu solo tuto creditur.&#10;Credo quidquid dixit Dei Filius;&#10;Nil hoc verbo veritátis verius.&#10; &#10;3. In cruce latebat sola Deitas,&#10;At hic latet simul et Humanitas,&#10;Ambo tamen credens atque confitens,&#10;Peto quod petivit latro pœnitens.&#10; &#10;4. Plagas, sicut Thomas, non intueor:&#10;Deum tamen meum te confiteor.&#10;Fac me tibi semper magis credere,&#10;In te spem habere, te diligere.&#10; &#10;5. O memoriale mortis Domini!&#10;Panis vivus, vitam præstans homini!&#10;Præsta meæ menti de te vívere,&#10;Et te illi semper dulce sapere.&#10; &#10;6. Pie Pelicane, Jesu Domine,&#10;Me immundum munda tuo sanguine:&#10;Cujus una stilla salvum facere&#10;Totum mundum quit ab omni scelere.&#10; &#10;7. Jesu, quem velatum nunc aspicio,&#10;Oro, fiat illud quod tam sitio:&#10;Ut te revelata cernens facie,&#10;Visu sim beátus tuæ gloriæ.</textarea></div>
</td><td width="50%"><label for="editor" title="You can put GABC headers in this text box if you want them included in the GABC file download link below.  Any headers you type in will persist in local storage between sessions.">Integrated GABC</label><br><div class="tap"><textarea id="editor" spellcheck="false" style="height: 130pt; width: 100%;"></textarea></div></td></tr>
</table>
<a href="#" id="lnkDownloadGabc" target="_blank">Download Integrated GABC</a>
</div>
<div id="chant-preview" style="width: 100%">
</div>
<script>
var regexGabc = /(((?:[`,;:]|([cf][1-4]))+)|(\S+))(?:\s+|$)/g;
String.prototype.repeat = function(num){return new Array(num+1).join(this);}
function applyGabc() {
  var result = [];
  if(localStorage.transcribeHeader)result.push(localStorage.transcribeHeader);
  var match;
  var iG = 0;
  var iT = 0;
  var newLines = 0;
  var elisionOn=0;
  var elisionGabc;
  var cSyl, cGabc;
  for(i in syl) {
    if(newLines > 0) {
      result.push("\n".repeat(newLines));
      newLines = 0;
    }
    cSyl = syl[i];
    if(!elisionOn) cGabc = gSyl[iG++];
    if(cGabc.isClef){
      if(iG==1||i>0){
        result.push(cGabc.gabc);
        cGabc = gSyl[iG++];
      }
    }
    result.push(cSyl.syl);
    if(cSyl.punctuation.length > 0) result.push(cSyl.punctuation);
    if(cSyl.syl) {
      if(cSyl.elision) {
        if(!cGabc.tones || cGabc.tones.length<=1) {
          result.push(cGabc.gabc);
          elisionOn=true;
        } else {
          if(!elisionGabc)elisionGabc=cGabc;
          result.push('('+elisionGabc.tones[elisionOn]+')');
          ++elisionOn;
          if(elisionOn >= elisionGabc.tones.length) elisionOn = elisionGabc.tones.length-1;
          var temp=elisionGabc.tones.slice(elisionOn);
          cGabc={tones:elisionGabc.tones,gabc:'('+temp.join('')+')'};
        }
      } else {
        result.push(cGabc.gabc);
        elisionGabc=null;
        elisionOn=0;
      }
    } else {
      iG--;
    }
    if(iG >= gSyl.length)
      iG = 0;
    if(!elisionOn) {
      cGabc = gSyl[iG];
      while(!cGabc.hasSyllable) {
        if(!cGabc.isClef||(iG!=0 && i!=(syl.length-1)))
        result.push(" " + cGabc.gabc);
        //newLines = 1;
        ++iG;
        if(iG >= gSyl.length) {
          iG = 0;
          //++newLines;
        }
        cGabc = gSyl[iG];
      }
    }
  }
  return result.join('');
}

var gSyl;
var syl;

function updateEditor() {
  if(!gSyl) gSyl = splitGabc($("#hymngabc").val());
  if(!syl)  syl = splitText($("#hymntext").val());

  $("#editor").val(applyGabc())
  .unbind("keyup",updateBoth)
  .keyup()
  .keyup(updateBoth);
  updateLocalHeader();
}

function splitGabc(gabc) {
  var gSyl = [];
  regexGabc.exec('');
  while((match = regexGabc.exec(gabc))) {
    var tone,tones=[];
    regexTones.exec('');
    while((tone=regexTones.exec(match[1]))){
      tones.push(tone[0]);
    }
    gSyl.push({match: match,
               hasSyllable: match[4],
               gabc: '(' + match[1] + ')',
               isClef: match[3],
               tones: tones
              });
  }
  return gSyl;
}

function splitText(text) {
  var syl = [];
  var index = 0,lastIndex = 0;
  while((match = regexLatin.exec(text))) {
    index = match.index;
    if(index>lastIndex) {
      var lastSyl = text.slice(lastIndex,index);
      if(match[0].match(/^i$/i) && lastSyl.match(/<\/?$/) && text.substr(index+1,1).match(/^>/)) {
        ++index;
        syl.push(syllable(lastSyl+"i>",lastIndex));
        lastIndex = index+1;
        continue;
      }
      syl.push(syllable(lastSyl,lastIndex));
    }
    syl.push(syllable(match));
    lastIndex = index + match[0].length;
  }
  return syl;
}

function updateGabc() {
  gSyl = splitGabc($("#hymngabc").val());
  updateEditor();
}

function updateText() {
  syl = splitText($("#hymntext").val());
  updateEditor();
}

function decompile(mixed) {
  regexOuter.exec('');
  var text=[];
  var gabc=[];
  var match;
  var ws;
  var tws='';
  while(match=regexOuter.exec(mixed)) {
    ws=match[rog.whitespace]||'';
    var m=undefined;
    var syl=match[rog.syl];
    if(tws==' '&&!syl) {
      regexGabc.exec('');
      m=regexGabc.exec(match[rog.gabc]);
      if(!m||m[3])text.push(tws);
    } else {
      text.push(tws);
    }
    if(syl)text.push(syl);
    gabc.push(match[rog.gabc] + (ws.replace(/[^\n]*\n[^\n]*/g,'\n')||" "));
    tws=ws;
  }
  if(tws)text.push(tws);
  regexGabc.exec('');
  var gs =gabc.join('');
  gSyl = splitGabc(gs);
  var s = text.join('');
  syl = splitText(s);
  $("#hymngabc").val(gs);
  $("#hymntext").val(s);
}

function updateBoth() {
  var text=$("#editor").val();
  var header=getHeader(text);
  if(header){
    text = text.slice(header.length);
  }
  decompile(text);
  updateLocalHeader();
}

function updateLocalHeader() {
  var gabc = $("#editor").val();
  var header=getHeader(gabc);
  localStorage.transcribeHeader=header;
}

$(function() {
  $("#hymngabc").keyup(updateGabc);
  $("#hymntext").keyup(updateText);
  $("#editor").keyup(updateBoth);
  setPdfLinkSelector("#lnkGabc");
  setGabcLinkSelector("#lnkDownloadGabc");
  updateEditor();
});
</script>
</body>
</html>
