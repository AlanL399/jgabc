<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html manifest="cache.manifest">
<head><title>GABC Transcription Tool</title>
<script src="jquery.min.js" type="text/javascript"></script>
<script src="jgabc.js"></script>
<script src="psalmtone.js"></script>
<link rel="stylesheet" type="text/css" href="print.css" media="print" />
</head>
<body>
<style>
textarea{
  padding:0px;
}
.tap{
  padding-right:2px;
}
td{
  padding:0px;
}
</style>
<div class="print-hide">
<a href="psalmtone.htm">Psalm Tone Tool</a>
<div style="float:right"><a href="#" target="_blank" id="lnkGabc">Generate PDF</a></div>
<br/><br/>
<table width="100%">
<tr><td width="50%">
GABC<br><div class="tap"><textarea id="hymngabc" style="height: 50pt; width: 100%;">e fh h hg fe h i gvFE. ,&#10;hi jh i hvGF' g g' f e. ;&#10;e fh h hg fe h i gvFE. ,&#10;hi jh i hf g fg f e. ::</textarea></div>
<br>Text<br><div class="tap"><textarea id="hymntext" style="height: 50pt; width: 100%;">1. Lucis Creátor óptime,&#10;Lúcem diérum próferens,&#10;Primórdiis lúcis nóvae&#10;Múndi párans oríginem:&#10;&#10;2. Qui máne júnctum vésperi&#10;diem vocári praécipis:&#10;Illábitur tétrum cháos,&#10;Audi préces cum flétibus.</textarea></div>
</td><td width="50%"><label for="editor" title="You can put GABC headers in this text box if you want them included in the GABC file download link below.  Any headers you type in will persist in local storage between sessions.">Integrated GABC</label><br><div class="tap"><textarea id="editor" style="height: 130pt; width: 100%;"></textarea></div></td></tr>
</table>
<a href="#" id="lnkDownloadGabc" target="_blank">Download Integrated GABC</a>
</div>
<div id="chant-preview" style="width: 100%">
</div>
<script>
var regexGabc = /(([`,;:]+)|(\S+))(?:\s+|$)/g;
String.prototype.repeat = function(num){return new Array(num+1).join(this);}
function applyGabc() {
  var result = [];
  if(localStorage.transcribeHeader)result.push(localStorage.transcribeHeader);
  var match;
  var iG = 0;
  var iT = 0;
  var newLines = 0;
  for(i in syl) {
    if(newLines > 0) {
      result.push("\n".repeat(newLines));
      newLines = 0;
    }
    var cSyl = syl[i];
    var cGabc = gSyl[iG++];
    result.push(cSyl.syl);
    if(cSyl.punctuation.length > 0) result.push(cSyl.punctuation);
    if(cSyl.syl) {
      result.push(cGabc.gabc);
    } else {
      iG--;
    }
    if(iG >= gSyl.length)
      iG = 0;
    cGabc = gSyl[iG];
    while(!cGabc.hasSyllable) {
      result.push(" " + cGabc.gabc);
      //newLines = 1;
      ++iG;
      if(iG >= gSyl.length) {
        iG = 0;
        //++newLines;
      }
      cGabc = gSyl[iG];
    }
  }
  return result.join('');
}

var gSyl;
var syl;

function updateEditor() {
  if(!gSyl) gSyl = splitGabc($("#hymngabc").val());
  if(!syl)  syl = splitText($("#hymntext").val());

  $("#editor").val(applyGabc())
  .unbind("keyup",updateBoth)
  .keyup()
  .keyup(updateBoth);
  updateLocalHeader();
}

function splitGabc(gabc) {
  var gSyl = [];
  while((match = regexGabc.exec(gabc))) {
    gSyl.push({match: match,
               hasSyllable: match[3],
               gabc: '(' + match[1] + ')'
              });
  }
  return gSyl;
}

function splitText(text) {
  var syl = [];
  var index = 0,lastIndex = 0;
  while((match = regexLatin.exec(text))) {
    index = match.index;
    if(index>lastIndex) {
      var lastSyl = text.slice(lastIndex,index);
      if(match[0].match(/^i$/i) && lastSyl.match(/<\/?$/) && text.substr(index+1,1).match(/^>/)) {
        ++index;
        syl.push(syllable(lastSyl+"i>",lastIndex));
        lastIndex = index+1;
        continue;
      }
      syl.push(syllable(lastSyl,lastIndex));
    }
    syl.push(syllable(match));
    lastIndex = index + match[0].length;
  }
  return syl;
}

function updateGabc() {
  gSyl = splitGabc($("#hymngabc").val());
  updateEditor();
}

function updateText() {
  syl = splitText($("#hymntext").val());
  updateEditor();
}

function decompile(mixed) {
  regexOuter.exec('');
  var text=[];
  var gabc=[];
  var match;
  while(match=regexOuter.exec(mixed)) {
    ws= match[rog.whitespace]||'';
    text.push((match[rog.syl]||'') + ws);
    gabc.push(match[rog.gabc] + (ws.replace(/[^\n]*\n[^\n]*/g,'\n')||" "));
  }
  var gs =gabc.join('');
  gSyl = splitGabc(gs);
  var s = text.join('');
  syl = splitText(s);
  $("#hymngabc").val(gs);
  $("#hymntext").val(s);
}

function updateBoth() {
  decompile($("#editor").val());
  updateLocalHeader();
}

function updateLocalHeader() {
  var gabc = $("#editor").val();
  var header=getHeader(gabc);
  localStorage.transcribeHeader=header;
}

$(function() {
  $("#hymngabc").keyup(updateGabc);
  $("#hymntext").keyup(updateText);
  $("#editor").keyup(updateBoth);
  setPdfLinkSelector("#lnkGabc");
  setGabcLinkSelector("#lnkDownloadGabc");
  updateEditor();
});
</script>
</body>
</html>
